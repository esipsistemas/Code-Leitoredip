<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Controle de Estacionamento Offline</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body {
    background: #0A1A2A;
    font-family: Arial, Helvetica, sans-serif;
    margin: 0;
    padding: 15px;
    color: #fff;
}

h2, h3 {
    text-align: center;
}

button {
    width: 100%;
    padding: 14px;
    margin-top: 10px;
    background: #0D47A1;
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 18px;
    cursor: pointer;
}

input, select {
    width: 100%;
    padding: 12px;
    margin-top: 10px;
    border-radius: 6px;
    border: none;
    font-size: 16px;
}

.box {
    background: #10263D;
    padding: 15px;
    border-radius: 10px;
    margin-top: 20px;
    box-shadow: 0 0 8px #0005;
}

.flash-btn {
    background: #ffb300;
    color: #000;
}
.operator {
    padding: 12px;
    margin-top: 10px;
    background: #083860;
    border-radius: 6px;
}
.small {
    font-size: 13px;
    opacity: 0.9;
}
</style>
</head>

<body>

<h2>üöó Controle de Estacionamento (Offline)</h2>

<!-- LOGIN DE OPERADOR -->
<div id="loginBox" class="box">
    <h3>Entrar como Operador</h3>
    <select id="operadorSelect"></select>
    <input id="operadorSenha" type="password" placeholder="Senha do operador">
    <button onclick="login()">Entrar</button>
    <hr>
    <button onclick="modoAdmin()">Entrar como ADMIN</button>
    <p class="small">Se for a primeira vez, crie um operador no menu Admin (ap√≥s logar como ADMIN).</p>
</div>

<!-- HOME -->
<div id="home" class="box" style="display:none;">
    <h3 id="welcome"></h3>
    <button onclick="startCamera()">üì∑ Iniciar Leitor Inteligente</button>
    <button onclick="showStatus()">üìä Status das Vagas</button>
    <button onclick="showExport()">üì§ Exportar Dados</button>
    <button onclick="showAdmin()" id="adminBtn" style="display:none;">‚öôÔ∏è √Årea Administrativa</button>
    <button onclick="stopCamera()" id="stopBtn" style="display:none;margin-top:6px;background:#b71c1c;">‚õî Parar Leitor</button>
</div>

<!-- LEITOR -->
<div id="readerContainer" style="display:none;">
    <button class="flash-btn" onclick="toggleFlash()">üî¶ Ligar / Desligar Lanterna</button>
    <div id="reader" style="margin-top:10px;"></div>
</div>

<!-- STATUS -->
<div id="statusBox" class="box" style="display:none;">
    <h3>Status das Vagas</h3>
    <p><b>Limite:</b> <span id="limiteVagas"></span></p>
    <p><b>Dentro:</b> <span id="totalDentro"></span></p>
    <p><b>Dispon√≠veis:</b> <span id="disponiveis"></span></p>
    <div id="lista"></div>
</div>

<!-- EXPORTAR -->
<div id="exportBox" class="box" style="display:none;">
    <h3>Exportar Registros</h3>
    <button onclick="exportarCSV()">üì§ Baixar CSV</button>
</div>

<!-- ADMIN -->
<div id="adminBox" class="box" style="display:none;">
    <h3>Administra√ß√£o</h3>
    <input id="limiteInput" type="number" placeholder="Limite de vagas">
    <button onclick="salvarLimite()">Salvar limite</button>

    <h4>Operadores</h4>
    <input id="newOpName" placeholder="Nome do operador">
    <input id="newOpPass" placeholder="Senha do operador">
    <button onclick="addOperador()">Adicionar operador</button>
    <div id="operadoresLista"></div>

    <h4>Limpar Dados</h4>
    <input id="senhaMaster" type="password" placeholder="Senha master">
    <button onclick="limparDados()">Apagar tudo</button>
    <p class="small">A senha master √© protegida por hash. Se for a primeira vez, a senha padr√£o √© <b>admin123</b> (recomende trocar).</p>
</div>

<script>
// ------------------------------
//  BANCO LOCAL (offline)
// ------------------------------
let estacionamento = JSON.parse(localStorage.getItem("estacionamento")) || [];
let operadores = JSON.parse(localStorage.getItem("operadores")) || [];
let limite = Number(localStorage.getItem("limite") ?? 100);
let FLASH = false;
let qrReader = null;
let currentUser = null;

// prevenir double-scan r√°pido por id: mapa id -> timestamp
const recentScans = new Map();

// Audios
const audioEntrada = new Audio("https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg");
const audioSaida   = new Audio("https://actions.google.com/sounds/v1/cartoon/pop.ogg");

// ------------------------------
// UTILIT√ÅRIOS
// ------------------------------
function save() {
    localStorage.setItem("estacionamento", JSON.stringify(estacionamento));
    localStorage.setItem("operadores", JSON.stringify(operadores));
    localStorage.setItem("limite", String(limite));
}

function formatISO(isoString) {
    if (!isoString) return "";
    try {
        let d = new Date(isoString);
        return d.toLocaleString();
    } catch (e) {
        return isoString;
    }
}

// hash SHA-256 (retorna hex)
async function sha256Hex(text) {
    const enc = new TextEncoder();
    const data = enc.encode(text);
    const hash = await crypto.subtle.digest('SHA-256', data);
    const hashArray = Array.from(new Uint8Array(hash));
    return hashArray.map(b => b.toString(16).padStart(2,'0')).join('');
}

// ------------------------------
// MASTER PASSWORD (hash) - inicializa se n√£o existir
// ------------------------------
(async function ensureMasterHash(){
    if (!localStorage.getItem('masterHash')) {
        // inicializa com hash de "admin123" (mas armazena somente o hash)
        const defaultHash = await sha256Hex("admin123");
        localStorage.setItem('masterHash', defaultHash);
    }
})();

// ------------------------------
// OPERADORES / LOGIN
// ------------------------------
function loadOperadores() {
    const sel = document.getElementById("operadorSelect");
    sel.innerHTML = "";
    operadores.forEach(op => {
        const opt = document.createElement("option");
        opt.value = op.nome;
        opt.textContent = op.nome;
        sel.appendChild(opt);
    });
}
loadOperadores();

function login() {
    const nome = document.getElementById("operadorSelect").value;
    const senha = document.getElementById("operadorSenha").value;

    if (!nome) return alert("Nenhum operador dispon√≠vel. Entre como ADMIN e crie um operador.");
    const op = operadores.find(o => o.nome === nome && o.senha === senha);
    if (!op) return alert("Senha inv√°lida!");

    currentUser = nome;
    document.getElementById("loginBox").style.display = "none";
    document.getElementById("home").style.display = "block";
    document.getElementById("welcome").innerText = "Operador: " + nome;
}

async function modoAdmin() {
    const senha = prompt("Digite a senha master:");
    if (senha === null) return;
    const hash = await sha256Hex(senha);
    const stored = localStorage.getItem('masterHash');
    if (hash !== stored) return alert("Senha incorreta!");

    currentUser = "ADMIN";
    document.getElementById("loginBox").style.display = "none";
    document.getElementById("home").style.display = "block";
    document.getElementById("welcome").innerText = "Administrador";
    document.getElementById("adminBtn").style.display = "block";
}

// ------------------------------
// C√ÇMERA + QR + INTELIGENTE
// ------------------------------
async function startCamera() {
    document.getElementById("readerContainer").style.display = "block";
    document.getElementById("stopBtn").style.display = "inline-block";

    // se j√° existir leitor ativo, reinicia
    if (qrReader) {
        try { await stopCamera(); } catch(e) { /* ignore */ }
    }

    qrReader = new Html5Qrcode("reader");
    try {
        const cams = await Html5Qrcode.getCameras();
        if (!cams || cams.length === 0) throw new Error("Nenhuma c√¢mera encontrada.");
        let camId = cams[0].id;

        await qrReader.start(
            camId,
            { fps: 10, qrbox: { width: 250, height: 250 } },
            onScanSuccess,
            onScanFailure
        );
    } catch (e) {
        alert("Erro ao iniciar c√¢mera: " + e.message);
        console.error(e);
    }
}

function onScanFailure(error) {
    // erros de leitura cont√≠nuos ‚Äî ignorar (opcionalmente logar)
    // console.log("scan fail:", error);
}

async function stopCamera() {
    if (!qrReader) return;
    try {
        await qrReader.stop();
    } catch (e) {
        console.warn("Erro ao parar leitor:", e);
    }
    // tamb√©m tenta parar o stream (se houver)
    try {
        if (qrReader._localStream) {
            qrReader._localStream.getTracks().forEach(t => t.stop());
        }
    } catch(e){/* ignore */}
    qrReader = null;
    document.getElementById("readerContainer").style.display = "none";
    document.getElementById("stopBtn").style.display = "none";
}

async function onScanSuccess(qr) {
    if (!qr) return;
    const id = String(qr).trim();
    if (!id) return;

    // debounce: evita processar o mesmo id nas pr√≥ximas 2s
    const now = Date.now();
    if (recentScans.has(id) && (now - recentScans.get(id) < 2000)) {
        // ignorar scan muito pr√≥ximo
        return;
    }
    recentScans.set(id, now);
    setTimeout(()=> recentScans.delete(id), 3000);

    // procura ve√≠culo com saida === null
    let veiculo = estacionamento.find(v => v.id === id && v.saida === null);

    if (!veiculo) {
        // ENTRADA: checar limite e tamb√©m se j√° existe um registro de entrada recente (paranoia extra)
        const dentro = estacionamento.filter(v => v.saida === null);
        if (dentro.length >= limite) {
            alert("üö´ Estacionamento LOTADO!");
            return;
        }

        // evitar duplicar entradas id√™nticas em situa√ß√£o estranha
        const lastSame = estacionamento.slice().reverse().find(v => v.id === id);
        if (lastSame && lastSame.saida === null) {
            // j√° dentro (paranoia)
            alert("Ve√≠culo j√° registrado como dentro.");
            return;
        }

        const nowIso = new Date().toISOString();
        estacionamento.push({
            id,
            entrada: nowIso,
            saida: null,
            operadorEntrada: currentUser || "‚Äî"
        });
        save();
        audioEntrada.play();
        alert("üöó Entrada registrada!\nID: " + id + "\nHora: " + formatISO(nowIso));
    } else {
        // SA√çDA
        const nowIso = new Date().toISOString();
        veiculo.saida = nowIso;
        veiculo.operadorSaida = currentUser || "‚Äî";
        save();
        audioSaida.play();
        alert("üèÅ Sa√≠da registrada!\nID: " + id + "\nHora: " + formatISO(nowIso));
    }
}

// ------------------------------
// LANTERNA (torch)
// ------------------------------
async function toggleFlash() {
    try {
        if (!qrReader) return alert("Leitor n√£o iniciado.");
        const localStream = qrReader._localStream;
        if (!localStream) return alert("C√¢mera n√£o carregou ainda.");

        const tracks = localStream.getVideoTracks();
        if (!tracks || tracks.length === 0) return alert("Nenhuma faixa de v√≠deo encontrada.");
        const track = tracks[0];

        const cap = track.getCapabilities ? track.getCapabilities() : {};
        if (!cap.torch) return alert("Lanterna (torch) n√£o suportada neste dispositivo/c√¢mera.");

        FLASH = !FLASH;
        // aplicar constraints
        await track.applyConstraints({ advanced: [{ torch: FLASH }] });
    } catch (e) {
        console.error("Erro lanterna:", e);
        alert("Erro lanterna: " + (e.message || e));
    }
}

// ------------------------------
// STATUS
// ------------------------------
function showStatus() {
    // parada opcional do leitor para evitar confus√µes na visualiza√ß√£o
    // (n√£o obrigat√≥rio) -> mantive ativo, s√≥ mostra a caixa
    document.getElementById("statusBox").style.display = "block";
    document.getElementById("exportBox").style.display = "none";

    const dentro = estacionamento.filter(v => v.saida === null);

    document.getElementById("limiteVagas").innerText = limite;
    document.getElementById("totalDentro").innerText = dentro.length;
    document.getElementById("disponiveis").innerText = limite - dentro.length;

    const lista = document.getElementById("lista");
    lista.innerHTML = "";

    dentro.forEach(v => {
        lista.innerHTML += `
            <div class="operator">
                <b>ID:</b> ${v.id}<br>
                Entrada: ${formatISO(v.entrada)}<br>
                Operador: ${v.operadorEntrada || '‚Äî'}
            </div>`;
    });
}

// ------------------------------
// EXPORTAR CSV
// ------------------------------
function showExport() {
    document.getElementById("exportBox").style.display = "block";
    document.getElementById("statusBox").style.display = "none";
}

function exportarCSV() {
    // Cabe√ßalho
    let csv = "ID,Entrada (ISO),Entrada (Local),Sa√≠da (ISO),Sa√≠da (Local),Operador Entrada,Operador Sa√≠da\n";

    estacionamento.forEach(v => {
        const entradaISO = v.entrada || "";
        const entradaLocal = entradaISO ? `"${formatISO(entradaISO)}"` : "";
        const saidaISO = v.saida || "";
        const saidaLocal = saidaISO ? `"${formatISO(saidaISO)}"` : "";
        const linha = [
            `"${v.id}"`,
            entradaISO,
            entradaLocal,
            saidaISO,
            saidaLocal,
            `"${v.operadorEntrada || ''}"`,
            `"${v.operadorSaida || ''}"`
        ].join(",");
        csv += linha + "\n";
    });

    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "estacionamento.csv";
    a.click();

    // liberar URL
    setTimeout(() => URL.revokeObjectURL(url), 5000);
}

// ------------------------------
// ADMIN
// ------------------------------
function showAdmin() {
    document.getElementById("adminBox").style.display = "block";
    listarOperadores();
    document.getElementById("limiteInput").value = limite;
}

function salvarLimite() {
    const v = Number(document.getElementById("limiteInput").value);
    if (!v || v <= 0) return alert("Informe um limite v√°lido (>0).");
    limite = v;
    save();
    alert("Limite salvo!");
}

function addOperador() {
    const nome = document.getElementById("newOpName").value.trim();
    const senha = document.getElementById("newOpPass").value;
    if (!nome || !senha) return alert("Preencha tudo.");

    // evitar nomes duplicados
    if (operadores.some(o => o.nome.toLowerCase() === nome.toLowerCase())) {
        return alert("J√° existe um operador com este nome.");
    }

    operadores.push({ nome, senha });
    save();
    listarOperadores();
    document.getElementById("newOpName").value = "";
    document.getElementById("newOpPass").value = "";
}

function listarOperadores() {
    const div = document.getElementById("operadoresLista");
    div.innerHTML = "";

    operadores.forEach(op => {
        div.innerHTML += `<div class="operator">${op.nome}</div>`;
    });

    loadOperadores();
}

async function limparDados() {
    const pass = document.getElementById("senhaMaster").value;
    if (!pass) return alert("Digite a senha master.");

    const hash = await sha256Hex(pass);
    const stored = localStorage.getItem('masterHash');
    if (hash !== stored) return alert("Senha incorreta!");

    // limpar tudo (mas manter a masterHash para n√£o travar o acesso)
    estacionamento = [];
    operadores = [];
    limite = 100;
    save();
    listarOperadores();
    alert("Dados apagados! (operadores e registros removidos; senha master preservada)");
    document.getElementById("senhaMaster").value = "";
}

// ------------------------------
// Lidando com sa√≠da da p√°gina - para garantir liberar c√¢mera
// ------------------------------
window.addEventListener('beforeunload', async (e) => {
    try {
        await stopCamera();
    } catch(e){}
});
</script>

</body>
</html>

