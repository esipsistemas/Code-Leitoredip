
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Leitor de Ingressos ESIP</title>

  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 20px;
      background: #eef3ff;
    }
    h2 { color: #003f88; }

    #reader {
      width: 320px;
      margin: auto;
      border: 3px solid #003f88;
      border-radius: 12px;
      padding: 10px;
      background: white;
    }

    #result {
      margin-top: 20px;
      font-size: 22px;
      font-weight: bold;
      padding: 15px;
      border-radius: 10px;
    }
  </style>
</head>
<body>

<h2>üì∑ Leitor Oficial ESIP</h2>
<p>Aponte a c√¢mera para o QR Code do ingresso.</p>

<div id="reader"></div>
<div id="result"></div>

<!-- Sons -->
<audio id="okSound">
  <source src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg">
</audio>

<audio id="errorSound">
  <source src="https://actions.google.com/sounds/v1/cartoon/boing.ogg">
</audio>

<script>

// ---------- 1) Prote√ß√£o com c√≥digo secreto ----------
const codigo = prompt("Digite o c√≥digo de acesso para usar o leitor ESIP:");

if (codigo !== "ESIP2025") {
  alert("C√≥digo incorreto. Acesso negado.");
  window.location.href = "https://google.com";
}


// ---------- 2) Fun√ß√£o para validar formato do ingresso ----------
function formatoValido(textoQR) {
  // Exemplo de formato aceito: ESIP-1234 ou somente n√∫mero
  return /^ESIP-\d+$/.test(textoQR) || /^\d+$/.test(textoQR);
}


// ---------- 3) Fun√ß√£o para validar ingresso ----------
function marcarUsado(id) {

  if (!formatoValido(id)) {
    erro("Formato inv√°lido ‚Äî isso N√ÉO √© um ingresso ESIP!");
    return;
  }

  let ingressos = JSON.parse(localStorage.getItem("ingressosESIP") || "[]");
  const index = ingressos.findIndex(i => i.id == id);

  if (index === -1) {
    erro("‚ùå Ingresso n√£o encontrado no sistema!");
    return;
  }

  if (ingressos[index].usado) {
    erro("‚õî Ingresso j√° utilizado!");
    return;
  }

  ingressos[index].usado = true;
  localStorage.setItem("ingressosESIP", JSON.stringify(ingressos));

  sucesso("‚úÖ Ingresso v√°lido!<br>" +
          "üéü Tipo: " + ingressos[index].tipo + "<br>" +
          "üÜî ID: " + ingressos[index].id);
}


// ---------- Estilos de resultado + som ----------
function sucesso(msg) {
  document.getElementById("result").style.background = "#b6ffb3";
  document.getElementById("result").style.color = "#003300";
  document.getElementById("result").innerHTML = msg;
  document.getElementById("okSound").play();
}

function erro(msg) {
  document.getElementById("result").style.background = "#ffb6b6";
  document.getElementById("result").style.color = "#660000";
  document.getElementById("result").innerHTML = msg;
  document.getElementById("errorSound").play();
}


// ---------- 4) Iniciar o scanner ----------
function startScanner() {
  const html5QrCode = new Html5Qrcode("reader");

  html5QrCode.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 250 },
    (decodedText) => {
      marcarUsado(decodedText.trim());
    },
    () => {}
  ).catch(err => {
    erro("Erro ao acessar c√¢mera! Permita o uso da c√¢mera.");
  });
}

startScanner();

</script>

</body>
</html>
