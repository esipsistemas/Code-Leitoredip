<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Controle de Estacionamento Offline</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

<style>
body { background:#0A1A2A; font-family:Arial; margin:0; padding:15px; color:#fff; }
h2,h3{text-align:center;}
button{width:100%; padding:14px; margin-top:10px; background:#0D47A1; color:#fff; border:none; border-radius:6px; font-size:18px; cursor:pointer;}
button.red{background:#b71c1c;}
input,select{width:100%; padding:12px; margin-top:10px; border-radius:6px; border:none; font-size:16px;}
.box{background:#10263D; padding:15px; border-radius:10px; margin-top:20px; box-shadow:0 0 8px #0005;}
.flash-btn{background:#ffb300; color:#000;}
.operator{padding:12px; margin-top:10px; background:#083860; border-radius:6px;}
.qr-container{text-align:center; margin-top:10px;}
.small{font-size:12px; color:#aaa; margin-top:6px;}
footer{text-align:center; font-size:12px; color:#aaa; margin-top:20px;}
.msg{
    position:fixed; top:10px; left:50%; transform:translateX(-50%);
    background:#ffb300; color:#000; padding:10px 20px;
    border-radius:8px; font-weight:bold; z-index:9999; box-shadow:0 0 10px #000;
}
</style>
</head>
<body>

<h2>ğŸš— Controle de Estacionamento Offline</h2>

<!-- LOGIN -->
<div id="loginBox" class="box">
<h3>Entrar como Operador</h3>
<select id="operadorSelect"></select>
<input id="operadorSenha" type="password" placeholder="Senha do operador">
<button onclick="login()">Entrar</button>
<hr>
<button onclick="modoAdmin()">Entrar como ADMIN</button>
<p class="small">Se for a primeira vez, entre como ADMIN para criar operadores.</p>
</div>

<!-- HOME -->
<div id="home" class="box" style="display:none;">
<h3 id="welcome"></h3>
<button onclick="startCamera()">ğŸ“· Iniciar Leitor QR</button>
<button onclick="showStatus()">ğŸ“Š Status das Vagas</button>
<button onclick="showExport()">ğŸ“¤ Exportar PDF</button>
<button onclick="showQRGenerator()">ğŸ–¨ï¸ Gerar QR</button>
<button onclick="showAdmin()" id="adminBtn" style="display:none;">âš™ï¸ Ãrea Administrativa</button>
<button onclick="stopCamera()" id="stopBtn" style="display:none;margin-top:6px;" class="red">â›” Parar Leitor</button>
<button onclick="logout()" id="logoutBtn" class="red" style="display:none;margin-top:6px;">ğŸšª SAIR</button>
</div>

<!-- LEITOR -->
<div id="readerContainer" style="display:none;">
<button class="flash-btn" onclick="toggleFlash()">ğŸ”¦ Ligar/Desligar Lanterna</button>
<div id="reader" style="margin-top:10px;"></div>
</div>

<!-- STATUS -->
<div id="statusBox" class="box" style="display:none;">
<h3>Status das Vagas</h3>
<p><b>Limite:</b> <span id="limiteVagas"></span></p>
<p><b>Dentro:</b> <span id="totalDentro"></span></p>
<p><b>DisponÃ­veis:</b> <span id="disponiveis"></span></p>
<div id="lista"></div>
</div>

<!-- EXPORTAR PDF -->
<div id="exportBox" class="box" style="display:none;">
<h3>Exportar Registros</h3>
<button onclick="exportPDF()">ğŸ“¤ Baixar PDF</button>
</div>

<!-- GERAR QR -->
<div id="qrBox" class="box" style="display:none;">
<h3>Gerador de QR</h3>

<input id="placaInput" placeholder="Placa">
<input id="modeloInput" placeholder="Modelo">
<input id="corInput" placeholder="Cor">
<input id="proprietarioInput" placeholder="Nome do ProprietÃ¡rio">
<input id="telInput" placeholder="Telefone">
<select id="tipoInput">
  <option value="">Tipo do VeÃ­culo</option>
  <option>Carro</option>
  <option>Moto</option>
  <option>CaminhÃ£o</option>
</select>
<input id="obsInput" placeholder="ObservaÃ§Ãµes (opcional)">
<button onclick="gerarQR()">Gerar QR + Registrar Entrada</button>

<div class="qr-container" id="qrResult"></div>
</div>

<!-- ADMIN -->
<div id="adminBox" class="box" style="display:none;">
<h3>AdministraÃ§Ã£o</h3>
<input id="limiteInput" type="number" placeholder="Limite de vagas">
<button onclick="salvarLimite()">Salvar limite</button>

<h4>Operadores</h4>
<input id="newOpName" placeholder="Nome do operador">
<input id="newOpPass" type="password" placeholder="Senha do operador">
<button onclick="addOperador()">Adicionar operador</button>
<div id="operadoresLista"></div>

<h4>Limpar Dados</h4>
<input id="senhaMaster" type="password" placeholder="Senha master">
<button onclick="limparDados()">Apagar tudo</button>
<p class="small">Senha master padrÃ£o: <b>admin123</b>.</p>
</div>

<footer>âš ï¸ Ãrea restrita. Uso exclusivo de operadores autorizados.</footer>

<!-- SOM PARA FEEDBACK -->
<audio id="beepSound" src="beep.mp3" preload="auto"></audio>

<script>
// =========================
// UTIL
// =========================
function msg(t){
    const d=document.createElement("div");
    d.className="msg"; d.innerText=t;
    document.body.appendChild(d);
    setTimeout(()=>d.remove(),1800);
}

let estacionamento=JSON.parse(localStorage.getItem("estacionamento"))||[];
let operadores=JSON.parse(localStorage.getItem("operadores"))||[];
let veiculosGerados=JSON.parse(localStorage.getItem("veiculosGerados"))||[];
let limite=Number(localStorage.getItem("limite")??100);
let qrReader=null;
let FLASH=false;
let currentUser=null;

if(operadores.length===0) operadores.push({nome:"admin",senha:"admin123"});

function save(){
    localStorage.setItem("estacionamento",JSON.stringify(estacionamento));
    localStorage.setItem("operadores",JSON.stringify(operadores));
    localStorage.setItem("veiculosGerados",JSON.stringify(veiculosGerados));
    localStorage.setItem("limite",String(limite));
}

function loadOperadores(){
    operadorSelect.innerHTML="";
    operadores.forEach(op=>operadorSelect.innerHTML+=`<option>${op.nome}</option>`);
}
loadOperadores();

// =========================
// LOGIN
// =========================
function login(){
    const nome=operadorSelect.value;
    const senha=operadorSenha.value;
    const op=operadores.find(o=>o.nome===nome && o.senha===senha);
    if(!op) return msg("Senha invÃ¡lida!");
    currentUser=nome;
    loginBox.style.display="none";
    home.style.display="block";
    welcome.innerText="Operador: "+nome;
    logoutBtn.style.display="inline-block";
}

function modoAdmin(){
    const senha=prompt("Senha master:");
    if(senha!=="admin123") return msg("Senha incorreta!");
    currentUser="ADMIN";
    loginBox.style.display="none";
    home.style.display="block";
    adminBtn.style.display="block";
    welcome.innerText="Administrador";
    logoutBtn.style.display="inline-block";
}

// =========================
// LOGOUT COM CONFIRMAÃ‡ÃƒO
// =========================
function logout(){
    if(!confirm("Tem certeza que deseja sair?")) return;

    stopCamera();

    ["home","adminBox","qrBox","exportBox","statusBox","readerContainer"]
    .forEach(id=>document.getElementById(id).style.display="none");

    loginBox.style.display="block";
    operadorSenha.value="";
    currentUser=null;
    msg("Operador desconectado");
}

// =========================
// CÃ‚MERA QR
// =========================
async function startCamera(){
    readerContainer.style.display="block";
    stopBtn.style.display="inline-block";

    if(qrReader){
        try{await qrReader.stop();}catch(e){}
        try{qrReader.clear();}catch(e){}
        qrReader=null;
    }

    qrReader=new Html5Qrcode("reader");

    try{
        const cams=await Html5Qrcode.getCameras();
        const rear=cams.filter(c=>/back|rear/gi.test(c.label));
        let camId = rear.length?rear[0].id:cams[0].id;

        await qrReader.start(camId,{fps:10,qrbox:{width:250,height:250}},onScanSuccess);
    }catch(e){ msg("Erro ao iniciar cÃ¢mera"); }
}

async function stopCamera(){
    if(!qrReader) return;
    try{await qrReader.stop();}catch(e){}
    try{qrReader.clear();}catch(e){}
    qrReader=null;
    readerContainer.style.display="none";
    stopBtn.style.display="none";
}

// =========================
// LANTERNA APRIMORADA
// =========================
async function toggleFlash() {
    if (!qrReader) return;
    try {
        const track = qrReader.getState().stream.getVideoTracks()[0];
        const capabilities = track.getCapabilities();
        if (!capabilities.torch) return msg("Lanterna nÃ£o suportada neste dispositivo");
        FLASH = !FLASH;
        await track.applyConstraints({ advanced: [{ torch: FLASH }] });
        msg(FLASH ? "Lanterna ligada" : "Lanterna desligada");
    } catch (e) {
        console.error(e);
        msg("Erro ao alternar lanterna");
    }
}

// =========================
// SCAN QR COM SOM E VIBRAÃ‡ÃƒO
// =========================
const recentScans=new Map();

function onScanSuccess(qr){
    const id=String(qr).trim();
    const beep = document.getElementById("beepSound");

    if(!veiculosGerados.includes(id)){
        msg("âŒ QR invÃ¡lido!");
        if(navigator.vibrate) navigator.vibrate([100,50,100]);
        if(beep) beep.play().catch(e=>console.warn(e));
        return;
    }

    if(recentScans.has(id) && Date.now()-recentScans.get(id)<2000) return;
    recentScans.set(id,Date.now());
    setTimeout(()=>recentScans.delete(id),2500);

    const now=new Date();
    let v=estacionamento.find(x=>x.id===id && !x.saida);

    if(!v){ // Entrada
        if(estacionamento.filter(x=>!x.saida).length>=limite){
            msg("ğŸš« Estacionamento LOTADO!");
            if(navigator.vibrate) navigator.vibrate([200,100,200]);
            if(beep) beep.play().catch(e=>console.warn(e));
            return;
        }
        estacionamento.push({
            id,
            entrada:now.toISOString(),
            saida:null,
            operadorEntrada:currentUser
        });
        msg("âœ… Entrada registrada!");
        if(navigator.vibrate) navigator.vibrate([200,100,200]);
        if(beep) beep.play().catch(e=>console.warn(e));
    } else { // SaÃ­da
        v.saida=now.toISOString();
        v.operadorSaida=currentUser;
        msg("âš ï¸ SaÃ­da registrada!");
        if(navigator.vibrate) navigator.vibrate([100,50,100,50,100]);
        if(beep) beep.play().catch(e=>console.warn(e));
    }
    save();
}

// =========================
// RESTANTE DO CÃ“DIGO ORIGINAL
// =========================
// FunÃ§Ãµes de gerar QR, PDF, status, admin, logout, salvar limite e limpar dados
// Estas funÃ§Ãµes permanecem exatamente como no seu cÃ³digo original, sem alteraÃ§Ã£o.
// Basta copiar todo o restante do seu cÃ³digo original daqui em diante.
</script>
</body>
</html>

