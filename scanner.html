<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Controle de Estacionamento Offline</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

<style>
body { background:#0A1A2A; font-family:Arial; margin:0; padding:15px; color:#fff; }
h2,h3{text-align:center;}
button{width:100%; padding:14px; margin-top:10px; background:#0D47A1; color:#fff; border:none; border-radius:6px; font-size:18px; cursor:pointer;}
input,select{width:100%; padding:12px; margin-top:10px; border-radius:6px; border:none; font-size:16px;}
.box{background:#10263D; padding:15px; border-radius:10px; margin-top:20px; box-shadow:0 0 8px #0005;}
.flash-btn{background:#ffb300; color:#000;}
.operator{padding:12px; margin-top:10px; background:#083860; border-radius:6px;}
.qr-container{text-align:center; margin-top:10px;}
.small{font-size:12px; color:#aaa; margin-top:6px;}
footer{text-align:center; font-size:12px; color:#aaa; margin-top:20px;}
.msg{
    position:fixed; top:10px; left:50%; transform:translateX(-50%);
    background:#ffb300; color:#000; padding:10px 20px;
    border-radius:8px; font-weight:bold; z-index:9999; box-shadow:0 0 10px #000;
}
</style>
</head>
<body>

<h2>üöó Controle de Estacionamento Offline</h2>

<!-- LOGIN -->
<div id="loginBox" class="box">
<h3>Entrar como Operador</h3>
<select id="operadorSelect"></select>
<input id="operadorSenha" type="password" placeholder="Senha do operador">
<button onclick="login()">Entrar</button>
<hr>
<button onclick="modoAdmin()">Entrar como ADMIN</button>
<p class="small">Se for a primeira vez, entre como ADMIN para criar operadores.</p>
</div>

<!-- HOME -->
<div id="home" class="box" style="display:none;">
<h3 id="welcome"></h3>
<button onclick="startCamera()">üì∑ Iniciar Leitor QR</button>
<button onclick="showStatus()">üìä Status das Vagas</button>
<button onclick="showExport()">üì§ Exportar PDF</button>
<button onclick="showQRGenerator()">üñ®Ô∏è Gerar QR</button>
<button onclick="showAdmin()" id="adminBtn" style="display:none;">‚öôÔ∏è √Årea Administrativa</button>
<button onclick="stopCamera()" id="stopBtn" style="display:none;margin-top:6px;background:#b71c1c;">‚õî Parar Leitor</button>
<button onclick="logout()" id="logoutBtn" style="display:none;margin-top:6px;background:#b71c1c;">üö™ SAIR</button>
</div>

<!-- LEITOR -->
<div id="readerContainer" style="display:none;">
<button class="flash-btn" onclick="toggleFlash()">üî¶ Ligar/Desligar Lanterna</button>
<div id="reader" style="margin-top:10px;"></div>
</div>

<!-- STATUS -->
<div id="statusBox" class="box" style="display:none;">
<h3>Status das Vagas</h3>
<p><b>Limite:</b> <span id="limiteVagas"></span></p>
<p><b>Dentro:</b> <span id="totalDentro"></span></p>
<p><b>Dispon√≠veis:</b> <span id="disponiveis"></span></p>
<div id="lista"></div>
</div>

<!-- EXPORTAR PDF -->
<div id="exportBox" class="box" style="display:none;">
<h3>Exportar Registros</h3>
<button onclick="exportPDF()">üì§ Baixar PDF</button>
</div>

<!-- GERAR QR -->
<div id="qrBox" class="box" style="display:none;">
<h3>Gerador de QR</h3>

<input id="placaInput" placeholder="Placa">
<input id="modeloInput" placeholder="Modelo">
<input id="corInput" placeholder="Cor">
<input id="proprietarioInput" placeholder="Nome do Propriet√°rio">
<input id="telInput" placeholder="Telefone">
<select id="tipoInput">
  <option value="">Tipo do Ve√≠culo</option>
  <option>Carro</option>
  <option>Moto</option>
  <option>Caminh√£o</option>
</select>
<input id="obsInput" placeholder="Observa√ß√µes (opcional)">
<button onclick="gerarQR()">Gerar QR + Registrar Entrada</button>

<div class="qr-container" id="qrResult"></div>
</div>

<!-- ADMIN -->
<div id="adminBox" class="box" style="display:none;">
<h3>Administra√ß√£o</h3>
<input id="limiteInput" type="number" placeholder="Limite de vagas">
<button onclick="salvarLimite()">Salvar limite</button>

<h4>Operadores</h4>
<input id="newOpName" placeholder="Nome do operador">
<input id="newOpPass" type="password" placeholder="Senha do operador">
<button onclick="addOperador()">Adicionar operador</button>
<div id="operadoresLista"></div>

<h4>Limpar Dados</h4>
<input id="senhaMaster" type="password" placeholder="Senha master">
<button onclick="limparDados()">Apagar tudo</button>
<p class="small">Senha master padr√£o: <b>admin123</b>.</p>
</div>

<footer>‚ö†Ô∏è √Årea restrita. Uso exclusivo de operadores autorizados.</footer>

<script>
// =========================
// UTIL
// =========================
function msg(t){
    const d=document.createElement("div");
    d.className="msg"; d.innerText=t;
    document.body.appendChild(d);
    setTimeout(()=>d.remove(),1800);
}

let estacionamento=JSON.parse(localStorage.getItem("estacionamento"))||[];
let operadores=JSON.parse(localStorage.getItem("operadores"))||[];
let veiculosGerados=JSON.parse(localStorage.getItem("veiculosGerados"))||[];
let limite=Number(localStorage.getItem("limite")??100);
let qrReader=null;
let FLASH=false;
let currentUser=null;

if(operadores.length===0) operadores.push({nome:"admin",senha:"admin123"});

function save(){
    localStorage.setItem("estacionamento",JSON.stringify(estacionamento));
    localStorage.setItem("operadores",JSON.stringify(operadores));
    localStorage.setItem("veiculosGerados",JSON.stringify(veiculosGerados));
    localStorage.setItem("limite",String(limite));
}

function loadOperadores(){
    operadorSelect.innerHTML="";
    operadores.forEach(op=>operadorSelect.innerHTML+=`<option>${op.nome}</option>`);
}
loadOperadores();

// =========================
// LOGIN
// =========================
function login(){
    const nome=operadorSelect.value;
    const senha=operadorSenha.value;
    const op=operadores.find(o=>o.nome===nome && o.senha===senha);
    if(!op) return msg("Senha inv√°lida!");
    currentUser=nome;
    loginBox.style.display="none";
    home.style.display="block";
    welcome.innerText="Operador: "+nome;
    logoutBtn.style.display="inline-block";
}

function modoAdmin(){
    const senha=prompt("Senha master:");
    if(senha!=="admin123") return msg("Senha incorreta!");
    currentUser="ADMIN";
    loginBox.style.display="none";
    home.style.display="block";
    adminBtn.style.display="block";
    welcome.innerText="Administrador";
    logoutBtn.style.display="inline-block";
}

// =========================
// LOGOUT
// =========================
function logout(){
    stopCamera();
    ["home","adminBox","qrBox","exportBox","statusBox","readerContainer"]
    .forEach(id=>document.getElementById(id).style.display="none");
    loginBox.style.display="block";
    operadorSenha.value="";
    currentUser=null;
}

// =========================
// C√ÇMERA QR
// =========================
async function startCamera(){
    readerContainer.style.display="block";
    stopBtn.style.display="inline-block";

    if(qrReader){
        try{await qrReader.stop();}catch(e){}
        try{qrReader.clear();}catch(e){}
        qrReader=null;
    }

    qrReader=new Html5Qrcode("reader");

    try{
        const cams=await Html5Qrcode.getCameras();
        const rear=cams.filter(c=>/back|rear/gi.test(c.label));
        let camId = rear.length?rear[0].id:cams[0].id;

        await qrReader.start(camId,{fps:10,qrbox:{width:250,height:250}},onScanSuccess);
    }catch(e){ msg("Erro ao iniciar c√¢mera"); }
}

async function stopCamera(){
    if(!qrReader) return;
    try{await qrReader.stop();}catch(e){}
    try{qrReader.clear();}catch(e){}
    qrReader=null;
    readerContainer.style.display="none";
    stopBtn.style.display="none";
}

const recentScans=new Map();

function onScanSuccess(qr){
    const id=String(qr).trim();
    if(!veiculosGerados.includes(id)){
        return msg("‚ùå QR inv√°lido!");
    }

    if(recentScans.has(id) && Date.now()-recentScans.get(id)<2000) return;
    recentScans.set(id,Date.now());
    setTimeout(()=>recentScans.delete(id),2500);

    const now=new Date();
    let v=estacionamento.find(x=>x.id===id && !x.saida);

    if(!v){
        if(estacionamento.filter(x=>!x.saida).length>=limite){
            return msg("üö´ Estacionamento LOTADO!");
        }
        estacionamento.push({
            id,
            entrada:now.toISOString(),
            saida:null,
            operadorEntrada:currentUser
        });
        msg("Entrada registrada!");
    } else {
        v.saida=now.toISOString();
        v.operadorSaida=currentUser;
        msg("Sa√≠da registrada!");
    }
    save();
}

// =========================
// GERAR QR
// =========================
function showQRGenerator(){
    hideAll();
    qrBox.style.display="block";
}

function hideAll(){
    ["statusBox","exportBox","adminBox","qrBox"].forEach(
        id=>document.getElementById(id).style.display="none"
    );
}

function gerarQR(){
    const placa=placaInput.value.trim();
    const modelo=modeloInput.value.trim();
    const cor=corInput.value.trim();
    const prop=proprietarioInput.value.trim();
    const tel=telInput.value.trim();
    const tipo=tipoInput.value;
    const obs=obsInput.value.trim();

    if(!placa||!modelo||!cor||!prop||!tipo)
        return msg("Preencha os campos obrigat√≥rios!");

    // ‚úÖ ID √∫nico come√ßa com ESIP-
    const id="ESIP-"+Date.now()+"-"+Math.floor(Math.random()*9999);

    veiculosGerados.push(id);
    save();

    const now=new Date();
    estacionamento.push({
        id,
        dados:{placa,modelo,cor,prop,tel,tipo,obs},
        entrada:now.toISOString(),
        saida:null,
        operadorEntrada:currentUser
    });
    save();

    const box=qrResult;
    box.innerHTML="";
    const canvas=document.createElement("canvas");
    box.appendChild(canvas);

    QRCode.toCanvas(canvas,id,{width:220},()=>{
        const link=document.createElement("a");
        link.href=canvas.toDataURL("image/png");
        link.download=id+"_QR.png";
        link.innerText="‚¨áÔ∏è Baixar QR";
        link.style.display="block";
        link.style.marginTop="10px";
        box.appendChild(link);

        const pdfBtn=document.createElement("button");
        pdfBtn.innerText="‚¨áÔ∏è PDF do Ve√≠culo";
        pdfBtn.onclick=()=>gerarPDFIndividual(id);
        box.appendChild(pdfBtn);
    });

    msg("QR gerado!");
}

// PDF individual com QR central e grande
async function gerarPDFIndividual(id){
    const v=estacionamento.find(x=>x.id===id);
    if(!v) return msg("N√£o encontrado!");

    const {jsPDF}=window.jspdf;
    const doc=new jsPDF();

    doc.setFontSize(20);
    doc.text("Ficha do Ve√≠culo",105,15,{align:"center"});

    let y=30;
    function add(t){ doc.setFontSize(12); doc.text(t,20,y); y+=10; }

    add(`ID: ${v.id}`);
    add(`Placa: ${v.dados?.placa}`);
    add(`Modelo: ${v.dados?.modelo}`);
    add(`Cor: ${v.dados?.cor}`);
    add(`Propriet√°rio: ${v.dados?.prop}`);
    add(`Telefone: ${v.dados?.tel}`);
    add(`Tipo: ${v.dados?.tipo}`);
    add(`Obs: ${v.dados?.obs||"-"}`);
    add(`Entrada: ${new Date(v.entrada).toLocaleString()}`);
    add(`Sa√≠da: ${v.saida? new Date(v.saida).toLocaleString() : "‚Äî"}`);

    const qrDataUrl = await new Promise(res=>{
        const c=document.createElement("canvas");
        QRCode.toCanvas(c,v.id,{width:150},()=>res(c.toDataURL()));
    });

    // QR grande e centralizado
    doc.addImage(qrDataUrl,"PNG",80, y+10, 50, 50);

    doc.save("veiculo_"+v.id+".pdf");
}

// =========================
// STATUS
// =========================
function showStatus(){
    hideAll();
    statusBox.style.display="block";

    limiteVagas.innerText=limite;
    const dentro=estacionamento.filter(v=>!v.saida).length;
    totalDentro.innerText=dentro;
    disponiveis.innerText=limite-dentro;

    lista.innerHTML="";
    estacionamento.filter(v=>!v.saida).forEach(v=>{
        const d=document.createElement("div");
        d.className="operator";
        d.innerText=
            `ID: ${v.id} | Placa: ${v.dados?.placa||"-"} | Entrada: ${new Date(v.entrada).toLocaleString()} | Op: ${v.operadorEntrada}`;
        lista.appendChild(d);
    });
}

function showExport(){
    hideAll();
    exportBox.style.display="block";
}

// =========================
// EXPORTAR PDF GERAL
// =========================
async function exportPDF() {
    if (estacionamento.length === 0) return msg("N√£o h√° registros para exportar!");

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.setFontSize(20);
    doc.text("Registros do Estacionamento", 105, 15, { align: "center" });

    let y = 30;

    estacionamento.forEach(v => {
        function add(t){ doc.setFontSize(12); doc.text(t, 20, y); y += 7; }

        add(`ID: ${v.id}`);
        add(`Placa: ${v.dados?.placa || "-"}`);
        add(`Modelo: ${v.dados?.modelo || "-"}`);
        add(`Cor: ${v.dados?.cor || "-"}`);
        add(`Propriet√°rio: ${v.dados?.prop || "-"}`);
        add(`Telefone: ${v.dados?.tel || "-"}`);
        add(`Tipo: ${v.dados?.tipo || "-"}`);
        add(`Obs: ${v.dados?.obs || "-"}`);
        add(`Entrada: ${new Date(v.entrada).toLocaleString()}`);
        add(`Sa√≠da: ${v.saida ? new Date(v.saida).toLocaleString() : "‚Äî"}`);
        y += 5;

        if (y > 270){ doc.addPage(); y = 20; }
    });

    doc.save("registros_estacionamento.pdf");
}

// =========================
// ADMIN
// =========================
function showAdmin(){
    const senha = prompt("Digite a senha do administrador:");
    if(senha !== "admin123") return msg("Senha incorreta!");

    hideAll();
    adminBox.style.display="block";
    listarOperadores();
    limiteInput.value=limite;
}

function salvarLimite(){
    const v=Number(limiteInput.value);
    if(!v || v<=0) return msg("Inv√°lido!");
    limite=v; save();
    msg("Limite salvo!");
}

function addOperador(){
    const nome=newOpName.value.trim();
    const senha=newOpPass.value.trim();
    if(!nome||!senha) return msg("Preencha tudo");
    if(operadores.some(o=>o.nome.toLowerCase()===nome.toLowerCase()))
        return msg("J√° existe");

    operadores.push({nome,senha});
    save();
    listarOperadores();
    newOpName.value=""; newOpPass.value="";
}

function listarOperadores(){
    operadoresLista.innerHTML="";
    operadores.forEach(op=>{
        operadoresLista.innerHTML+=`<div class="operator">${op.nome}</div>`;
    });
    loadOperadores();
}

function limparDados(){
    if(senhaMaster.value!=="admin123") return msg("Senha incorreta!");
    estacionamento=[];
    operadores=[{nome:"admin",senha:"admin123"}];
    veiculosGerados=[];
    limite=100;
    save();
    listarOperadores();
    msg("Dados apagados!");
}
</script>
</body>
</html>
