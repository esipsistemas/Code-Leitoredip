<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Controle de Estacionamento Offline</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Bibliotecas -->
<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

<style>
body { background: #0A1A2A; font-family: Arial, sans-serif; margin: 0; padding: 15px; color: #fff; }
h2,h3 { text-align:center; }
button { width:100%; padding:14px; margin-top:10px; background:#0D47A1; color:#fff; border:none; border-radius:6px; font-size:18px; cursor:pointer; }
input,select { width:100%; padding:12px; margin-top:10px; border-radius:6px; border:none; font-size:16px; }
.box { background:#10263D; padding:15px; border-radius:10px; margin-top:20px; box-shadow:0 0 8px #0005; }
.flash-btn { background:#ffb300; color:#000; }
.operator { padding:12px; margin-top:10px; background:#083860; border-radius:6px; }
.qr-container { text-align:center; margin-top:10px; }
.small { font-size:12px; color:#aaa; margin-top:6px; }
footer { text-align:center; font-size:12px; color:#aaa; margin-top:20px; }

/* Mensagem tempor√°ria no topo */
.msg {
    position: fixed;
    top: 10px;
    left: 50%;
    transform: translateX(-50%);
    background:#ffb300;
    color:#000;
    padding:10px 20px;
    border-radius:8px;
    font-weight:bold;
    z-index:9999;
    box-shadow:0 0 10px #000;
}
</style>
</head>
<body>

<h2>üöó Controle de Estacionamento Offline</h2>

<!-- LOGIN -->
<div id="loginBox" class="box">
<h3>Entrar como Operador</h3>
<select id="operadorSelect"></select>
<input id="operadorSenha" type="password" placeholder="Senha do operador">
<button onclick="login()">Entrar</button>
<hr>
<button onclick="modoAdmin()">Entrar como ADMIN</button>
<p class="small">Se for a primeira vez, entre como ADMIN para criar operadores.</p>
</div>

<!-- HOME -->
<div id="home" class="box" style="display:none;">
<h3 id="welcome"></h3>
<button onclick="startCamera()">üì∑ Iniciar Leitor QR</button>
<button onclick="showStatus()">üìä Status das Vagas</button>
<button onclick="showExport()">üì§ Exportar PDF</button>
<button onclick="showQRGenerator()">üñ®Ô∏è Gerar QR</button>
<button onclick="showAdmin()" id="adminBtn" style="display:none;">‚öôÔ∏è √Årea Administrativa</button>
<button onclick="stopCamera()" id="stopBtn" style="display:none;margin-top:6px;background:#b71c1c;">‚õî Parar Leitor</button>
<button onclick="logout()" id="logoutBtn" style="display:none;margin-top:6px;background:#b71c1c;">üö™ SAIR</button>
</div>

<!-- LEITOR -->
<div id="readerContainer" style="display:none;">
<button class="flash-btn" onclick="toggleFlash()">üî¶ Ligar/Desligar Lanterna</button>
<div id="reader" style="margin-top:10px;"></div>
</div>

<!-- STATUS -->
<div id="statusBox" class="box" style="display:none;">
<h3>Status das Vagas</h3>
<p><b>Limite:</b> <span id="limiteVagas"></span></p>
<p><b>Dentro:</b> <span id="totalDentro"></span></p>
<p><b>Dispon√≠veis:</b> <span id="disponiveis"></span></p>
<div id="lista"></div>
</div>

<!-- EXPORTAR PDF -->
<div id="exportBox" class="box" style="display:none;">
<h3>Exportar Registros</h3>
<button onclick="exportPDF()">üì§ Baixar PDF</button>
</div>

<!-- GERADOR DE QR -->
<div id="qrBox" class="box" style="display:none;">
<h3>Gerador de QR</h3>

<input id="idInput" placeholder="ID do Ve√≠culo">
<input id="placaInput" placeholder="Placa">
<input id="modeloInput" placeholder="Modelo">
<input id="corInput" placeholder="Cor">
<input id="proprietarioInput" placeholder="Nome do Propriet√°rio">
<input id="telInput" placeholder="Telefone">
<select id="tipoInput">
  <option value="">Tipo do Ve√≠culo</option>
  <option>Carro</option>
  <option>Moto</option>
  <option>Caminh√£o</option>
</select>
<input id="obsInput" placeholder="Observa√ß√µes (opcional)">
<button onclick="gerarQR()">Gerar QR + Registrar Entrada</button>

<div class="qr-container" id="qrResult"></div>
</div>

<!-- ADMIN -->
<div id="adminBox" class="box" style="display:none;">
<h3>Administra√ß√£o</h3>
<input id="limiteInput" type="number" placeholder="Limite de vagas">
<button onclick="salvarLimite()">Salvar limite</button>

<h4>Operadores</h4>
<input id="newOpName" placeholder="Nome do operador">
<input id="newOpPass" placeholder="Senha do operador">
<button onclick="addOperador()">Adicionar operador</button>
<div id="operadoresLista"></div>

<h4>Limpar Dados</h4>
<input id="senhaMaster" type="password" placeholder="Senha master">
<button onclick="limparDados()">Apagar tudo</button>
<p class="small">Senha master padr√£o: <b>admin123</b>. Recomendado alterar.</p>
</div>

<footer>‚ö†Ô∏è √Årea restrita. Uso exclusivo de operadores autorizados.</footer>

<script>
/* Mensagens suaves */
function msg(txt){
    const d = document.createElement("div");
    d.className = "msg";
    d.innerText = txt;
    document.body.appendChild(d);
    setTimeout(()=>d.remove(), 1800);
}

/* LOGO base64 - substitua pela sua */
const LOGO = ""; // Adicione sua imagem base64 aqui se quiser no PDF

/* Banco local */
let estacionamento = JSON.parse(localStorage.getItem("estacionamento")) || [];
let operadores = JSON.parse(localStorage.getItem("operadores")) || [];
let veiculosGerados = JSON.parse(localStorage.getItem("veiculosGerados")) || [];
let limite = Number(localStorage.getItem("limite") ?? 100);
let qrReader = null;
let FLASH = false;
let currentUser = null;

/* Sons */
const audioValido = new Audio("https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg");
const audioUsado  = new Audio("https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg");
const audioInvalido = new Audio("https://actions.google.com/sounds/v1/cartoon/wood_box_flicks.ogg");

function save(){
    localStorage.setItem("estacionamento", JSON.stringify(estacionamento));
    localStorage.setItem("operadores", JSON.stringify(operadores));
    localStorage.setItem("limite", String(limite));
    localStorage.setItem("veiculosGerados", JSON.stringify(veiculosGerados));
}

/* LOGIN */
if(operadores.length===0) operadores.push({nome:"admin",senha:"admin123"});

function loadOperadores(){
    const sel=document.getElementById("operadorSelect");
    sel.innerHTML="";
    operadores.forEach(op=>{
        sel.innerHTML+=`<option>${op.nome}</option>`;
    });
}
loadOperadores();

function login(){
    const nome=document.getElementById("operadorSelect").value;
    const senha=document.getElementById("operadorSenha").value;
    const op=operadores.find(o=>o.nome===nome && o.senha===senha);
    if(!op) return msg("Senha inv√°lida!");
    currentUser=nome;
    document.getElementById("loginBox").style.display="none";
    document.getElementById("home").style.display="block";
    document.getElementById("welcome").innerText="Operador: "+nome;
    document.getElementById("logoutBtn").style.display="inline-block";
}

function modoAdmin(){
    const senha=prompt("Digite a senha master:");
    if(senha!=="admin123") return msg("Senha incorreta!");
    currentUser="ADMIN";
    document.getElementById("loginBox").style.display="none";
    document.getElementById("home").style.display="block";
    document.getElementById("welcome").innerText="Administrador";
    document.getElementById("adminBtn").style.display="block";
    document.getElementById("logoutBtn").style.display="inline-block";
}

/* LOGOUT */
function logout(){
    stopCamera();

    ["home","adminBox","qrBox","exportBox","statusBox","readerContainer"]
    .forEach(id => document.getElementById(id).style.display = "none");

    document.getElementById("loginBox").style.display = "block";
    document.getElementById("logoutBtn").style.display = "none";
    currentUser = null;
    document.getElementById("operadorSenha").value = "";
}

/* C√ÇMERA QR */
async function startCamera(){
    document.getElementById("readerContainer").style.display="block";
    document.getElementById("stopBtn").style.display="inline-block";

    if(qrReader){
        try{ await qrReader.stop(); }catch(e){}
        try{ qrReader.clear(); }catch(e){}
        qrReader=null;
    }

    qrReader = new Html5Qrcode("reader");

    try{
        const cams = await Html5Qrcode.getCameras();
        const rearCams = cams.filter(c => /back|rear/gi.test(c.label));
        let camId = rearCams.length>0 ? rearCams[0].id : cams[0].id;

        await qrReader.start(
            camId,
            { fps: 10, qrbox: { width: 250, height: 250 } },
            onScanSuccess
        );
    }catch(e){
        msg("Erro ao iniciar c√¢mera");
    }
}

async function stopCamera(){
    if(!qrReader) return;
    try{ await qrReader.stop(); }catch(e){}
    try{ qrReader.clear(); }catch(e){}
    qrReader=null;
    document.getElementById("readerContainer").style.display="none";
    document.getElementById("stopBtn").style.display="none";
}

/* Debounce */
const recentScans = new Map();

/* SCAN SUCCESS */
function onScanSuccess(qr){
    if(!qr) return;
    const id = String(qr).trim();

    if(/^https?:\/\//i.test(id) || !veiculosGerados.includes(id)){
        audioInvalido.play();
        try{ navigator.vibrate([200]); }catch(e){}
        return msg("‚ùå QR inv√°lido!");
    }

    if(recentScans.has(id) && Date.now() - recentScans.get(id) < 2000) return;
    recentScans.set(id, Date.now());
    setTimeout(()=>recentScans.delete(id), 2500);

    const now = new Date();
    let veiculo = estacionamento.find(v => v.id === id && !v.saida);

    if(!veiculo){
        if(estacionamento.filter(v => !v.saida).length >= limite){
            audioUsado.play();
            return msg("üö´ Estacionamento LOTADO!");
        }
        estacionamento.push({
            id,
            entrada: now.toISOString(),
            saida: null,
            operadorEntrada: currentUser
        });
        audioValido.play();
        msg("üöó Entrada registrada!");
    } else {
        veiculo.saida = now.toISOString();
        veiculo.operadorSaida = currentUser;
        audioValido.play();
        msg("üèÅ Sa√≠da registrada!");
    }

    save();
}

/* GERADOR QR */
function showQRGenerator(){
    hideAll();
    document.getElementById("qrBox").style.display="block";
}

function hideAll(){
    ["statusBox","exportBox","adminBox","qrBox"].forEach(id=>document.getElementById(id).style.display="none");
}

function gerarQR(){
    const id=idInput.value.trim();
    const placa=placaInput.value.trim();
    const modelo=modeloInput.value.trim();
    const cor=corInput.value.trim();
    const prop=proprietarioInput.value.trim();
    const tel=telInput.value.trim();
    const tipo=tipoInput.value;
    const obs=obsInput.value.trim();

    if(!id||!placa||!modelo||!cor||!prop||!tipo)
        return msg("Preencha tudo!");

    if(veiculosGerados.includes(id))
        return msg("ID j√° usado!");

    veiculosGerados.push(id);
    save();

    const now = new Date();
    estacionamento.push({
        id,
        dados:{placa,modelo,cor,prop,tel,tipo,obs},
        entrada: now.toISOString(),
        saida:null,
        operadorEntrada: currentUser
    });
    save();

    const container=document.getElementById("qrResult");
    container.innerHTML="";

    const canvas=document.createElement("canvas");
    container.appendChild(canvas);

    try{
        QRCode.toCanvas(canvas,id,{width:220},()=>{
            const link=document.createElement("a");
            link.href=canvas.toDataURL("image/png");
            link.download=id+"_QR.png";
            link.innerText="‚¨áÔ∏è Baixar QR";
            link.style.display="block";
            link.style.marginTop="10px";
            container.appendChild(link);

            const pdfBtn=document.createElement("button");
            pdfBtn.innerText="‚¨áÔ∏è PDF do Ve√≠culo";
            pdfBtn.onclick=()=>gerarPDFIndividual(id);
            container.appendChild(pdfBtn);
        });
    }catch(e){
        msg("Erro ao gerar QR");
    }

    msg("QR gerado!");
}

/* PDF INDIVIDUAL */
async function gerarPDFIndividual(id){
    const v = estacionamento.find(x=>x.id===id);
    if(!v) return msg("Ve√≠culo n√£o encontrado!");

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    try{
        if(LOGO) doc.addImage(LOGO,"JPEG",70,10,70,40);
    }catch(e){ console.warn("Erro na LOGO", e); }

    doc.setFontSize(20);
    doc.text("Ficha do Ve√≠culo",105,60,{align:"center"});

    let y=80;

    function add(txt){
        doc.text(txt,20,y);
        y+=10;
    }

    add(`ID: ${v.id}`);
    add(`Placa: ${v.dados?.placa || "-"}`);
    add(`Modelo: ${v.dados?.modelo || "-"}`);
    add(`Cor: ${v.dados?.cor || "-"}`);
    add(`Propriet√°rio: ${v.dados?.prop || "-"}`);
    add(`Telefone: ${v.dados?.tel || "-"}`);
    add(`Tipo: ${v.dados?.tipo || "-"}`);
    add(`Obs: ${v.dados?.obs || "-"}`);
    add(`Entrada: ${new Date(v.entrada).toLocaleString()}`);
    add(`Sa√≠da: ${v.saida?new Date(v.saida).toLocaleString():"‚Äî"}`);

    const qrDataUrl = await new Promise(resolve=>{
        const canvas=document.createElement("canvas");
        QRCode.toCanvas(canvas, v.id, { width:200 }, ()=>{
            resolve(canvas.toDataURL("image/png"));
        });
    });
    doc.addImage(qrDataUrl, "PNG", 130, 90, 60, 60);

    doc.save(`veiculo_${v.id}.pdf`);
}

/* EXPORTAR PDF */
async function exportPDF(){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    let y=20;

    estacionamento.forEach(v=>{
        if(y>260){
            doc.addPage();
            y=20;
        }

        doc.setFontSize(14);
        doc.text("Registro",105,y,{align:"center"});
        y+=10;

        const txt=[
            `ID: ${v.id}`,
            `Placa: ${v.dados?.placa||"-"}`,
            `Modelo: ${v.dados?.modelo||"-"}`,
            `Cor: ${v.dados?.cor||"-"}`,
            `Propriet√°rio: ${v.dados?.prop||"-"}`,
            `Entrada: ${new Date(v.entrada).toLocaleString()}`,
            `Sa√≠da: ${v.saida?new Date(v.saida).toLocaleString():"‚Äî"}`
        ];

        txt.forEach(t=>{
            doc.text(t,20,y);
            y+=7;
        });

        y+=8;
    });

    doc.save("estacionamento_registros.pdf");
}

/* STATUS */
function showStatus(){
    hideAll();
    document.getElementById("statusBox").style.display="block";

    document.getElementById("limiteVagas").innerText=limite;
    const dentro = estacionamento.filter(v=>!v.saida).length;
    document.getElementById("totalDentro").innerText=dentro;
    document.getElementById("disponiveis").innerText=limite-dentro;

    const listaDiv=document.getElementById("lista");
    listaDiv.innerHTML="";

    estacionamento.filter(v=>!v.saida).forEach(v=>{
        const div=document.createElement("div");
        div.className="operator";
        div.innerText=
            `ID: ${v.id} | Placa: ${v.dados?.placa||"-"} | Entrada: ${new Date(v.entrada).toLocaleString()} | Operador: ${v.operadorEntrada}`;
        listaDiv.appendChild(div);
    });
}

function showExport(){
    hideAll();
    document.getElementById("exportBox").style.display="block";
}

/* ADMIN */
function showAdmin(){
    hideAll();
    document.getElementById("adminBox").style.display="block";
    listarOperadores();
    document.getElementById("limiteInput").value=limite;
}

function salvarLimite(){
    const v=Number(document.getElementById("limiteInput").value);
    if(!v||v<=0) return msg("Limite inv√°lido!");
    limite=v;
    save();
    msg("Limite salvo");
}

function addOperador(){
    const nome=document.getElementById("newOpName").value.trim();
    const senha=document.getElementById("newOpPass").value.trim();
    if(!nome||!senha) return msg("Preencha tudo");
    if(operadores.some(o=>o.nome.toLowerCase()===nome.toLowerCase()))
        return msg("Operador j√° existe");

    operadores.push({nome,senha});
    save();
    listarOperadores();
    document.getElementById("newOpName").value="";
    document.getElementById("newOpPass").value="";
}

function listarOperadores(){
    const div=document.getElementById("operadoresLista");
    div.innerHTML="";
    operadores.forEach(op=>{
        div.innerHTML+=`<div class="operator">${op.nome}</div>`;
    });
    loadOperadores();
}

function limparDados(){
    const pass=document.getElementById("senhaMaster").value;
    if(pass!=="admin123") return msg("Senha incorreta!");

    estacionamento=[];
    operadores=[{nome:"admin",senha:"admin123"}];
    veiculosGerados=[];
    limite=100;
    save();
    listarOperadores();
    msg("Dados apagados!");
}

/* Ao fechar p√°gina */
window.addEventListener("beforeunload", async ()=>{
    if(qrReader){
        try{ await qrReader.stop(); }catch(e){}
    }
});
</script>
</body>
</html>

