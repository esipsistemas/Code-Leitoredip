
<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ESIP - Leitor Seguro (Com Foto)</title>

<!-- html5-qrcode -->
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
/* --- estilo baseado no seu original --- */
body { background: #1a0000; color: #fff; font-family: Arial, sans-serif; text-align: center; margin: 0; padding-bottom: 40px; }
h2 { margin-top: 20px; }
#reader { width: 350px; margin: 20px auto; border: 4px solid #ff0000; border-radius: 12px; }
.btn { background: #ff0000; color: white; padding: 12px; border: none; border-radius: 10px; font-size: 16px; margin: 8px 0; width: 90%; cursor: pointer; }
.btn:active { transform: translateY(1px); }
#msg { margin-top: 20px; font-size: 20px; font-weight: bold; min-height:28px; }
.green { color: #00ff88; } .red { color: #ff4444; }
.flash-ok { animation: flashGreen 0.25s; } .flash-bad { animation: flashRed 0.25s; }
@keyframes flashGreen { 0% { background: #00ff8860; } 100% { background: transparent; } }
@keyframes flashRed { 0% { background: #ff444460; } 100% { background: transparent; } }

.container { max-width: 980px; margin: 0 auto; padding: 12px; }
#history { margin-top: 20px; padding: 10px; text-align:left; max-width:900px; margin-left:auto; margin-right:auto; }
.badge { display: inline-block; margin: 5px; padding: 8px 14px; border-radius: 30px; font-size: 14px; background: #330000; border: 1px solid #ff4444; color: #fff; }
.badge.valid { background: #003314; border-color: #00ff88; }
.counter-row { display:flex; gap:12px; justify-content:center; margin-top:10px; flex-wrap:wrap; }
.counter-box { background: #330000; border: 2px solid #ff0000; padding: 8px 12px; border-radius: 10px; font-size: 15px; min-width:120px; text-align:center; }
.preview-photo { margin-top:10px; max-width:320px; border-radius:8px; border:2px solid #333; display:block; margin-left:auto; margin-right:auto; }
.small { font-size:13px; opacity:0.9; }
.controls { display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-top:10px; }
.info-box { background:#110000; padding:10px; border-radius:8px; margin-top:12px; max-width:900px; margin-left:auto; margin-right:auto; text-align:left; }
</style>
</head>
<body>
<div class="container">
  <h2>üì° ESIP - Leitor Seguro (Com Foto)</h2>

  <div class="counter-row">
    <div class="counter-box">V√°lidos: <span id="countValid">0</span></div>
    <div class="counter-box">Usados: <span id="countUsed">0</span></div>
    <div class="counter-box">Inv√°lidos: <span id="countInvalid">0</span></div>
  </div>

  <div style="text-align:center; margin-top:8px;">
    <button class="btn" id="themeToggle">üåô Alternar Tema</button>
  </div>

  <div id="reader"></div>

  <div class="controls">
    <button id="toggleLight" class="btn">üî¶ Lanterna (Desligada)</button>
    <button id="switchCam" class="btn">üîÑ Trocar C√¢mera</button>
    <button id="pauseScan" class="btn">‚è∏Ô∏è Pausar Scanner</button>
  </div>

  <div id="msg"></div>

  <div class="info-box" id="ticketBox" style="display:none;">
    <strong>Dados do QR:</strong>
    <div id="infoFields" class="small" style="margin-top:6px;"></div>

    <div style="margin-top:8px;">
      <button id="btnTakePhoto" class="btn">üì∑ Tirar Foto</button>
      <button id="btnConfirm" class="btn" style="background:#007700; width:42%;">‚úÖ Confirmar Entrada</button>
      <button id="btnCancel" class="btn" style="background:#666; width:42%;">‚úñ Cancelar</button>
    </div>

    <img id="photoPreview" class="preview-photo" src="" alt="Preview foto" style="display:none;">
    <div class="small" id="photoNote" style="display:none; text-align:center; margin-top:6px;">Foto pronta. Confirme para enviar.</div>
  </div>

  <div style="margin-top:12px; display:flex; gap:8px; justify-content:center; flex-wrap:wrap;">
    <button id="export" class="btn">üì§ Exportar CSV (Local)</button>
    <button id="exportPdf" class="btn">üì• Exportar PDF (Detalhado)</button>
    <button id="reset" class="btn">üóëÔ∏è Resetar Hist√≥rico (Local)</button>
  </div>

  <h3 style="margin-top:18px;">üìú Hist√≥rico (local)</h3>
  <div id="history"></div>
</div>

<!-- FIREBASE (ES modules) -->
<script type="module">
  // -------------------- CONFIGURA√á√ÉO FIREBASE --------------------
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-functions.js";
  import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
  import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDpknEpRl8BjPICk0aE5ZgGftTlx90TtIg",
    authDomain: "esip-seistemas.firebaseapp.com",
    projectId: "esip-seistemas",
    storageBucket: "esip-seistemas.firebasestorage.app",
    messagingSenderId: "659305820670",
    appId: "1:659305820670:web:fa566a6334f8f5f86410af"
  };

  const app = initializeApp(firebaseConfig);
  const functions = getFunctions(app);
  const callValidate = httpsCallable(functions, 'validateAndUseTicket'); // se a function existir, ser√° chamada
  const db = getFirestore(app);
  const storage = getStorage(app);

  // -------------------- ESTADO E LOCALSTORAGE --------------------
  let html5Qr;
  let flashOn = false; // inicia desligada
  let scanning = true;
  let currentCam = 0;
  let cameras = [];

  let localUsedDetails = JSON.parse(localStorage.getItem("local_used_details") || "[]"); // array de objetos salvos localmente
  let localUsedSet = new Set(localUsedDetails.map(o=> (o.raw || o.id) ));

  let totalValid   = parseInt(localStorage.getItem("countValid")   || "0");
  let totalUsed    = parseInt(localStorage.getItem("countUsed")    || "0");
  let totalInvalid = parseInt(localStorage.getItem("countInvalid") || "0");

  document.getElementById("countValid").textContent = totalValid;
  document.getElementById("countUsed").textContent = totalUsed;
  document.getElementById("countInvalid").textContent = totalInvalid;

  function saveLocal() {
    localStorage.setItem("local_used_details", JSON.stringify(localUsedDetails));
    localStorage.setItem("countValid", String(totalValid));
    localStorage.setItem("countUsed", String(totalUsed));
    localStorage.setItem("countInvalid", String(totalInvalid));
  }

  // -------------------- SONS --------------------
  const sValid   = new Audio("https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg");
  const sInvalid = new Audio("https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg");
  const sUsed    = new Audio("https://actions.google.com/sounds/v1/cartoon/pop.ogg");

  // -------------------- UI HELPERS --------------------
  function flash(type) {
    const cls = type === "good" ? "flash-ok" : "flash-bad";
    document.body.classList.add(cls);
    setTimeout(()=>document.body.classList.remove(cls), 250);
  }
  function showMsg(text, ok=true) {
    const m = document.getElementById("msg");
    m.textContent = text;
    m.className = ok ? "green" : "red";
  }

  function renderHistory() {
    const box = document.getElementById("history");
    box.innerHTML = "";
    localUsedDetails.slice().reverse().forEach(item => {
      const el = document.createElement("div");
      el.className = "badge valid";
      el.style.display = "block";
      el.style.textAlign = "left";
      el.style.maxWidth = "820px";
      el.innerHTML = `<strong>${item.id || ''}</strong> ‚Äî ${item.nome || '-'} ‚Äî ${item.hora || '-'} ‚Äî ${item.data || '-'}<br/><small style="opacity:0.8">Validado em: ${item.usedAtServer ? new Date(item.usedAtServer).toLocaleString() : (item.usedAtLocal ? new Date(item.usedAtLocal).toLocaleString() : '-')} ‚Äî Porteiro: ${item.operador || '-'}</small>`;
      box.appendChild(el);
    });
  }
  renderHistory();

  // -------------------- PARSER do seu formato EXACTO --------------------
  // Ex.: ID=88291;HORA=20:00;DATA=2025-01-01;
  function parseQR(text) {
    const parts = text.split(";").map(p=>p.trim()).filter(Boolean);
    const obj = {};
    parts.forEach(part => {
      const eq = part.indexOf("=");
      if (eq>0) {
        const key = part.substring(0,eq).trim().toLowerCase();
        const val = part.substring(eq+1).trim();
        obj[key] = val;
      }
    });
    // Normaliza chaves
    if (!obj.id) return null;
    return {
      id: obj.id || "",
      hora: obj.hora || "",
      data: obj.data || "",
      raw: text
    };
  }

  // -------------------- SCANNER --------------------
  async function startScanner() {
    html5Qr = new Html5Qrcode("reader");
    try {
      cameras = await Html5Qrcode.getCameras();
    } catch(e) {
      console.error("getCameras error:", e);
      cameras = [];
    }
    if (!cameras.length) {
      showMsg("‚ö†Ô∏è C√¢mera n√£o encontrada", false);
      return;
    }

    try {
      await html5Qr.start(
        cameras[currentCam].id,
        { fps: 10, qrbox: 250 },
        (decodedText) => onScanSuccess(decodedText),
        (error) => { /* ignore frame errors */ }
      );
      document.getElementById("toggleLight").innerText = flashOn ? "üî¶ Lanterna (Ligada)" : "üî¶ Lanterna (Desligada)";
    } catch (err) {
      console.error("start scanner error:", err);
      showMsg("‚ùå Erro ao iniciar scanner", false);
    }
  }

  startScanner();

  document.getElementById("switchCam").onclick = async () => {
    if (!cameras || cameras.length<=1) { showMsg("‚ö†Ô∏è N√£o h√° outra c√¢mera", false); return; }
    currentCam = (currentCam+1) % cameras.length;
    try { await html5Qr.stop(); } catch(e){}
    startScanner();
  };

  document.getElementById("pauseScan").onclick = async () => {
    scanning = !scanning;
    document.getElementById("pauseScan").textContent = scanning ? "‚è∏Ô∏è Pausar Scanner" : "‚ñ∂Ô∏è Retomar Scanner";
    showMsg(scanning ? "Scanner ativo" : "Scanner pausado", true);
  };

  async function toggleTorch(forceState = null) {
    if (!html5Qr) return;
    const track = html5Qr.getRunningTrack();
    if (!track) { showMsg("‚ö†Ô∏è Lanterna n√£o dispon√≠vel", false); return; }
    const caps = track.getCapabilities?.();
    if (!caps?.torch) { showMsg("‚ö†Ô∏è Lanterna n√£o suportada", false); return; }
    flashOn = forceState !== null ? forceState : !flashOn;
    try {
      await track.applyConstraints({ advanced:[{torch: flashOn}] });
      document.getElementById("toggleLight").innerText = flashOn ? "üî¶ Lanterna (Ligada)" : "üî¶ Lanterna (Desligada)";
    } catch(err) {
      console.warn("toggleTorch failed:", err);
      showMsg("‚ö†Ô∏è Falha ao alterar lanterna", false);
    }
  }
  document.getElementById("toggleLight").onclick = () => toggleTorch();

  // -------------------- PROCESSAMENTO DO QR --------------------
  let lastDecoded = null;
  async function onScanSuccess(decodedText) {
    if (!scanning) return;
    scanning = false;
    lastDecoded = decodedText.trim();

    // Se j√° validado localmente?
    if (localUsedSet.has(lastDecoded)) {
      totalUsed++; updateCounters();
      flash("bad"); sUsed.play().catch(()=>{});
      showMsg("‚ö†Ô∏è J√° utilizado (local)", false);
      setTimeout(()=> scanning = true, 800);
      return;
    }

    const payload = parseQR(lastDecoded);
    if (!payload) {
      totalInvalid++; updateCounters();
      flash("bad"); sInvalid.play().catch(()=>{});
      showMsg("‚ùå QR inv√°lido (formato esperado: ID=...;HORA=...;DATA=...;)", false);
      setTimeout(()=> scanning = true, 800);
      return;
    }

    // mostrar dados na tela e permitir tirar foto
    document.getElementById("ticketBox").style.display = "block";
    const info = `ID: ${payload.id} ‚Äî HORA: ${payload.hora || '-'} ‚Äî DATA: ${payload.data || '-'}`;
    document.getElementById("infoFields").textContent = info;
    showMsg("QR detectado. Tire a foto e confirme.", true);

    // guarda payload tempor√°rio
    window._currentPayload = payload;
    // reset preview
    document.getElementById("photoPreview").style.display = "none";
    document.getElementById("photoPreview").src = "";
    document.getElementById("photoNote").style.display = "none";
    setTimeout(()=> scanning = true, 200); // permite nova leitura se cancelar
  }

  function updateCounters() {
    document.getElementById("countValid").textContent = totalValid;
    document.getElementById("countUsed").textContent = totalUsed;
    document.getElementById("countInvalid").textContent = totalInvalid;
    saveLocal();
  }

  // -------------------- FOTO (bot√£o) --------------------
  let currentStream = null;
  let capturedBlob = null;

  document.getElementById("btnTakePhoto").onclick = async () => {
    // pede c√¢mera frontal/back se poss√≠vel
    try {
      if (currentStream) {
        // j√° aberto: tirar foto do stream
        const track = currentStream.getVideoTracks()[0];
        const imageCapture = new ImageCapture(track);
        const bitmap = await imageCapture.grabFrame();
        // desenhar para canvas
        const canvas = document.createElement("canvas");
        canvas.width = bitmap.width;
        canvas.height = bitmap.height;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(bitmap, 0, 0);
        canvas.toBlob(blob => {
          capturedBlob = blob;
          document.getElementById("photoPreview").src = URL.createObjectURL(blob);
          document.getElementById("photoPreview").style.display = "block";
          document.getElementById("photoNote").style.display = "block";
          showMsg("Foto capturada. Confirme para enviar.", true);
          // stop stream after capture
          currentStream.getTracks().forEach(t=>t.stop());
          currentStream = null;
        }, "image/jpeg", 0.8);
      } else {
        // abre a c√¢mera em uma nova janela/elemento tempor√°rio para tirar foto via getUserMedia
        const constraints = { video: { facingMode: "environment", width: { ideal: 1280 } }, audio:false };
        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        currentStream = stream;
        // cria video tempor√°rio para capturar frame
        const video = document.createElement("video");
        video.autoplay = true;
        video.playsInline = true;
        video.srcObject = stream;
        video.style.width = "320px";
        video.style.height = "auto";
        video.onloadedmetadata = () => { video.play(); };
        // criar modal visual simples: substituir preview area por video tempor√°rio
        document.getElementById("photoPreview").style.display = "block";
        document.getElementById("photoPreview").src = "";
        video.style.borderRadius = "8px";
        // inserir o video antes do preview and replace after capture: we'll append under ticketBox
        const parent = document.getElementById("ticketBox");
        parent.appendChild(video);
        // Alterar o bot√£o para funcionar como "Capturar"
        const takeBtn = document.getElementById("btnTakePhoto");
        takeBtn.textContent = "üì∏ Capturar";
        const captureHandler = async () => {
          // capturar frame
          const canvas = document.createElement("canvas");
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
          canvas.toBlob(blob => {
            capturedBlob = blob;
            document.getElementById("photoPreview").src = URL.createObjectURL(blob);
            // remove the video element
            try { video.pause(); video.srcObject = null; } catch(e){}
            video.remove();
            // restore button
            takeBtn.textContent = "üì∑ Tirar Foto";
            takeBtn.removeEventListener("click", captureHandler);
            document.getElementById("photoNote").style.display = "block";
            showMsg("Foto capturada. Confirme para enviar.", true);
            // stop stream
            stream.getTracks().forEach(t=>t.stop());
            currentStream = null;
          }, "image/jpeg", 0.8);
        };
        takeBtn.addEventListener("click", captureHandler);
      }
    } catch (err) {
      console.error("Erro camera:", err);
      showMsg("‚ùå Erro ao acessar c√¢mera", false);
    }
  };

  document.getElementById("btnCancel").onclick = () => {
    document.getElementById("ticketBox").style.display = "none";
    window._currentPayload = null;
    capturedBlob = null;
    document.getElementById("photoPreview").style.display = "none";
    document.getElementById("photoPreview").src = "";
    showMsg("Cancelado", true);
  };

  // -------------------- CONFIRMAR ENTRADA --------------------
  document.getElementById("btnConfirm").onclick = async () => {
    const payload = window._currentPayload;
    if (!payload) { showMsg("‚ùå Nada para confirmar", false); return; }
    if (!capturedBlob) { showMsg("‚ùå Tire a foto antes de confirmar", false); return; }

    showMsg("‚è≥ Validando no servidor...", true);

    // 1) opcional: chamar cloud function validateAndUseTicket para marcar ingresso (se existir)
    let serverResult = { status: "nofunc", message: "Function n√£o chamada" };
    try {
      const res = await callValidate({ id: payload.id, hash: payload.hash || "", evento: payload.evento || "" });
      serverResult = res.data || serverResult;
    } catch (err) {
      // se fun√ß√£o n√£o existir ou erro, n√£o bloqueia o fluxo: salvamos local e no collection 'acessos'
      console.warn("validate call failed (continuando):", err);
      serverResult = { status: "nofunc", message: "Erro/Function ausente" };
    }

    if (serverResult.status === "used") {
      totalUsed++; updateCounters();
      flash("bad"); sUsed.play().catch(()=>{});
      showMsg("‚ö†Ô∏è Ingresso j√° utilizado (servidor)", false);
      return;
    }

    if (serverResult.status === "invalidhash" || serverResult.status === "notfound") {
      totalInvalid++; updateCounters();
      flash("bad"); sInvalid.play().catch(()=>{});
      showMsg(`‚ùå ${serverResult.message || 'Inv√°lido'}`, false);
      return;
    }

    // 2) upload da foto para Storage
    showMsg("‚è≥ Enviando foto...", true);
    const ts = Date.now();
    const storagePath = `acessos/${payload.id}_${ts}.jpg`;
    const sRef = storageRef(storage, storagePath);
    try {
      await uploadBytes(sRef, capturedBlob);
      const photoUrl = await getDownloadURL(sRef);

      // 3) salvar documento em 'acessos' (cole√ß√£o permitida nas regras)
      const docData = {
        id: payload.id,
        hora_qr: payload.hora || "",
        data_qr: payload.data || "",
        rawQr: payload.raw || "",
        photoUrl,
        operador: (window.__operadorName || "PORTEIRO"),
        device: navigator.userAgent || "",
        status: serverResult.status === "ok" ? "liberado" : "registrado",
        serverValidation: serverResult,
        createdAt: serverTimestamp()
      };

      const colRef = collection(db, "acessos");
      await addDoc(colRef, docData);

      // 4) atualizar contadores e hist√≥rico local
      const localEntry = {
        id: payload.id,
        nome: payload.nome || "",
        hora: payload.hora || "",
        data: payload.data || "",
        raw: payload.raw,
        photoUrl,
        operador: docData.operador,
        status: docData.status,
        usedAtLocal: new Date().toISOString(),
        usedAtServer: serverResult.ticket && serverResult.ticket.usedAt ? (serverResult.ticket.usedAt._seconds ? new Date(serverResult.ticket.usedAt._seconds*1000).toISOString() : serverResult.ticket.usedAt) : null
      };
      localUsedDetails.push(localEntry);
      localUsedSet.add(payload.raw);
      totalValid++; updateCounters();
      renderHistory();
      flash("good"); sValid.play().catch(()=>{});
      showMsg("‚úÖ Entrada confirmada e registrada", true);

      // limpar UI
      document.getElementById("ticketBox").style.display = "none";
      document.getElementById("photoPreview").style.display = "none";
      document.getElementById("photoPreview").src = "";
      capturedBlob = null;
      window._currentPayload = null;

    } catch (err) {
      console.error("Erro upload/save:", err);
      totalInvalid++; updateCounters();
      showMsg("‚ùå Falha ao enviar foto / salvar registro", false);
    }
  };

  // -------------------- EXPORT CSV --------------------
  document.getElementById("export").onclick = () => {
    const csvHeader = "id,nome,hora_qr,data_qr,photoUrl,operador,status,device,createdAt,raw\n";
    const rows = localUsedDetails.map(d => {
      const vals = [
        `"${(d.id||"").replace(/"/g,'""')}"`,
        `"${(d.nome||"").replace(/"/g,'""')}"`,
        `"${(d.hora||"").replace(/"/g,'""')}"`,
        `"${(d.data||"").replace(/"/g,'""')}"`,
        `"${(d.photoUrl||"").replace(/"/g,'""')}"`,
        `"${(d.operador||"").replace(/"/g,'""')}"`,
        `"${(d.status||"").replace(/"/g,'""')}"`,
        `"${(d.device||"").replace(/"/g,'""')}"`,
        `"${(d.usedAtLocal||"").replace(/"/g,'""')}"`,
        `"${(d.raw||"").replace(/"/g,'""')}"`
      ];
      return vals.join(",");
    }).join("\n");

    const blob = new Blob([csvHeader + rows], {type:"text/csv"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = `ingressos_local_${Date.now()}.csv`; a.click();
  };

  // -------------------- EXPORT PDF (detalhado) --------------------
  function loadScript(url) {
    return new Promise((resolve, reject) => {
      if (document.querySelector(`script[src="${url}"]`)) return resolve();
      const s = document.createElement('script');
      s.src = url;
      s.onload = () => resolve();
      s.onerror = () => reject(new Error('Falha ao carregar ' + url));
      document.head.appendChild(s);
    });
  }

  document.getElementById("exportPdf").onclick = async () => {
    try {
      await loadScript("https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js");
      await loadScript("https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js");
      const { jsPDF } = window.jspdf;

      const doc = new jsPDF({ orientation: "portrait", unit: "pt", format: "a4" });
      const now = new Date();
      doc.setFontSize(14);
      doc.text("Relat√≥rio de Ingressos Validados (local)", 40, 40);
      doc.setFontSize(10);
      doc.text(`Gerado em: ${now.toLocaleString()}`, 40, 60);
      doc.text(`V√°lidos: ${totalValid}   Usados (local): ${localUsedDetails.length}   Inv√°lidos: ${totalInvalid}`, 40, 76);

      if (localUsedDetails.length === 0) {
        doc.setFontSize(11);
        doc.text("Nenhum ingresso utilizado localmente.", 40, 110);
        doc.save(`ingressos_local_${now.getTime()}.pdf`);
        return;
      }

      const rows = localUsedDetails.map((d, i) => {
        return [
          i+1,
          d.id || "",
          d.nome || "",
          d.hora || "",
          d.data || "",
          d.operador || "",
          d.status || "",
          d.usedAtLocal ? new Date(d.usedAtLocal).toLocaleString() : ""
        ];
      });

      doc.autoTable({
        startY: 100,
        head: [["#", "C√≥digo", "Nome", "Hora", "Data", "Porteiro", "Status", "Validado Em"]],
        body: rows,
        styles: { fontSize: 9 },
        headStyles: { fillColor: [200, 30, 30] },
        margin: { left: 40, right: 40 },
      });

      doc.save(`ingressos_local_detalhado_${now.getTime()}.pdf`);
    } catch (err) {
      console.error("Erro exportando PDF:", err);
      showMsg("‚ùå Falha ao exportar PDF", false);
    }
  };

  // -------------------- RESET LOCAL --------------------
  document.getElementById("reset").onclick = () => {
    if (!confirm("Confirma resetar o hist√≥rico local? Isso N√ÉO remove registros do Firestore.")) return;
    localUsedDetails = [];
    localUsedSet = new Set();
    localStorage.removeItem("local_used_details");
    totalValid = 0; totalUsed = 0; totalInvalid = 0;
    updateCounters();
    renderHistory();
    showMsg("üîÑ Hist√≥rico local resetado", true);
  };

  // -------------------- UTIL --------------------
  function updateCounters() {
    document.getElementById("countValid").textContent = totalValid;
    document.getElementById("countUsed").textContent = totalUsed;
    document.getElementById("countInvalid").textContent = totalInvalid;
    saveLocal();
  }

  // tema toggle
  document.getElementById("themeToggle").onclick = () => document.body.classList.toggle("light");

</script>
</body>
</html>
