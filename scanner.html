<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ðŸ“¡ ESIP â€“ Sistema Militar / Operacional</title>

<style>
/* ======== TEMA MILITAR / OPERACIONAL ======== */
body {
    margin: 0;
    font-family: Arial, sans-serif;
    background-color: #0b0b0b;
    color: #b4d2a4;
}
.hidden { display: none; }
header {
    background-color: #0a2c0a;
    padding: 15px;
    font-weight: bold;
    font-size: 20px;
    text-align: center;
    color: #a8d08d;
}
.container {
    max-width: 480px;
    margin: 20px auto;
    padding: 20px;
}
.card {
    background-color: #101010;
    padding: 18px;
    border-radius: 10px;
    margin-bottom: 20px;
    border: 1px solid #222;
}
label { display: block; margin-bottom: 6px; color: #b4d2a4; }
input {
    width: 100%;
    padding: 12px;
    border: none;
    border-radius: 8px;
    background: #0b0b0b;
    color: #fff;
    margin-bottom: 12px;
}
button {
    width: 100%;
    padding: 12px;
    border: none;
    border-radius: 10px;
    font-weight: bold;
    cursor: pointer;
}
.btn-primary { background: #4caf50; color: #000; }
.btn-ghost { background: #0b0b0b; border: 1px solid #555; color: #b4d2a4; }

#msgArea { padding:10px; margin-top:10px; border-radius:8px; text-align:center; font-weight:bold; }
.msg.ok { background:#28a745; color:#fff; }
.msg.err { background:#e03a3a; color:#fff; }

#log {
    background:#080808;
    padding:10px;
    border-radius:8px;
    color:#b4d2a4;
    max-height:200px;
    overflow:auto;
    margin-top:10px;
    font-size:13px;
}

/* Painel Admin */
#adminPanel { background:#0a2c0a; padding:15px; border-radius:10px; margin-top:15px; }
#adminPanel h3 { margin-top:0; color:#d1f4b4; }
.userRow { display:flex; justify-content: space-between; align-items:center; padding:6px 0; border-bottom:1px solid #222; }
.userRow button { width:auto; padding:6px 10px; font-size:12px; margin-left:5px; }
</style>
</head>

<body>
<header>ðŸ“¡ ESIP â€“ Sistema Militar / Operacional</header>
<div class="container">

<!-- LOGIN -->
<div class="card" id="loginCard">
<label>UsuÃ¡rio</label>
<input type="text" id="username" placeholder="Digite seu usuÃ¡rio">
<label>Senha</label>
<input type="password" id="password" placeholder="Digite sua senha">
<button class="btn-primary" onclick="login()">Entrar</button>
<small>UsuÃ¡rio admin inicial: <b>sim</b> | Senha: <b>ESIP123</b></small>
<br><br>
<button class="btn-ghost" onclick="forgotPassword()">Esqueci minha senha</button>
<div id="msgArea"></div>
</div>

<!-- PAINEL PRINCIPAL -->
<div class="card hidden" id="mainCard">
<h3>Bem-vindo, <span id="userDisplay"></span></h3>
<div id="userControls">
<button class="btn-primary" onclick="showAdminPanel()">Painel Admin</button>
<button class="btn-ghost" onclick="logout()">Sair</button>
</div>

<div id="adminPanel" class="hidden">
<h3>Painel Administrativo</h3>
<div id="userList"></div>
<button class="btn-primary" onclick="addNewUser()">Adicionar Novo UsuÃ¡rio</button>
</div>
</div>

</div>

<script>
/* ===============================
   UTILIDADES DE CRIPTOGRAFIA
   SHA-256 + HEX
=============================== */
async function hashString(str) {
    const encoder = new TextEncoder();
    const data = encoder.encode(str);
    const hashBuffer = await crypto.subtle.digest('SHA-256', data);
    return Array.from(new Uint8Array(hashBuffer))
        .map(b => b.toString(16).padStart(2,'0')).join('');
}

/* ===============================
   BANCO DE DADOS INDEXEDDB
=============================== */
let db;
const DB_NAME = "ESIP_DB";
const STORE_NAME = "users";
let dbReady = false;

function initDB(){
    const request = indexedDB.open(DB_NAME,1);
    request.onupgradeneeded = e=>{
        db = e.target.result;
        if(!db.objectStoreNames.contains(STORE_NAME)){
            const store = db.createObjectStore(STORE_NAME,{keyPath:'username'});
        }
    };
    request.onsuccess = e=>{
        db = e.target.result;
        dbReady = true;
        initAdmin();
    };
    request.onerror = ()=> alert('Erro ao iniciar banco de dados');
}

/* ===============================
   ADMIN PADRÃƒO
=============================== */
async function initAdmin(){
    const tx = db.transaction([STORE_NAME],'readwrite');
    const store = tx.objectStore(STORE_NAME);
    const getReq = store.get('sim');
    getReq.onsuccess = async ()=>{
        if(!getReq.result){
            const admin = {
                username:'sim',
                password:await hashString('ESIP123'),
                pin:await hashString('ADM123'),
                attempts:0,
                blocked:false
            };
            store.put(admin);
        }
    };
}

/* ===============================
   LOGIN
=============================== */
async function login(){
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value;
    if(!username || !password){ showMsg('Preencha todos os campos',false); return; }
    if(!dbReady){ showMsg('Banco nÃ£o inicializado',false); return; }

    const tx = db.transaction([STORE_NAME],'readwrite');
    const store = tx.objectStore(STORE_NAME);
    const req = store.get(username);
    req.onsuccess = async ()=>{
        const user = req.result;
        if(!user){ showMsg('UsuÃ¡rio nÃ£o encontrado',false); return; }
        if(user.blocked){ showMsg('UsuÃ¡rio bloqueado. Admin deve desbloquear.',false); return; }
        const hashed = await hashString(password);
        if(hashed !== user.password){
            user.attempts++;
            if(user.attempts >=5){
                user.blocked = true;
                showMsg('MÃ¡ximo de tentativas atingido. Admin deve desbloquear.',false);
            } else {
                showMsg(`Senha incorreta. Tentativas restantes: ${5-user.attempts}`,false);
            }
            store.put(user);
            return;
        }
        // LOGIN CORRETO
        user.attempts=0;
        store.put(user);
        document.getElementById('loginCard').classList.add('hidden');
        document.getElementById('mainCard').classList.remove('hidden');
        document.getElementById('userDisplay').innerText = username;
        loadUsers(); // carrega lista de usuÃ¡rios para admin
    };
}

/* ===============================
   LOGOUT
=============================== */
function logout(){
    document.getElementById('mainCard').classList.add('hidden');
    document.getElementById('loginCard').classList.remove('hidden');
    document.getElementById('username').value='';
    document.getElementById('password').value='';
    document.getElementById('adminPanel').classList.add('hidden');
}

/* ===============================
   FUNÃ‡Ã•ES ADMIN
=============================== */
function showAdminPanel(){
    document.getElementById('adminPanel').classList.toggle('hidden');
    loadUsers();
}

function loadUsers(){
    const userListDiv = document.getElementById('userList');
    userListDiv.innerHTML='';
    const tx = db.transaction([STORE_NAME],'readonly');
    const store = tx.objectStore(STORE_NAME);
    store.openCursor().onsuccess = function(e){
        const cursor = e.target.result;
        if(cursor){
            const u = cursor.value;
            const div = document.createElement('div');
            div.className='userRow';
            div.innerHTML=`<span>${u.username} ${u.blocked?'(Bloqueado)':''}</span>`;
            // BotÃµes admin
            if(u.username!=='sim'){
                const btnResetPwd = document.createElement('button');
                btnResetPwd.innerText='Resetar Senha';
                btnResetPwd.onclick=()=>resetPassword(u.username);
                const btnResetPin = document.createElement('button');
                btnResetPin.innerText='Resetar PIN';
                btnResetPin.onclick=()=>resetPin(u.username);
                const btnDelete = document.createElement('button');
                btnDelete.innerText='Excluir';
                btnDelete.onclick=()=>deleteUser(u.username);
                div.appendChild(btnResetPwd);
                div.appendChild(btnResetPin);
                div.appendChild(btnDelete);
            }
            userListDiv.appendChild(div);
            cursor.continue();
        }
    };
}

async function addNewUser(){
    const username = prompt('Nome do novo usuÃ¡rio:');
    if(!username) return;
    const tx = db.transaction([STORE_NAME],'readwrite');
    const store = tx.objectStore(STORE_NAME);
    const exists = await new Promise(resolve=>{
        const r = store.get(username);
        r.onsuccess=()=>resolve(r.result);
    });
    if(exists){ alert('UsuÃ¡rio jÃ¡ existe'); return; }
    const pwd = prompt('Senha inicial do usuÃ¡rio:');
    const pin = prompt('PIN de recuperaÃ§Ã£o (letras/nÃºmeros):');
    if(!pwd || !pin) return;
    store.put({
        username,
        password:await hashString(pwd),
        pin:await hashString(pin),
        attempts:0,
        blocked:false
    });
    loadUsers();
}

async function resetPassword(username){
    const tx = db.transaction([STORE_NAME],'readwrite');
    const store = tx.objectStore(STORE_NAME);
    const req = store.get(username);
    req.onsuccess=async ()=>{
        const newPwd = prompt(`Nova senha para ${username}:`);
        if(!newPwd) return;
        const user = req.result;
        user.password = await hashString(newPwd);
        store.put(user);
        alert('Senha resetada!');
    };
}

async function resetPin(username){
    const tx = db.transaction([STORE_NAME],'readwrite');
    const store = tx.objectStore(STORE_NAME);
    const req = store.get(username);
    req.onsuccess=async ()=>{
        const newPin = prompt(`Novo PIN para ${username}:`);
        if(!newPin) return;
        const user = req.result;
        user.pin = await hashString(newPin);
        store.put(user);
        alert('PIN resetado!');
    };
}

function deleteUser(username){
    if(confirm(`Deseja realmente excluir ${username}?`)){
        const tx = db.transaction([STORE_NAME],'readwrite');
        tx.objectStore(STORE_NAME).delete(username);
        tx.oncomplete=()=>loadUsers();
    }
}

/* ===============================
   RECUPERAÃ‡ÃƒO DE SENHA VIA PIN
=============================== */
async function forgotPassword(){
    const username = prompt('Digite seu usuÃ¡rio:');
    if(!username) return;
    const tx = db.transaction([STORE_NAME],'readwrite');
    const store = tx.objectStore(STORE_NAME);
    const req = store.get(username);
    req.onsuccess=async ()=>{
        const user = req.result;
        if(!user){ alert('UsuÃ¡rio nÃ£o encontrado'); return; }
        const pin = prompt('Digite seu PIN de recuperaÃ§Ã£o:');
        const hashedPin = await hashString(pin);
        if(hashedPin!==user.pin){ alert('PIN incorreto'); return; }
        const newPwd = prompt('Digite sua nova senha:');
        if(!newPwd) return;
        user.password = await hashString(newPwd);
        user.attempts=0;
        user.blocked=false;
        store.put(user);
        alert('Senha alterada com sucesso!');
    };
}

/* ===============================
   MENSAGENS
=============================== */
function showMsg(msg,ok){
    const area = document.getElementById('msgArea');
    area.className = ok ? 'msg ok' : 'msg err';
    area.innerText=msg;
}

/* ===============================
   BLOQUEIO TECLAS E INSPEÃ‡ÃƒO
=============================== */
document.addEventListener("contextmenu",e=>e.preventDefault());
document.onkeydown=function(e){if(e.ctrlKey&&(e.key==="u"||e.key==="s"||e.key==="c"))return false;}

/* ===============================
   INICIALIZAÃ‡ÃƒO
=============================== */
initDB();
</script>
</body>
</html>

