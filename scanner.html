
<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Gerador de Or√ßamento ‚Äî ESIP-Sistemas</title>

<!-- jsPDF (PDF gera√ß√£o) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
  :root{
    --navy:#001F3F;
    --accent:#0a7cff;
  }
  body{font-family:Inter, Arial, sans-serif;margin:0;background:#f3f6fa;color:#222;}
  .wrap{max-width:980px;margin:30px auto;padding:20px;}
  header{background:var(--navy);color:white;padding:18px;border-radius:10px;}
  header h1{margin:0;font-size:20px}
  .grid{display:grid;grid-template-columns:1fr 360px;gap:18px;margin-top:18px}
  .card{background:white;padding:16px;border-radius:10px;box-shadow:0 6px 20px rgba(2,12,36,0.06)}
  label{display:block;font-weight:600;margin-top:10px;color:var(--navy)}
  input[type=text], input[type=number], textarea, select{width:100%;padding:10px;border-radius:8px;border:1px solid #d7e2f5;margin-top:6px;font-size:14px}
  .small{font-size:13px;color:#4b6078}
  .btn{display:inline-block;padding:10px 14px;border-radius:10px;border:0;background:var(--navy);color:white;font-weight:700;cursor:pointer}
  .btn.secondary{background:#fff;color:var(--navy);border:1px solid var(--navy)}
  .items-table{width:100%;border-collapse:collapse;margin-top:10px}
  .items-table th, .items-table td{padding:8px;border-bottom:1px solid #eef3fb;text-align:left;font-size:14px}
  .items-controls{display:flex;gap:8px;margin-top:10px}
  .text-right{text-align:right}
  .logo-preview{max-width:100%;height:80px;object-fit:contain;border-radius:6px;border:1px solid #eef3fb;padding:6px;background:#fff}
  footer{margin-top:14px;font-size:13px;color:#5b6b80}
  .row{display:flex;gap:8px}
  @media(max-width:920px){
    .grid{grid-template-columns:1fr}
    .logo-preview{height:64px}
  }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div style="display:flex;align-items:center;gap:12px">
        <div>
          <!-- default placeholder logo (you can replace) -->
          <img id="logoMini" src="" alt="logo" style="height:44px;display:none">
        </div>
        <div>
          <h1>üì° ESIP-Sistemas ‚Äî Gerador de Or√ßamento</h1>
          <div class="small">Crie or√ßamentos com seu logo e baixe o PDF imediatamente.</div>
        </div>
      </div>
    </header>

    <div class="grid">
      <!-- LEFT: form -->
      <div>
        <div class="card">
          <h3>Dados do Or√ßamento</h3>

          <label>Seu nome / Empresa</label>
          <input type="text" id="yourName" value="ESIP-Sistemas">

          <label>Seu e-mail</label>
          <input type="text" id="yourEmail" value="email@exemplo.com">

          <label>Seu WhatsApp (para contato)</label>
          <input type="text" id="yourWhats" value="62 99492-1159">

          <hr style="margin:12px 0;border:none;border-top:1px solid #eef3fb">

          <label>Cliente</label>
          <input type="text" id="clientName" placeholder="Nome da empresa / Cliente">

          <label>Projeto / Descri√ß√£o curta</label>
          <input type="text" id="projectTitle" placeholder="Ex: Sistema para Cl√≠nicas - Or√ßamento">

          <label>Validade do or√ßamento</label>
          <input type="text" id="validity" value="15 dias">

          <label>Observa√ß√µes (opcional)</label>
          <textarea id="notes" placeholder="Ex: Pagamento 50% sinal, 50% entrega"></textarea>

          <h4 style="margin-top:14px">Itens do Or√ßamento</h4>

          <table class="items-table" id="itemsTable">
            <thead>
              <tr><th>Descri√ß√£o</th><th style="width:110px">Qtd</th><th style="width:140px">Pre√ßo unit. (R$)</th><th style="width:140px">Subtotal (R$)</th></tr>
            </thead>
            <tbody id="itemsBody">
              <!-- rows inserted dynamically -->
            </tbody>
          </table>

          <div class="items-controls">
            <button class="btn secondary" onclick="addItem()">+ Adicionar item</button>
            <button class="btn secondary" onclick="clearItems()">Limpar itens</button>
          </div>

          <div style="margin-top:12px;display:flex;gap:8px">
            <div style="flex:1">
              <label>Desconto (R$)</label>
              <input type="number" id="discount" value="0" min="0" step="0.01" oninput="recalc()">
            </div>
            <div style="width:160px">
              <label>Imposto (%)</label>
              <input type="number" id="taxRate" value="0" min="0" step="0.1" oninput="recalc()">
            </div>
          </div>

          <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
            <button class="btn" onclick="generatePDF()">Gerar PDF</button>
            <button class="btn" onclick="downloadPDF()" style="background:#0a7cff">Baixar PDF</button>
            <button class="btn secondary" onclick="openWhatsApp()" style="background:#25d366;color:white;border:none">Enviar no WhatsApp</button>
          </div>

          <footer>
            <div><strong>Instru√ß√£o:</strong> gere o PDF e envie pelo WhatsApp ao cliente. O bot√£o WhatsApp prepara a mensagem para voc√™.</div>
          </footer>
        </div>
      </div>

      <!-- RIGHT: logo and resumo -->
      <div>
        <div class="card">
          <h3>Sua Marca</h3>
          <label>Carregar logo (PNG/JPG)</label>
          <input type="file" id="logoInput" accept="image/*" onchange="loadLogo(event)">
          <div style="margin-top:12px">
            <img id="logoPreview" class="logo-preview" src="" alt="preview" style="display:none">
          </div>

          <hr style="margin:12px 0;border:none;border-top:1px solid #eef3fb">

          <h3>Resumo</h3>
          <div style="display:flex;flex-direction:column;gap:8px">
            <div><strong>Subtotal:</strong> R$ <span id="summarySubtotal">0.00</span></div>
            <div><strong>Imposto:</strong> R$ <span id="summaryTax">0.00</span></div>
            <div><strong>Desconto:</strong> R$ <span id="summaryDiscount">0.00</span></div>
            <div style="font-size:18px"><strong>Total: R$ <span id="summaryTotal">0.00</span></strong></div>
          </div>
        </div>

        <div style="height:18px"></div>

        <div class="card">
          <h3>Modelo de Mensagem</h3>
          <label>Texto enviado no WhatsApp</label>
          <textarea id="waMessage" style="height:110px">Ol√°! Envio em anexo o or√ßamento solicitado. Qualquer d√∫vida me chame por aqui: (62) 99492-1159</textarea>
        </div>
      </div>
    </div>
  </div>

<script>
  // state
  let items = [];

  // init with one item
  addItem();

  function addItem(desc = '', qty = 1, price = 0){
    items.push({desc, qty: Number(qty), price: Number(price)});
    renderItems();
  }

  function clearItems(){
    items = [];
    addItem();
    recalc();
  }

  function removeItem(index){
    items.splice(index,1);
    renderItems();
  }

  function renderItems(){
    const tbody = document.getElementById('itemsBody');
    tbody.innerHTML = '';
    items.forEach((it, i) => {
      const tr = document.createElement('tr');

      // description
      const tdDesc = document.createElement('td');
      const inpDesc = document.createElement('input');
      inpDesc.type = 'text';
      inpDesc.value = it.desc;
      inpDesc.placeholder = 'Descri√ß√£o do item/servi√ßo';
      inpDesc.oninput = e => { items[i].desc = e.target.value; }
      inpDesc.style.width = '100%';
      inpDesc.style.padding='6px';
      inpDesc.style.border='1px solid #eef3fb';
      tdDesc.appendChild(inpDesc);

      // qty
      const tdQty = document.createElement('td');
      const inpQty = document.createElement('input');
      inpQty.type = 'number'; inpQty.min = 1; inpQty.value = it.qty;
      inpQty.oninput = e => { items[i].qty = Number(e.target.value); recalc(); }
      inpQty.style.width='100%'; inpQty.style.padding='6px'; inpQty.style.border='1px solid #eef3fb';
      tdQty.appendChild(inpQty);

      // price
      const tdPrice = document.createElement('td');
      const inpPrice = document.createElement('input');
      inpPrice.type = 'number'; inpPrice.min = 0; inpPrice.step='0.01'; inpPrice.value = it.price.toFixed(2);
      inpPrice.oninput = e => { items[i].price = Number(e.target.value); recalc(); }
      inpPrice.style.width='100%'; inpPrice.style.padding='6px'; inpPrice.style.border='1px solid #eef3fb';
      tdPrice.appendChild(inpPrice);

      // subtotal
      const tdSub = document.createElement('td');
      tdSub.className = 'text-right';
      tdSub.innerText = 'R$ ' + (items[i].qty * items[i].price).toFixed(2);

      // actions: remove
      const tdAct = document.createElement('td');
      tdAct.style.width='40px';
      const btnRem = document.createElement('button');
      btnRem.className = 'btn secondary';
      btnRem.style.padding='6px 8px';
      btnRem.innerText = 'x';
      btnRem.onclick = () => removeItem(i);
      tdAct.appendChild(btnRem);

      tr.appendChild(tdDesc);
      tr.appendChild(tdQty);
      tr.appendChild(tdPrice);
      tr.appendChild(tdSub);
      tr.appendChild(tdAct);

      tbody.appendChild(tr);
    });

    recalc();
  }

  function recalc(){
    const subtotal = items.reduce((s,it)=> s + (it.qty * it.price), 0);
    const discount = Number(document.getElementById('discount').value || 0);
    const taxRate = Number(document.getElementById('taxRate').value || 0);
    const tax = ((subtotal - discount) * taxRate / 100);
    const total = Math.max(0, subtotal - discount + tax);

    document.getElementById('summarySubtotal').innerText = subtotal.toFixed(2);
    document.getElementById('summaryTax').innerText = tax.toFixed(2);
    document.getElementById('summaryDiscount').innerText = discount.toFixed(2);
    document.getElementById('summaryTotal').innerText = total.toFixed(2);

    // update subtotals in table
    const tbody = document.getElementById('itemsBody');
    Array.from(tbody.children).forEach((tr, i) => {
      const sub = (items[i].qty * items[i].price).toFixed(2);
      tr.children[3].innerText = 'R$ ' + sub;
    });
  }

  // logo handling
  let logoDataUrl = '';
  function loadLogo(e){
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
      logoDataUrl = ev.target.result;
      const img = document.getElementById('logoPreview');
      img.src = logoDataUrl;
      img.style.display = 'block';
      const mini = document.getElementById('logoMini');
      mini.src = logoDataUrl; mini.style.display = 'block';
    };
    reader.readAsDataURL(file);
  }

  // PDF generation helpers
  let lastPdfBlob = null; // keep generated PDF

  async function generatePDF(){
    // use jsPDF
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({unit:'pt', format:'a4'}); // points

    const margin = 40;
    let y = margin;

    // draw logo if exists
    if(logoDataUrl){
      // addImage expects base64 dataURL
      try{
        doc.addImage(logoDataUrl, 'JPEG', margin, y, 100, 40);
      }catch(e){
        try{ doc.addImage(logoDataUrl, 'PNG', margin, y, 100, 40);}catch(err){console.warn('logo add err',err)}
      }
    }

    // title (company)
    doc.setFontSize(18);
    doc.setTextColor('#001F3F');
    doc.text(String(document.getElementById('yourName').value || 'ESIP-Sistemas'), margin + (logoDataUrl?110:0), y + 14);

    // contact
    doc.setFontSize(10);
    doc.setTextColor('#333');
    const contact = `WhatsApp: ${document.getElementById('yourWhats').value || ''}  ‚Ä¢  ${document.getElementById('yourEmail').value || ''}`;
    doc.text(contact, margin + (logoDataUrl?110:0), y + 32);

    y += 60;

    // client & project
    doc.setFontSize(12);
    doc.setTextColor('#001F3F');
    doc.text('Or√ßamento para:', margin, y);
    doc.setFontSize(11);
    doc.setTextColor('#333');
    doc.text(String(document.getElementById('clientName').value || '-'), margin + 100, y);

    y += 18;
    doc.setFontSize(12);
    doc.setTextColor('#001F3F');
    doc.text('Projeto:', margin, y);
    doc.setFontSize(11);
    doc.setTextColor('#333');
    doc.text(String(document.getElementById('projectTitle').value || '-'), margin + 70, y);

    y += 26;

    // items table header
    doc.setDrawColor(220);
    doc.setFillColor(245,247,250);
    doc.rect(margin-2, y-6, 520, 22, 'F');
    doc.setFontSize(11);
    doc.setTextColor('#001F3F');
    doc.text('Descri√ß√£o', margin+4, y+10);
    doc.text('Qtd', margin+300, y+10);
    doc.text('Unit (R$)', margin+360, y+10);
    doc.text('Subtotal (R$)', margin+450, y+10);

    y += 28;

    // items
    doc.setFontSize(11);
    doc.setTextColor('#222');
    const lineHeight = 16;
    items.forEach((it, idx) => {
      const desc = String(it.desc || '');
      // wrap description if long
      const splitDesc = doc.splitTextToSize(desc, 270);
      doc.text(splitDesc, margin+4, y);
      doc.text(String(it.qty), margin+300, y);
      doc.text(Number(it.price).toFixed(2), margin+360, y);
      doc.text((it.qty * it.price).toFixed(2), margin+450, y);
      y += Math.max(lineHeight * splitDesc.length, lineHeight);
      // if page overflow
      if(y > 750){
        doc.addPage();
        y = margin;
      }
    });

    y += 10;
    // totals
    const subtotal = Number(document.getElementById('summarySubtotal').innerText || 0);
    const tax = Number(document.getElementById('summaryTax').innerText || 0);
    const discount = Number(document.getElementById('summaryDiscount').innerText || 0);
    const total = Number(document.getElementById('summaryTotal').innerText || 0);

    doc.setFontSize(11);
    doc.text(`Subtotal: R$ ${subtotal.toFixed(2)}`, margin+350, y);
    y += 18;
    doc.text(`Imposto: R$ ${tax.toFixed(2)}`, margin+350, y);
    y += 18;
    doc.text(`Desconto: R$ ${discount.toFixed(2)}`, margin+350, y);
    y += 18;
    doc.setFontSize(13);
    doc.setTextColor('#001F3F');
    doc.text(`Total: R$ ${total.toFixed(2)}`, margin+350, y);

    y += 28;
    // validity & notes
    doc.setFontSize(10);
    doc.setTextColor('#333');
    doc.text(`Validade do or√ßamento: ${document.getElementById('validity').value}`, margin, y);
    y += 16;
    doc.text('Observa√ß√µes:', margin, y);
    y += 14;
    const notes = String(document.getElementById('notes').value || '');
    const noteLines = doc.splitTextToSize(notes, 400);
    doc.setFontSize(10);
    doc.text(noteLines, margin, y);

    y += noteLines.length * 12 + 24;

    // footer / signature
    doc.setFontSize(11);
    doc.setTextColor('#001F3F');
    doc.text('Assinatura', margin, y);
    doc.setFontSize(10);
    doc.setTextColor('#333');
    doc.text(String(document.getElementById('yourName').value || ''), margin, y+16);

    // store blob
    const pdfBlob = doc.output('blob');
    lastPdfBlob = pdfBlob;

    // automatic open in new tab (download dialog in some browsers)
    const url = URL.createObjectURL(pdfBlob);
    window.open(url, '_blank');

    return pdfBlob;
  }

  // convenience: calls generatePDF and triggers download
  async function downloadPDF(){
    const blob = await generatePDF();
    const fileName = `Orcamento-${(document.getElementById('clientName').value||'cliente').replace(/\s+/g,'_')}.pdf`;
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = fileName;
    a.click();
    URL.revokeObjectURL(a.href);
  }

  function openWhatsApp(){
    // create short summary text and open wa.me with message
    const client = document.getElementById('clientName').value || '';
    const total = document.getElementById('summaryTotal').innerText || '0.00';
    const project = document.getElementById('projectTitle').value || '';
    const message = `üì° *ESIP - Or√ßamento*\n\nOl√° ${client}, segue um or√ßamento para: ${project}\n\nValor total: R$ ${total}\n\nEnvio em anexo (PDF). Qualquer d√∫vida estou √† disposi√ß√£o.\n\n${document.getElementById('yourWhats').value}`;
    const wa = `https://wa.me/55${document.getElementById('yourWhats').value.replace(/\D/g,'')}?text=${encodeURIComponent(message)}`;
    // generate PDF first (so user can attach after)
    generatePDF().then(()=> {
      window.open(wa, '_blank');
    });
  }
</script>
</body>
</html>
