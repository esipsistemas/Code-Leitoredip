<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ESIP - Leitor & Gerador QR</title>

<!-- QRCode.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<!-- html2canvas + jsPDF (para PDF) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<!-- Instascan (leitor QR) -->
<script src="https://rawcdn.githack.com/schmich/instascan-builds/master/instascan.min.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: #f3f3f3;
  margin: 0;
  padding: 0;
  text-align: center;
}
section {
  background: #fff;
  margin: 20px;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}
button {
  background: #007bff;
  color: #fff;
  padding: 12px 20px;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  margin: 10px 0;
  cursor: pointer;
  width: 90%;
}
button:hover {
  background: #005ec5;
}
#preview-video {
  width: 100%;
  border-radius: 12px;
}
#qrcode {
  margin-top: 20px;
}
.voltar {
  background: #28a745;
}
</style>
</head>
<body>

<h2>üì° ESIP - Leitor e Gerador de QR Code</h2>

<!-- ================= LEITOR QR ================= -->
<section>
<h3>üì≤ Leitor de QR Code</h3>

<video id="preview-video"></video>

<button onclick="startScanner()">Iniciar Leitor</button>
<button onclick="toggleFlash()">Ligar / Desligar Lanterna</button>

<p id="result"></p>
</section>

<!-- ================ GERADOR QR ================= -->
<section>
<h3>üßæ Gerar QR Code</h3>

<input id="qrText" type="text" placeholder="Digite o texto ou link" style="width:90%;padding:10px;border-radius:8px;border:1px solid #ccc;">

<button onclick="gerarQR()">Gerar QR</button>

<div id="qrcode"></div>

<button onclick="baixarPDF()">Baixar Em PDF</button>
</section>

<!-- =========== BOT√ÉO VOLTAR PARA PRINCIPAL ========== -->
<section>
<a href="https://sites.google.com/site/esipseguranca">
<button class="voltar">‚¨ÖÔ∏è VOLTAR PARA PRINCIPAL</button>
</a>
</section>

<script>
/* ==================== LEITOR QR ==================== */
let scanner;
let torchOn = false;
let track;

function startScanner() {
  scanner = new Instascan.Scanner({ video: document.getElementById('preview-video'), mirror: false });
  scanner.addListener('scan', content => {
    document.getElementById('result').innerHTML = "RESULTADO: " + content;
  });

  Instascan.Camera.getCameras().then(function (cameras) {
    if (cameras.length > 0) {
      scanner.start(cameras[0]);

      track = scanner.video.srcObject.getVideoTracks()[0];
    } else {
      alert('Nenhuma c√¢mera encontrada');
    }
  });
}

function toggleFlash() {
  if (!track) return alert("Ative o leitor primeiro.");

  const capabilities = track.getCapabilities();
  if (!capabilities.torch) return alert("Seu celular n√£o suporta lanterna pelo navegador.");

  torchOn = !torchOn;
  track.applyConstraints({
    advanced: [{ torch: torchOn }]
  });
}

/* ==================== GERADOR QR ==================== */
function gerarQR() {
  let texto = document.getElementById("qrText").value;
  if (texto.trim() === "") return alert("Digite algo antes!");

  document.getElementById("qrcode").innerHTML = "";

  new QRCode(document.getElementById("qrcode"), {
    text: texto,
    width: 256,
    height: 256
  });
}

/* ==================== GERAR PDF ==================== */
async function baixarPDF() {
  const qrcodeElement = document.getElementById("qrcode");

  if (!qrcodeElement.innerHTML.trim()) {
    return alert("Gere um QR Code antes!");
  }

  const canvas = await html2canvas(qrcodeElement);
  const imgData = canvas.toDataURL("image/png");

  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();

  pdf.addImage(imgData, "PNG", 20, 20, 170, 170);
  pdf.save("QRCode-ESIP.pdf");
}
</script>

</body>
</html>

