<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Leitor ESIP ‚Äî Pro+ Vermelho</title>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

  <style>
    body{margin:0;font-family:Arial;background:#290000;color:#ffeaea;transition:background .4s ease,color .4s ease}
    body.dark{background:#000;color:#fff}
    header{background:#8b0000;color:#fff;padding:14px 20px;display:flex;align-items:center;gap:12px;box-shadow:0 2px 8px #0004}
    header h1{margin:0;font-size:22px}
    .box{background:#ffffff15;padding:18px;margin:20px auto;border-radius:14px;max-width:430px;box-shadow:0 4px 14px #0003;backdrop-filter:blur(6px);color:#fff}
    input{width:100%;padding:12px;border-radius:10px;border:none;font-size:16px;margin-top:8px}
    button{padding:12px 18px;border:none;border-radius:12px;font-size:17px;cursor:pointer;transition:transform .15s ease, box-shadow .15s ease}
    button:active{transform:scale(.94);box-shadow:0 0 12px #0005 inset}
    .ok{background:#ff0000;color:#fff}
    .err{background:#990000;color:#fff}
    .floatBtn{position:fixed;bottom:20px;right:20px;background:#ff0000;padding:18px;border-radius:50%;box-shadow:0 4px 15px #0006;font-size:24px;z-index:999}
    .msg{padding:14px;margin-top:14px;border-radius:8px;display:flex;justify-content:space-between;align-items:center;font-weight:bold}
    .valid{background:#0e8f4f;color:#fff}
    .invalid{background:#a00000;color:#fff}
    #logBox{margin-top:20px;font-size:14px;max-height:160px;overflow:auto;background:#ffffff10;padding:12px;border-radius:8px;box-shadow:0 1px 4px #0003}
    .counterBox{background:#ffffff15;padding:12px;border-radius:10px;margin-top:15px;font-weight:bold;text-align:center;color:#fff;box-shadow:0 1px 4px #0003}
  </style>
</head>
<body>

<!-- LOGIN ESIP -->
<div id="loginBox" style="text-align:center;margin-top:40px;">
  <h2>üîê Login do Operador</h2>
  <p>Digite a senha para acessar o leitor:</p>
  <input id="senha" type="password" placeholder="Senha" style="padding:12px;font-size:18px;border-radius:8px;border:none;width:80%;max-width:320px;">
  <br><br>
  <button onclick="login()" style="padding:12px 30px;font-size:18px;border-radius:8px;border:none;background:#03a9f4;color:#fff;cursor:pointer;">Entrar</button>
</div>

<script>
function login(){
  const senha = document.getElementById("senha").value.trim();
  if(senha === "ESIP2025"){
      document.getElementById("loginBox").style.display = "none";
      const scan = document.getElementById("scanBox");
      if(scan) scan.style.display = "block";
      if(typeof startScanner === 'function') startScanner();
  } else {
      alert("Senha incorreta!");
  }
}
</script>


<header>
  <h1>üì° ESIP-Sistemas ‚Äî Leitor Pro+ Vermelho</h1>
</header>

<!-- LOGIN RESTAURADO -->
<div class="box" id="loginBox">
  <h2>Login</h2>
  <p>Digite a senha:</p>
  <input id="senha" type="password">
  <button class="ok" style="margin-top:14px;width:100%" onclick="login()">Entrar</button>
</div>

<div class="box" id="scanBox" style="display:none">
  <h2>Scanner</h2>
  <div id="reader" style="width:100%"></div>
  <button id="btnFlash" class="ok" style="margin-top:12px;width:100%" onclick="toggleFlash()">üî¶ Ligar Lanterna</button>
  <div class="counterBox">Entradas v√°lidas: <span id="contador">0</span></div>
  <div id="msgArea"></div>
  <h3>Log de entradas</h3>
  <div id="logBox"></div>
  <button class="ok" style="margin-top:10px;width:100%" onclick="exportCSV()">Exportar CSV</button>
  <button class="err" style="margin-top:10px;width:100%" onclick="limparLog()">Limpar Log</button>
</div>

<button class="floatBtn" onclick="toggleDarkMode()">üåì</button>

<audio id="somOk" src="https://cdn.pixabay.com/download/audio/2023/06/29/audio_25c0700121.mp3?filename=success-158310.mp3"></audio>
<audio id="somErro" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_4e6261a0ef.mp3?filename=error-126627.mp3"></audio>

<script>
let used = new Set();
let cooldown = false;
let log = [];
let countValid = 0;
let cameraTrack = null;
let flashOn = false;

function login(){
  const senha = document.getElementById("senha").value.trim();
  if(senha === "ESIP2025"){
    document.getElementById("loginBox").style.display = "none";
    document.getElementById("scanBox").style.display = "block";
    setTimeout(startScanner, 300);
  } else {
    alert("Senha incorreta!");
  }
}

function startScanner(){
  const qr = new Html5Qrcode("reader");

  Html5Qrcode.getCameras().then(cams=>{
    if(cams && cams.length){

      let frontal = cams.find(c =>
          c.label.toLowerCase().includes("front") ||
          c.label.toLowerCase().includes("frontal") ||
          c.label.toLowerCase().includes("selfie") ||
          c.label.toLowerCase().includes("user")
      );

      let camUse = frontal ? frontal.id : cams[cams.length - 1].id;

      qr.start(
        camUse,
        {fps:10, qrbox:250},
        (text)=>{
          if(cooldown) return;
          cooldown = true;
          setTimeout(()=>cooldown=false, 1500);
          processQR(text);
        }
      ).then(()=>{
        const stream = document.querySelector('video').srcObject;
        if(stream){ cameraTrack = stream.getVideoTracks()[0]; }
      }).catch(()=>{
        alert("Erro ao iniciar c√¢mera.");
      });
    }
  });
}

function toggleFlash(){
  if(!cameraTrack){ alert("A c√¢mera ainda n√£o carregou."); return; }

  flashOn = !flashOn;
  cameraTrack.applyConstraints({advanced:[{torch: flashOn}]}).catch(()=>{
    alert("Lanterna n√£o suportada neste dispositivo.");
    flashOn = false;
  });

  document.getElementById("btnFlash").innerText = flashOn ? "üî¶ Desligar Lanterna" : "üî¶ Ligar Lanterna";
}

function processQR(code){
  if(document.querySelector(".msg")) return;

  const somOk = document.getElementById("somOk");
  const somErro = document.getElementById("somErro");

  if(!code.startsWith("ESIP")){
    somErro.play();
    navigator.vibrate(200);
    return showMessage("QR INV√ÅLIDO", false);
  }

  if(used.has(code)){
    somErro.play();
    navigator.vibrate(200);
    return showMessage("INGRESSO J√Å UTILIZADO", false);
  }

  used.add(code);
  countValid++;
  document.getElementById("contador").innerText = countValid;

  somOk.play();
  navigator.vibrate([80,50,80]);

  showMessage("Ingresso v√°lido", true);

  log.push({codigo:code, status:"v√°lido", hora:new Date().toLocaleString()});
  updateLogBox();
}

function showMessage(text, ok){
  const area = document.getElementById("msgArea");
  area.innerHTML = `
    <div class="msg ${ok?"valid":"invalid"}">
      <span>${text}</span>
      <button style="background:none;border:none;font-size:20px;color:#fff;cursor:pointer" onclick="this.parentElement.remove()">√ó</button>
    </div>`;
}

function updateLogBox(){
  let html = "";
  log.slice().reverse().forEach(l=>{
    html += `<div><b>${l.status}</b> ‚Äî ${l.codigo}<br><small>${l.hora}</small></div><hr>`;
  });
  document.getElementById("logBox").innerHTML = html;
}

function limparLog(){
  if(confirm("Tem certeza que deseja limpar o log?")){
    log = [];
    document.getElementById("logBox").innerHTML = "";
  }
}

function exportCSV(){
  let csv = "codigo,status,hora
";
  log.forEach(l=> csv += `${l.codigo},${l.status},${l.hora}
`);

  const blob = new Blob([csv], {type:"text/csv"});
  const url = URL.createObjectURL(blob);
