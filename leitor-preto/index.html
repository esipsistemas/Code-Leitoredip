<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ðŸ“¡ ESIP â€” Leitor Black Premium + Painel Admin</title>

<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body {margin:0;font-family:Arial;background:#000;color:#ccc;}
header {background:#0c0c0c;padding:15px;color:#ffd700;font-weight:bold;text-align:center;font-size:18px;}
.container {max-width:900px;margin:auto;padding:20px;}
.card {background:#111;padding:18px;border-radius:10px;margin-bottom:20px;border:1px solid #222;}
input, select {width:100%;padding:12px;border:none;border-radius:8px;background:#0a0a0a;color:#fff;margin-bottom:12px;}
button {width:100%;padding:12px;border:none;border-radius:10px;font-weight:bold;cursor:pointer;margin-bottom:8px;}
.btn-primary {background:#ffd700;color:#000;}
.btn-ghost {background:#000;border:1px solid #333;color:#bbb;}
#reader {width:100%;height:340px;background:#000;border-radius:12px;}
.msg {padding:10px;margin-top:10px;border-radius:8px;text-align:center;font-weight:bold;}
.ok {background:#28a745;color:#fff;}
.err {background:#e03a3a;color:#fff;}
#log {background:#080808;padding:10px;border-radius:8px;color:#bbb;max-height:200px;overflow:auto;margin-top:10px;font-size:13px;}
table {width:100%;border-collapse:collapse;margin-top:20px;}
th,td {border-bottom:1px solid #333;padding:8px;text-align:left;}
th {color:#ffd700;}
.empty{text-align:center;color:#777;padding:20px;}
</style>
</head>
<body>

<header>ðŸ“¡ ESIP â€” Leitor Black Premium + Painel Admin</header>

<div class="container">

<!-- LEITOR -->
<div class="card" id="scanCard">
<h2>Leitor de QR Code</h2>
<div id="reader"></div>
<button id="flashBtn" class="btn-primary" onclick="toggleFlash()">ðŸ”¦ Lanterna</button>
<button class="btn-primary" onclick="switchCamera()">ðŸ“· Trocar cÃ¢mera</button>
<div style="background:#0c0c0c;padding:12px;border-radius:10px;margin-top:12px;color:#fff;text-align:center">
Entradas vÃ¡lidas: <b id="count">0</b>
</div>
<div id="msgArea"></div>
<div id="log"></div>
<button class="btn-primary" onclick="exportCSV()">Exportar CSV</button>
<button class="btn-ghost" onclick="clearLog()">Limpar Log</button>
</div>

<!-- PAINEL ADMIN -->
<div class="card">
<h2>Painel de Administrador</h2>
<label>Filtro CPF</label>
<input type="text" id="filtroCPF" placeholder="Digite CPF">
<label>Filtro Evento</label>
<input type="text" id="filtroEvento" placeholder="Nome do evento">
<button class="btn-primary" onclick="carregarPainel()">Aplicar Filtros</button>
<p id="contador">Total: 0</p>
<table>
<thead>
<tr><th>CPF</th><th>Evento</th><th>CÃ³digo QR</th><th>Data/Hora</th></tr>
</thead>
<tbody id="lista"></tbody>
</table>
<div id="vazio" class="empty">Nenhum ingresso gerado ainda.</div>
</div>

<audio id="okSound" src="https://cdn.pixabay.com/audio/2023/06/29/audio_25c0700121.mp3"></audio>
<audio id="errSound" src="https://cdn.pixabay.com/audio/2022/03/15/audio_4e6261a0ef.mp3"></audio>

<script>
/* =========================================================
   BANCO DE DADOS â€” IndexedDB
========================================================= */
let db;
const DB_NAME = "ESIP_LocalDB";
const STORE_NAME = "checkins";
let log = [];
let dbReady = false;

function initDB(callback){
  let req = indexedDB.open(DB_NAME,1);
  req.onupgradeneeded = function(e){
    db = e.target.result;
    if(!db.objectStoreNames.contains(STORE_NAME)){
      db.createObjectStore(STORE_NAME, { keyPath: "codigo" });
    }
  };
  req.onsuccess = function(e){
    db = e.target.result;
    dbReady = true;
    loadLog();
    if(callback) callback();
  };
  req.onerror = function(){ alert("Erro ao iniciar banco local"); };
}

function saveCheckin(data){
  if(!dbReady) return;
  let tx = db.transaction([STORE_NAME], "readwrite");
  tx.objectStore(STORE_NAME).put(data);
}

function getAllCheckins(callback){
  if(!dbReady) return;
  let tx = db.transaction([STORE_NAME], "readonly");
  let req = tx.objectStore(STORE_NAME).getAll();
  req.onsuccess = () => callback(req.result || []);
}

function clearDB(callback){
  if(!dbReady) return;
  let tx = db.transaction([STORE_NAME], "readwrite");
  tx.objectStore(STORE_NAME).clear().onsuccess = ()=>{ loadLog(); if(callback) callback(); };
}

/* =========================================================
   LEITOR DE QR CODE
========================================================= */
let html5Qr;
let cameraTrack = null;
let flashOn = false;
let cameras = [];
let currentCamIndex = 0;

function startScanner(){
  html5Qr = new Html5Qrcode("reader");
  Html5Qrcode.getCameras().then(camList=>{
    cameras=camList;
    currentCamIndex = cameras.findIndex(c=>c.label.toLowerCase().includes("back") || c.label.toLowerCase().includes("environment") || c.label.toLowerCase().includes("traseira"));
    if(currentCamIndex<0) currentCamIndex=0;
    startCamByIndex(currentCamIndex);
  }).catch(()=>alert("Nenhuma cÃ¢mera encontrada"));
}

async function startCamByIndex(i){
  try{ await html5Qr.stop(); }catch(e){}
  let camId = cameras[i].id;
  await html5Qr.start(camId, {fps:10, qrbox:260}, decoded => processQR(decoded));
  setTimeout(()=>{
    let v=document.querySelector("#reader video");
    if(v && v.srcObject) cameraTrack=v.srcObject.getVideoTracks()[0];
  },600);
}

function processQR(code){
  const okSound=document.getElementById("okSound");
  const errSound=document.getElementById("errSound");

  if(!code.toUpperCase().includes("ESIP")){
    errSound.play();
    return showTemporario("QR invÃ¡lido", false);
  }

  getAllCheckins(all=>{
    if(all.some(x=>x.codigo===code)){
      errSound.play();
      return showTemporario("JÃ USADO", false);
    }

    let row = { codigo: code, hora: new Date().toISOString() };
    log.push(row);
    saveCheckin(row);

    okSound.play();
    showTemporario("VÃLIDO", true);
    updateUIPanel();
  });
}

function showTemporario(msg, ok){
  const m=document.getElementById("msgArea");
  m.className=ok?"msg ok":"msg err";
  m.innerText=msg;
  setTimeout(()=>{ m.innerText=""; m.className=""; },2000);
}

function toggleFlash(){
  if(!cameraTrack) return alert("CÃ¢mera nÃ£o pronta");
  flashOn=!flashOn;
  if(cameraTrack.getCapabilities().torch){
    cameraTrack.applyConstraints({advanced:[{torch:flashOn}]}).catch(()=>{ flashOn=false; alert("Lanterna nÃ£o suportada");});
  } else { alert("Lanterna nÃ£o suportada"); flashOn=false; }
  document.getElementById("flashBtn").innerText=flashOn?"ðŸ”¦ Desligar":"ðŸ”¦ Lanterna";
}

function switchCamera(){
  if(!cameras.length) return;
  currentCamIndex=(currentCamIndex+1)%cameras.length;
  startCamByIndex(currentCamIndex)
