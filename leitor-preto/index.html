<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Leitor ESIP ‚Äî Pro+ Vermelho (Corrigido)</title>
  <!-- html5-qrcode (vers√£o fixa) -->
  <script src="https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js" type="text/javascript"></script>

  <style>
    body{margin:0;font-family:Arial;background:#290000;color:#ffeaea;transition:background .4s,color .4s}
    body.dark{background:#000;color:#fff}
    header{background:#8b0000;color:#fff;padding:14px 20px;display:flex;align-items:center;gap:12px;box-shadow:0 2px 8px #0004}
    header h1{margin:0;font-size:22px}
    .box{background:#ffffff15;padding:18px;margin:20px auto;border-radius:14px;max-width:430px;box-shadow:0 4px 14px #0003;backdrop-filter:blur(6px);color:#fff}
    input{width:100%;padding:12px;border-radius:10px;border:none;font-size:16px;margin-top:8px}
    button{padding:12px 18px;border:none;border-radius:12px;font-size:17px;cursor:pointer;transition:transform .15s .01s,box-shadow .15s}
    button:active{transform:scale(.94);box-shadow:0 0 12px #0005 inset}
    .ok{background:#ff0000;color:#fff}
    .err{background:#990000;color:#fff}
    .floatBtn{position:fixed;bottom:20px;right:20px;background:#ff0000;padding:18px;border-radius:50%;box-shadow:0 4px 15px #0006;font-size:24px;z-index:999}
    .msg{padding:14px;margin-top:14px;border-radius:8px;display:flex;justify-content:space-between;align-items:center;font-weight:bold}
    .valid{background:#0e8f4f;color:#fff}
    .invalid{background:#a00000;color:#fff}
    #logBox{margin-top:20px;font-size:14px;max-height:160px;overflow:auto;background:#ffffff10;padding:12px;border-radius:8px;box-shadow:0 1px 4px #0003}
    .counterBox{background:#ffffff15;padding:12px;border-radius:10px;margin-top:15px;font-weight:bold;text-align:center;color:#fff;box-shadow:0 1px 4px #0003}
    /* reader container sizing */
    #reader{width:100%;height:auto;min-height:200px;border-radius:8px;overflow:hidden;background:#000}
    video{width:100%;height:auto;object-fit:cover}
    @media (max-width:480px){.box{margin:12px 12px}}
  </style>
</head>
<body>

<header>
  <h1>üì° ESIP-Sistemas ‚Äî Leitor Pro+ Vermelho</h1>
</header>

<div class="box" id="loginBox">
  <h2>Login</h2>
  <p>Digite a senha:</p>
  <input id="senha" type="password" autocomplete="off">
  <button class="ok" style="margin-top:14px;width:100%" onclick="login()">Entrar</button>
</div>

<div class="box" id="scanBox" style="display:none">
  <h2>Scanner</h2>

  <div id="reader"></div>

  <button id="btnFlash" class="ok" style="margin-top:12px;width:100%" onclick="toggleFlash()">üî¶ Ligar Lanterna</button>

  <div class="counterBox">Entradas v√°lidas: <span id="contador">0</span></div>

  <div id="msgArea"></div>

  <h3>Log de entradas</h3>
  <div id="logBox"></div>

  <button class="ok" style="margin-top:10px;width:100%" onclick="exportCSV()">Exportar CSV</button>
  <button class="err" style="margin-top:10px;width:100%" onclick="limparLog()">Limpar Log</button>
</div>

<button class="floatBtn" onclick="toggleDarkMode()">üåì</button>

<audio id="somOk" src="https://cdn.pixabay.com/download/audio/2023/06/29/audio_25c0700121.mp3?filename=success-158310.mp3"></audio>
<audio id="somErro" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_4e6261a0ef.mp3?filename=error-126627.mp3"></audio>

<script>
// Estado
let used = new Set();
let log = [];
let countValid = 0;
let currentScanner = null; // Html5Qrcode instance
let currentCameraId = null;
let currentTrack = null;
let flashOn = false;

// UI helpers
function el(id){return document.getElementById(id)}

function login(){
  const senha = el('senha').value.trim();
  if(senha === 'ESIP2025'){
    el('loginBox').style.display = 'none';
    el('scanBox').style.display = 'block';
    setTimeout(startScanner, 200);
  } else {
    alert('Senha incorreta!');
  }
}

// Escolhe c√¢mera frontal se dispon√≠vel
function pickFrontCamera(cameras){
  if(!cameras || !cameras.length) return null;
  // procura por r√≥tulos que normalmente indicam frontal
  const prefer = cameras.find(c => {
    if(!c.label) return false;
    const l = c.label.toLowerCase();
    return l.includes('front') || l.includes('frontal') || l.includes('selfie') || l.includes('user');
  });
  if(prefer) return prefer.id;
  // em alguns aparelhos a frontal √© a √∫ltima
  return cameras[cameras.length - 1].id;
}

// Inicia scanner
function startScanner(){
  // se j√° rodando, n√£o reinicia
  if(currentScanner) return;

  // create
  const html5Qr = new Html5Qrcode('reader', /* verbose= */ false);
  currentScanner = html5Qr;

  Html5Qrcode.getCameras().then(cameras => {
    if(!cameras || cameras.length === 0){
      alert('Nenhuma c√¢mera dispon√≠vel.');
      return;
    }

    // escolhe frontal quando poss√≠vel
    const camId = pickFrontCamera(cameras);
    currentCameraId = camId;

    const config = { fps: 10, qrbox: { width: Math.min(320, window.innerWidth-40), height: Math.min(320, window.innerWidth-40) } };

    html5Qr.start(
      camId,
      config,
      (decodedText, decodedResult) => {
        // n√£o processa se j√° houver mensagem na tela
        if(document.querySelector('.msg')) return;
        processQR(decodedText);
      },
      (errorMessage) => {
        // opcional: console.debug('scan error', errorMessage);
      }
    ).then(() => {
      // tenta obter track para controle de torch
      // busca o elemento <video> dentro do container
      const video = document.querySelector('#reader video');
      if(video && video.srcObject){
        const tracks = video.srcObject.getVideoTracks();
        if(tracks && tracks.length) currentTrack = tracks[0];
      }
    }).catch(err => {
      console.error('Erro ao iniciar scanner:', err);
      alert('Erro ao iniciar scanner: ' + (err && err.message));
    });

  }).catch(err => {
    console.error('Erro getCameras:', err);
    alert('Erro ao listar c√¢meras: ' + (err && err.message));
  });
}

function stopScanner(){
  if(currentScanner){
    currentScanner.stop().then(() => {
      currentScanner.clear();
      currentScanner = null;
      currentCameraId = null;
      currentTrack = null;
    }).catch(err => {
      console.warn('Erro ao parar scanner', err);
    });
  }
}

// Alterna lanterna (torch) ‚Äî pode n√£o ser suportado em c√¢meras frontais
function toggleFlash(){
  if(!currentTrack){
    alert('C√¢mera n√£o inicializada ou n√£o dispon√≠vel ainda.');
    return;
  }
  // verifica suporte
  const capabilities = currentTrack.getCapabilities ? currentTrack.getCapabilities() : {};
  if(!capabilities.torch){
    alert('Lanterna (torch) n√£o suportada por esta c√¢mera.');
    return;
  }
  flashOn = !flashOn;
  currentTrack.applyConstraints({ advanced: [{ torch: flashOn }] }).then(() => {
    el('btnFlash').innerText = flashOn ? 'üî¶ Desligar Lanterna' : 'üî¶ Ligar Lanterna';
  }).catch(err => {
    console.warn('Erro aplicar torch:', err);
    alert('N√£o foi poss√≠vel alternar a lanterna.');
    flashOn = false;
  });
}

// Processamento do QR
function processQR(code){
  const somOk = el('somOk');
  const somErro = el('somErro');

  // simples limpeza do texto
  const txt = (code||'').toString().trim();
  if(!txt){
    return;
  }

  // Se j√° existe mensagem (operador precisa fechar), ignora
  if(document.querySelector('.msg')) return;

  // valida formato b√°sico
  if(!txt.startsWith('ESIP')){
    somErro.play().catch(()=>{});
    try{ navigator.vibrate(200); }catch(e){}
    showMessage('QR INV√ÅLIDO', false);
    // registra no log com status inv√°lido
    logPush(txt, 'inv√°lido');
    return;
  }

  if(used.has(txt)){
    somErro.play().catch(()=>{});
    try{ navigator.vibrate(200); }catch(e){}
    showMessage('INGRESSO J√Å UTILIZADO', false);
    logPush(txt, 'j√° utilizado');
    return;
  }

  // v√°lido
  used.add(txt);
  countValid++;
  el('contador').innerText = countValid;
  somOk.play().catch(()=>{});
  try{ navigator.vibrate([80,50,80]); }catch(e){}

  showMessage('INGRESSO V√ÅLIDO', true);
  logPush(txt, 'v√°lido');
}

function showMessage(text, ok){
  const area = el('msgArea');
  const div = document.createElement('div');
  div.className = 'msg ' + (ok ? 'valid' : 'invalid');
  div.innerHTML = `<span>${text}</span>`;
  const btn = document.createElement('button');
  btn.style.background = 'none';
  btn.style.border = 'none';
  btn.style.fontSize = '20px';
  btn.style.color = '#fff';
  btn.style.cursor = 'pointer';
  btn.innerText = '√ó';
  btn.onclick = function(){
    // ao fechar a mensagem, desbloqueia leituras
    div.remove();
  };
  div.appendChild(btn);
  area.appendChild(div);
}

function logPush(code, status){
  const entry = { codigo: code, status: status, hora: new Date().toLocaleString() };
  log.push(entry);
  updateLogBox();
}

function updateLogBox(){
  const box = el('logBox');
  let html = '';
  log.slice().reverse().forEach(l => {
    html += `<div><b>${l.status.toUpperCase()}</b> ‚Äî ${escapeHtml(l.codigo)}<br><small>${l.hora}</small></div><hr>`;
  });
  box.innerHTML = html;
}

function escapeHtml(str){
  return str.replace(/[&<>"']/g, function(m){return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[m];});
}

function limparLog(){
  if(confirm('Tem certeza que deseja limpar o log?')){
    log = [];
    used.clear();
    el('logBox').innerHTML = '';
    el('contador').innerText = '0';
    countValid = 0;
  }
}

function exportCSV(){
  let csv = 'codigo,status,hora
';
  log.forEach(l => csv += `"${l.codigo}","${l.status}","${l.hora}"
`);
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'entradas_esip_vermelho.csv';
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}

function toggleDarkMode(){ document.body.classList.toggle('dark'); }

// Ao sair da p√°gina, tenta parar scanner e liberar c√¢mera
window.addEventListener('beforeunload', () => { try{ stopScanner(); }catch(e){} });

</script>
</body>
</html>
