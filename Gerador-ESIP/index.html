<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gerador de Ingressos - ESIP</title>

<style>
    body {
        font-family: Arial, sans-serif;
        background: #0d0d0d;
        color: white;
        text-align: center;
        margin: 0;
        padding: 0;
    }

    header {
        background: #1b1b1b;
        padding: 15px;
        font-size: 22px;
        font-weight: bold;
        border-bottom: 2px solid #333;
    }

    .container {
        margin-top: 25px;
        padding: 20px;
    }

    input, input[type=number] {
        width: 90%;
        padding: 12px;
        font-size: 18px;
        border-radius: 8px;
        border: none;
        margin-bottom: 5px;
    }

    .error-msg {
        color: #ff4d4d;
        font-size: 14px;
        margin-bottom: 10px;
    }

    button {
        width: 90%;
        padding: 15px;
        background: #03a9f4;
        border: none;
        color: white;
        font-size: 20px;
        border-radius: 8px;
        cursor: pointer;
        margin-top: 10px;
    }

    button:hover {
        background: #0288d1;
    }

    #qrcode {
        margin-top: 25px;
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
    }

    .qr-item {
        margin: 10px;
    }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

</head>
<body>

<header>üì° ESIP-Sistemas ‚Äì Anti-Fraude</header>

<div class="container">

    <h2>Gerar Ingresso</h2>

    <input type="text" id="nome" placeholder="Nome completo">
    <input type="text" id="cpf" placeholder="CPF apenas n√∫meros">
    <div id="cpf-error" class="error-msg"></div>
    <input type="text" id="evento" placeholder="Nome do evento">
    <input type="number" id="quantidade" placeholder="Quantidade de ingressos" min="1" value="1">

    <button onclick="gerarIngresso()">Gerar QR Code</button>
    <button onclick="baixarPDF()">Baixar PDF</button>

    <div id="qrcode"></div>

</div>

<script>
let ingressosGerados = [];
const URL_ADMINISTRADOR = "URL_DO_ADMINISTRADOR_AQUI";

function gerarIngresso() {
    const nome = document.getElementById("nome").value.trim();
    const cpf  = document.getElementById("cpf").value.trim();
    const evento = document.getElementById("evento").value.trim();
    const quantidade = parseInt(document.getElementById("quantidade").value);
    const cpfError = document.getElementById("cpf-error");

    cpfError.textContent = "";

    if (!nome || !cpf || !evento) {
        alert("Preencha todos os campos!");
        return;
    }

    if (!/^\d{11}$/.test(cpf)) {
        cpfError.textContent = "‚ö†Ô∏è CPF inv√°lido! Deve conter exatamente 11 n√∫meros.";
        document.getElementById("cpf").focus();
        return;
    }

    if (isNaN(quantidade) || quantidade < 1) {
        alert("Informe uma quantidade v√°lida de ingressos!");
        return;
    }

    ingressosGerados = [];
    const qrContainer = document.getElementById("qrcode");
    qrContainer.innerHTML = "";

    for (let i = 1; i <= quantidade; i++) {
        const codigo = "ESIP-" + Math.random().toString(36).slice(2, 10); // mais moderno
        const dataHora = new Date();
        const ingresso = {
            id: codigo,
            cpf,
        };
        ingressosGerados.push(ingresso);

        const qrDiv = document.createElement("div");
        qrDiv.className = "qr-item";
        qrContainer.appendChild(qrDiv);

        // QR com ID e CPF (mais enxuto)
        new QRCode(qrDiv, {
            text: `${ingresso.id}|${ingresso.cpf}`,  // ID e CPF separados por "|"
            width: 150,
            height: 150
        });
    }

    alert("Ingresso(s) gerado(s) com sucesso!");

    if (URL_ADMINISTRADOR && URL_ADMINISTRADOR !== "URL_DO_ADMINISTRADOR_AQUI") {
        fetch(URL_ADMINISTRADOR, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                nome, cpf, evento, quantidade,
                ingressos: ingressosGerados,
                timestamp: new Date().toISOString()
            })
        })
        .then(res => res.json())
        .then(data => console.log("Enviado com sucesso", data))
        .catch(err => console.error("Erro ao enviar", err));
    }
}

function baixarPDF() {
    if (ingressosGerados.length === 0) {
        alert("Nenhum ingresso gerado para baixar!");
        return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.setFontSize(16);
    doc.text("üì° ESIP-Sistemas ‚Äì Ingresso", 20, 15);

    ingressosGerados.forEach((ingresso, index) => {
        const itemsPerPage = 5;
        const yBase = 20;
        const spacing = 60;
        const y = yBase + (index % itemsPerPage) * spacing;

        if (index > 0 && index % itemsPerPage === 0) doc.addPage();

        // Dados do ingresso √† esquerda
        doc.setFontSize(12);
        doc.text(`ID: ${ingresso.id}`, 20, y);
        doc.text(`CPF: ${ingresso.cpf}`, 20, y + 6);
        doc.text(`Nome: ${document.getElementById("nome").value}`, 20, y + 12);
        doc.text(`Evento: ${document.getElementById("evento").value}`, 20, y + 18);
        doc.text(`Quantidade: 1`, 20, y + 24);  // Como estamos gerando apenas 1 ingresso por vez

        // Posicionar o QR Code abaixo dos dados, centralizado
        const qrImg = document.querySelectorAll(".qr-item img")[index];
        if (qrImg) {
            const qrX = (doc.internal.pageSize.width - 50) / 2;  // Centraliza horizontalmente
            const qrY = y + 35;  // Posiciona o QR Code abaixo dos dados
            doc.addImage(qrImg.src, "PNG", qrX, qrY, 50, 50);  // QR Code maior (50x50)
        }
    });

    doc.save("ingresso.pdf");
}
</script>

</body>
</html>

