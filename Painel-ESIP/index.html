<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Leitor Vermelho ‚Äî Avan√ßado</title>

<!-- html5-qrcode -->
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
:root{
  --bg-dark: #2b0000;
  --bg-light: #ffffff;
  --card-dark: rgba(58,0,0,0.9);
  --card-light: rgba(255,255,255,0.9);
  --accent: #ff0000;
  --success: #00ff88;
  --error: #ff4444;
  --muted-light: rgba(255,255,255,0.12);
  --muted-dark: rgba(0,0,0,0.06);
  --chip-bg: rgba(255,255,255,0.06);
}

/* base */
html,body{height:100%; margin:0;}
body {
  font-family: Inter, Arial, sans-serif;
  margin:0;
  padding:14px;
  display:flex;
  justify-content:center;
  background: var(--bg-dark);
  color: #fff;
  -webkit-font-smoothing:antialiased;
  transition: background .25s, color .25s;
}
body.light {
  background: var(--bg-light);
  color: #111;
}

/* container */
.container {
  width:100%;
  max-width:900px;
}

/* header */
.header {
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:12px;
  margin-bottom:12px;
}
.title { display:flex; gap:10px; align-items:center; font-size:1.15rem; font-weight:700; }
.subtitle { font-size:0.85rem; opacity:0.9; }

/* card */
.card {
  background: var(--card-dark);
  padding:12px;
  border-radius:12px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.45);
}
body.light .card { background: var(--card-light); box-shadow: 0 8px 20px rgba(0,0,0,0.06); }

/* reader */
#reader {
  width:100%;
  max-width:520px;
  margin: 8px auto;
  border-radius:8px;
  overflow:hidden;
  border: 4px solid var(--accent);
  height: auto;
}

/* controls */
.controls { display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; justify-content:center; }
.btn {
  background: var(--accent);
  color: #fff;
  border: none;
  padding: 10px 12px;
  border-radius:8px;
  cursor:pointer;
  font-weight:700;
}
.btn.ghost { background: transparent; border: 1px solid rgba(255,255,255,0.08); color: inherit; }
.btn:disabled { opacity:.55; cursor:not-allowed; }

/* message */
#msg { text-align:center; margin-top:8px; min-height:36px; font-weight:800; font-size:1.05rem; }
.green { color: var(--success); }
.red { color: var(--error); }

/* history (compact chips/badges) */
.hist-wrap {
  margin-top:14px;
}
.hist-meta { display:flex; justify-content:space-between; align-items:center; margin-bottom:6px; gap:8px; }
.chips {
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  align-items:center;
}
.chip {
  display:inline-flex;
  gap:8px;
  align-items:center;
  padding:6px 10px;
  border-radius:999px;
  font-family: monospace;
  font-size:0.9rem;
  background: var(--chip-bg);
  color: inherit;
  box-shadow: 0 2px 6px rgba(0,0,0,0.12);
}
.chip .time { font-size:0.75rem; opacity:0.85; margin-left:8px; }
.chip.valid { background: rgba(0,255,136,0.12); border:1px solid rgba(0,255,136,0.18); color:var(--success); }
.chip.used  { background: rgba(255,68,68,0.10); border:1px solid rgba(255,68,68,0.14); color:var(--error); }
.chip.invalid { background: rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.03); color:inherit; }

/* counters */
.counters { display:flex; gap:10px; align-items:center; font-size:0.95rem; opacity:0.92; }

/* flash animations */
@keyframes flashGreen {
  0% { box-shadow: none; transform: none; }
  30% { box-shadow: 0 0 40px 12px rgba(0,255,136,0.12); transform: translateY(-2px); }
  100% { box-shadow: none; transform: none; }
}
@keyframes flashRed {
  0% { box-shadow: none; transform: none; }
  30% { box-shadow: 0 0 40px 12px rgba(255,68,68,0.12); transform: translateY(-2px); }
  100% { box-shadow: none; transform: none; }
}
.flash-success { animation: flashGreen 420ms ease; }
.flash-error   { animation: flashRed 420ms ease; }

/* small screens */
@media (max-width:600px){
  .header { flex-direction:column; align-items:flex-start; gap:6px; }
  .controls { justify-content:stretch; }
  .btn { flex:1 1 auto; }
  .chips { max-width:100%; overflow:auto; }
}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div>
      <div class="title">üìï Leitor Vermelho ‚Äî Avan√ßado</div>
      <div class="subtitle">Modo leitura com hist√≥rico (badges), export e controles</div>
    </div>

    <div style="display:flex; gap:8px; align-items:center;">
      <button id="themeToggle" class="btn ghost" title="Alternar tema">üåô</button>
      <button id="lockOrient" class="btn ghost" title="Fixar orienta√ß√£o">üîí Retrato</button>
    </div>
  </div>

  <div class="card" id="cardMain">
    <div id="reader"></div>

    <div class="controls" style="margin-top:10px;">
      <button id="toggleLight" class="btn">üî¶ Ligar Lanterna</button>
      <button id="switchCamera" class="btn">üì∑ Trocar C√¢mera</button>
      <button id="resetUsed" class="btn">‚ôªÔ∏è Resetar Usados</button>
      <button id="exportHistory" class="btn ghost">‚¨áÔ∏è Exportar Hist√≥rico (CSV)</button>
      <button id="exportUsed" class="btn ghost">‚¨áÔ∏è Exportar Usados (CSV)</button>
      <button id="clearHistory" class="btn ghost">üßπ Limpar Hist√≥rico</button>
    </div>

    <div id="msg" aria-live="polite"></div>

    <div class="hist-wrap">
      <div class="hist-meta">
        <div class="counters">
          <div>Usados: <strong id="usedCount">0</strong></div>
          <div>Total hist√≥rico: <strong id="histCount">0</strong></div>
        </div>
        <div style="font-size:0.9rem; opacity:0.9;">Exibindo badges (mais recente por √∫ltimo)</div>
      </div>

      <div class="chips" id="chipsContainer" aria-live="polite"></div>
    </div>
  </div>
</div>

<script>
/*
  Leitor Vermelho ‚Äî Vers√£o completa com:
  - tema autom./manual
  - lanterna (torch)
  - troca de c√¢mera
  - hist√≥rico (badges)
  - export CSV (hist√≥rico e usados)
  - reset usado / limpar hist√≥rico
  - sons e vibra√ß√µes
  - bloqueio de orienta√ß√£o retrato
*/

/* ========= Config / estado ========= */
const MAX_HISTORY = 800;
let html5Qr = null;
let scanning = true;
let flashOn = false;
let cameras = [];
let cameraIndex = 0;
let used = new Set(JSON.parse(localStorage.getItem('usedCodes') || '[]'));
let history = JSON.parse(localStorage.getItem('scanHistory') || '[]'); // {code,status,iso}
const chipsEl = document.getElementById('chipsContainer');

/* ========= Sons personalizados ========= */
const sounds = {
  valid: new Audio('https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg'),
  invalid: new Audio('https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg'),
  used: new Audio('https://actions.google.com/sounds/v1/cartoon/pop.ogg'),
  switch: new Audio('https://actions.google.com/sounds/v1/foley/slide_whistle.ogg')
};
for (const s of Object.values(sounds)) {
  s.load();
  s.volume = 0.95;
}

/* ========= Utilit√°rios ========= */
function nowIso(){ return new Date().toISOString(); }
function persist(){
  localStorage.setItem('usedCodes', JSON.stringify([...used]));
  localStorage.setItem('scanHistory', JSON.stringify(history));
  document.getElementById('usedCount').innerText = used.size;
  document.getElementById('histCount').innerText = history.length;
}
function vibrate(pattern){ navigator.vibrate?.(pattern); }

function showMsg(text, ok=true, flash=true){
  const el = document.getElementById('msg');
  el.textContent = text;
  el.className = ok ? 'green' : 'red';
  const card = document.getElementById('cardMain');
  card.classList.remove('flash-success','flash-error');
  if (flash) card.classList.add(ok ? 'flash-success' : 'flash-error');
}

/* ========= Render chips (badges) =========
   Exibi√ß√£o compacta: cada badge tem c√≥digo + hor√°rio curto
   Ordem: mais recente por √∫ltimo (voc√™ pediu compacto)
*/
function renderChips(){
  chipsEl.innerHTML = '';
  // mostrar at√© X √∫ltimos (n√£o carregar tudo se enorme)
  const items = history.slice(-200); // √∫ltimos 200
  for (const item of items) {
    const d = new Date(item.iso);
    const short = d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    const chip = document.createElement('div');
    chip.className = 'chip ' + (item.status === 'V√ÅLIDO' ? 'valid' : item.status === 'J√Å USADO' ? 'used' : 'invalid');
    chip.innerHTML = `<span class="code">${item.code}</span><span class="time">${short}</span>`;
    chipsEl.appendChild(chip);
  }
}

/* ========= CSV Export ========= */
function downloadCSV(text, filename){
  const blob = new Blob([text], {type: 'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}
function exportHistoryCSV(){
  const rows = [['timestamp','code','status']];
  for (const h of history) rows.push([h.iso, h.code, h.status]);
  const csv = rows.map(r => r.map(c => `"${String(c||'').replace(/"/g,'""')}"`).join(',')).join('\r\n');
  downloadCSV(csv, `leitor-historico-${(new Date()).toISOString().slice(0,19).replace(/[:T]/g,'-')}.csv`);
}
function exportUsedCSV(){
  const rows = [['code']];
  for (const c of used) rows.push([c]);
  const csv = rows.map(r => r.map(c => `"${String(c||'').replace(/"/g,'""')}"`).join(',')).join('\r\n');
  downloadCSV(csv, `leitor-usados-${(new Date()).toISOString().slice(0,19).replace(/[:T]/g,'-')}.csv`);
}

/* ========= Valida√ß√£o ========= */
function validateCode(code){
  // regra padr√£o; modifique se desejar
  return code.startsWith('INGR-');
}

/* ========= Registrar leitura ========= */
function register(code, status){
  history.push({code, status, iso: nowIso()});
  if (history.length > MAX_HISTORY) history.shift();
  if (status === 'V√ÅLIDO') used.add(code);
  persist();
  renderChips();
}

/* ========= Processar leitura (callback do scanner) ========= */
function processQR(decodedText) {
  if (!scanning) return;
  scanning = false;
  const code = String(decodedText || '').trim();

  if (!validateCode(code)) {
    try { sounds.invalid.play().catch(()=>{}); } catch(e){}
    vibrate([120,30,120]);
    register(code, 'INV√ÅLIDO');
    showMsg('‚ùå QR INV√ÅLIDO', false);
  } else if (!used.has(code)) {
    try { sounds.valid.play().catch(()=>{}); } catch(e){}
    vibrate([30,20,30]);
    register(code, 'V√ÅLIDO');
    showMsg('‚úÖ Ingresso v√°lido', true);
  } else {
    try { sounds.used.play().catch(()=>{}); } catch(e){}
    vibrate([60,30,60]);
    register(code, 'J√Å USADO');
    showMsg('‚ö†Ô∏è J√° utilizado', false);
  }

  // permitir pr√≥xima leitura ap√≥s pequeno intervalo
  setTimeout(()=>{ scanning = true; }, 650);
}

/* ========= Inicializar scanner ========= */
async function startScanner(deviceId){
  // parada segura
  if (html5Qr) {
    try{ await html5Qr.stop(); } catch(e){}
    try{ html5Qr.clear(); } catch(e){}
    html5Qr = null;
  }

  html5Qr = new Html5Qrcode('reader', { verbose:false });

  try {
    const cfg = { fps: 10, qrbox: (window.innerWidth < 420 ? 220 : 280) };
    await html5Qr.start(deviceId, cfg, processQR, (err)=>{});
    showMsg('C√¢mera iniciada', true, false);
  } catch (err) {
    console.error('Erro iniciando scanner:', err);
    showMsg('Erro ao iniciar c√¢mera', false);
  }
}

/* ========= Listar c√¢meras e iniciar a preferida ========= */
async function initCameras(){
  try {
    const cams = await Html5Qrcode.getCameras();
    cameras = cams || [];
    if (!cameras.length) { showMsg('Nenhuma c√¢mera dispon√≠vel', false); return; }

    // preferir traseira / back se existir
    const backIndex = cameras.findIndex(c => /back|traseir|rear/i.test(c.label));
    cameraIndex = backIndex >= 0 ? backIndex : 0;

    await startScanner(cameras[cameraIndex].id);
    persist();
  } catch (e) {
    console.error('Erro buscando c√¢meras', e);
    showMsg('Erro ao buscar c√¢meras', false);
  }
}

/* ========= Torch / Lanterna ========= */
async function toggleTorch(){
  const btn = document.getElementById('toggleLight');
  const track = html5Qr?.getRunningTrack?.();
  if (!track) { showMsg('üì∑ C√¢mera n√£o pronta', false); return; }

  const caps = track.getCapabilities?.();
  if (!caps || !caps.torch) { showMsg('‚ö†Ô∏è Lanterna n√£o suportada', false); return; }

  try {
    btn.disabled = true;
    flashOn = !flashOn;
    await track.applyConstraints({ advanced: [{ torch: flashOn }] });
    btn.innerText = flashOn ? 'üî¶ Desligar Lanterna' : 'üî¶ Ligar Lanterna';
  } catch (e) {
    console.error('Erro lanterna', e);
    showMsg('Erro ao ativar lanterna', false);
  } finally { btn.disabled = false; }
}

/* ========= Trocar c√¢mera ========= */
async function switchCamera(){
  if (!cameras.length) { showMsg('Sem c√¢meras para trocar', false); return; }
  try { sounds.switch.play().catch(()=>{}); } catch(e){}
  cameraIndex = (cameraIndex + 1) % cameras.length;
  showMsg('Trocando c√¢mera...', true, false);
  await startScanner(cameras[cameraIndex].id);
}

/* ========= Reset e limpar ========= */
function resetUsed(){
  if (!confirm('Redefinir lista de ingressos usados? Esta a√ß√£o √© irrevers√≠vel.')) return;
  used.clear();
  persist();
  showMsg('Usados resetados', true);
}
function clearHistory(){
  if (!confirm('Limpar todo o hist√≥rico de leituras?')) return;
  history = [];
  persist();
  renderChips();
  showMsg('Hist√≥rico limpo', true);
}

/* ========= Theme (auto + toggle) ========= */
const themeBtn = document.getElementById('themeToggle');
function applyTheme(isLight){
  document.body.classList.toggle('light', isLight);
  themeBtn.textContent = isLight ? 'üåû' : 'üåô';
  localStorage.setItem('themeMode', isLight ? 'light' : 'dark');
}
function initTheme(){
  const saved = localStorage.getItem('themeMode');
  if (saved === 'light') applyTheme(true);
  else if (saved === 'dark') applyTheme(false);
  else {
    const prefersLight = window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches;
    applyTheme(prefersLight);
  }
}
themeBtn.addEventListener('click', ()=> applyTheme(!document.body.classList.contains('light')));

/* ========= Orientation lock ========= */
document.getElementById('lockOrient').addEventListener('click', async ()=>{
  try {
    if (screen.orientation && screen.orientation.lock) {
      await screen.orientation.lock('portrait');
      showMsg('Orienta√ß√£o travada (retrato)', true);
    } else {
      showMsg('API de orienta√ß√£o n√£o suportada', false);
    }
  } catch (e) {
    console.warn(e);
    showMsg('Falha ao travar orienta√ß√£o', false);
  }
});

/* ========= Hooks de bot√µes ========= */
document.getElementById('toggleLight').addEventListener('click', toggleTorch);
document.getElementById('switchCamera').addEventListener('click', switchCamera);
document.getElementById('resetUsed').addEventListener('click', resetUsed);
document.getElementById('exportHistory').addEventListener('click', exportHistoryCSV);
document.getElementById('exportUsed').addEventListener('click', exportUsedCSV);
document.getElementById('clearHistory').addEventListener('click', clearHistory);

/* ========= Inicializa√ß√£o ========= */
(function init(){
  // render info existentes
  document.getElementById('usedCount').innerText = used.size;
  document.getElementById('histCount').innerText = history.length;
  renderChips();
  initTheme();
  initCameras();

  // tentar pr√©-carregar sons (evita bloqueio em alguns navegadores)
  for (const s of Object.values(sounds)) { try{ s.load(); }catch(e){} }

  // reativar scanner caso a aba volte ao foco
  document.addEventListener('visibilitychange', ()=>{
    if (!document.hidden) {
      if (html5Qr && typeof html5Qr.getState === 'function' && html5Qr.getState() !== Html5QrcodeScannerState === false) {
        // se precisar, reiniciar (silencioso)
      }
    }
  });

  // salvar ao fechar
  window.addEventListener('beforeunload', persist);
})();
</script>
</body>
</html>

