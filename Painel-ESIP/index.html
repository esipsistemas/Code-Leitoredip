<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ESIP - Leitor Seguro (Corrigido)</title>

<!-- Depend√™ncias -->
<script src="https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
  :root{--bg:#1a0000;--card:#2a0a0a;--accent:#ff4444;--ok:#00cc77;--text:#ffffff}
  body{margin:0;font-family:Inter,Arial,Helvetica,sans-serif;background:var(--bg);color:var(--text);padding:14px}
  header{display:flex;align-items:center;gap:12px}
  h1{margin:0;font-size:20px}
  #reader{width:100%;max-width:420px;margin:14px auto;border-radius:12px;overflow:hidden;border:4px solid var(--accent)}
  .controls{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin:8px 0}
  .btn{background:var(--accent);color:#fff;border:none;padding:10px 12px;border-radius:8px;cursor:pointer}
  .btn.secondary{background:#333}
  .panel{background:var(--card);padding:12px;border-radius:10px;margin:12px auto;max-width:920px}
  .counters{display:flex;gap:8px;justify-content:center;flex-wrap:wrap}
  .counter{background:#330000;padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.05)}
  #msg{margin-top:10px;font-weight:700;text-align:center}
  #history{display:flex;flex-wrap:wrap;gap:6px;justify-content:center;margin-top:10px;max-height:320px;overflow:auto}
  .badge{background:#330000;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,68,68,0.2)}
  .badge.valid{border-color:var(--ok);background:rgba(0,51,20,0.2)}
  footer{font-size:12px;color:#ddd;text-align:center;margin-top:10px}
  @media (max-width:520px){.controls{flex-direction:column;align-items:center}.counters{flex-direction:column}}
</style>
</head>
<body>
  <header>
    <img src="" alt="" style="width:48px;height:48px;border-radius:8px;background:#000"/>
    <div>
      <h1>ESIP - Leitor Seguro</h1>
      <div style="font-size:13px;color:#ddd">Vers√£o corrigida ‚Äî scanner, lanterna, troca de c√¢mera, export CSV/PDF</div>
    </div>
  </header>

  <div class="panel" style="text-align:center">
    <div class="counters">
      <div class="counter">V√°lidos: <span id="countValid">0</span></div>
      <div class="counter">Usados: <span id="countUsed">0</span></div>
      <div class="counter">Inv√°lidos: <span id="countInvalid">0</span></div>
      <div class="counter">Mem√≥ria: <span id="countMemory">0</span></div>
    </div>

    <div id="reader"></div>

    <div class="controls">
      <button id="toggleLight" class="btn secondary">üî¶ Lanterna (Desconhecido)</button>
      <button id="switchCam" class="btn">üîÑ Trocar C√¢mera</button>
      <button id="reset" class="btn">üóëÔ∏è Resetar Ingressos</button>
      <button id="export" class="btn">üì§ Exportar CSV</button>
      <button id="exportPDF" class="btn">üìÑ Exportar PDF</button>
    </div>

    <div id="msg">Aguardando leitura...</div>

    <h3 style="text-align:center;margin-top:14px">Hist√≥rico (√∫ltimos 200)</h3>
    <div id="history"></div>
  </div>

  <footer>Desenvolvido para ESIP ‚Äî c√≥digo corrigido</footer>

<script>
/* ===== CONFIG ===== */
const STORAGE_USED_KEY = "usedCodesMap_v2";
const STORAGE_COUNT_VALID = "countValid_v2";
const STORAGE_COUNT_USED = "countUsed_v2";
const STORAGE_COUNT_INVALID = "countInvalid_v2";
const RESET_PASSWORD = "ESIP2025";
const HISTORY_DISPLAY_LIMIT = 200; // evita travar o DOM

/* ===== √Åudio (WebAudio para evitar CORS) ===== */
const audioCtx = typeof AudioContext !== 'undefined' ? new AudioContext() : null;
function beep(f=880, dur=0.08){
  try{
    if(!audioCtx) return;
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = 'sine'; o.frequency.value = f;
    g.gain.value = 0.06;
    o.connect(g); g.connect(audioCtx.destination);
    o.start();
    setTimeout(()=>{ o.stop(); }, dur*1000);
  }catch(e){ /* ignore audio errors */ }
}

/* ===== Estado ===== */
let html5Qr = null;
let flashOn = false; // estado conhecido
let scanning = true;
let currentCam = 0;
let cameras = [];
let usedMap = {};

/* ===== Contadores ===== */
let totalValid   = parseInt(localStorage.getItem(STORAGE_COUNT_VALID)   || "0");
let totalUsed    = parseInt(localStorage.getItem(STORAGE_COUNT_USED)    || "0");
let totalInvalid = parseInt(localStorage.getItem(STORAGE_COUNT_INVALID) || "0");

document.getElementById("countValid").textContent = totalValid;
document.getElementById("countUsed").textContent = totalUsed;
document.getElementById("countInvalid").textContent = totalInvalid;

/* ===== Utilidades ===== */
function nowTs(){ return Date.now(); }
function saveCounts(){
  localStorage.setItem(STORAGE_COUNT_VALID, totalValid);
  localStorage.setItem(STORAGE_COUNT_USED, totalUsed);
  localStorage.setItem(STORAGE_COUNT_INVALID, totalInvalid);
}
function flash(type){
  const cls = type === 'good' ? 'flash-ok' : 'flash-bad';
  document.body.classList.add(cls);
  setTimeout(()=>document.body.classList.remove(cls), 260);
}

/* ===== Hist√≥rico (localStorage) ===== */
function loadUsedMap(){
  try{
    const raw = localStorage.getItem(STORAGE_USED_KEY);
    usedMap = raw ? JSON.parse(raw) : {};
  }catch(e){ usedMap = {}; }
}

function saveUsedMap(){
  localStorage.setItem(STORAGE_USED_KEY, JSON.stringify(usedMap));
  updateMemoryCount();
}

function updateHistory(){
  const box = document.getElementById('history');
  box.innerHTML = '';
  // ordenar por timestamp descendente
  const entries = Object.entries(usedMap).sort((a,b)=>b[1]-a[1]).slice(0,HISTORY_DISPLAY_LIMIT);
  for(const [code,ts] of entries){
    const div = document.createElement('div');
    div.className = 'badge valid';
    div.textContent = `${code} ¬∑ ${new Date(ts).toLocaleString()}`;
    box.appendChild(div);
  }
}

function updateMemoryCount(){
  document.getElementById('countMemory').textContent = Object.keys(usedMap).length;
}

/* ===== Valida√ß√£o ===== */
function validateCode(code){
  // Regra de exemplo: come√ßa com INGR-
  if(typeof code !== 'string') return false;
  return code.trim().startsWith('INGR-');
}

/* ===== Mensagens UI ===== */
function showMsg(text, ok){
  const m = document.getElementById('msg');
  m.textContent = text;
  m.style.color = ok ? '#00ff88' : '#ff4444';
}

/* ===== Processar QR ===== */
let debounce = false;
function processQR(decodedText){
  if(debounce) return;
  debounce = true;
  setTimeout(()=> debounce = false, 600);

  const code = String(decodedText).trim();
  if(!validateCode(code)){
    totalInvalid++; saveCounts();
    flash('bad'); beep(440,0.08);
    try{ navigator.vibrate && navigator.vibrate(200); }catch(e){}
    showMsg('QR inv√°lido', false);
    return;
  }

  if(!usedMap[code]){
    usedMap[code] = nowTs(); saveUsedMap();
    totalValid++; saveCounts();
    flash('good'); beep(1200,0.09);
    try{ navigator.vibrate && navigator.vibrate(60); }catch(e){}
    showMsg('Ingresso v√°lido', true);
    updateHistory();
    updateCountersUI();
  } else {
    totalUsed++; saveCounts();
    flash('bad'); beep(660,0.09);
    try{ navigator.vibrate && navigator.vibrate(120); }catch(e){}
    showMsg('J√° utilizado', false);
    updateCountersUI();
  }
}

function updateCountersUI(){
  document.getElementById('countValid').textContent = totalValid;
  document.getElementById('countUsed').textContent = totalUsed;
  document.getElementById('countInvalid').textContent = totalInvalid;
}

/* ===== Scanner: iniciar/parar/trocar c√¢mera ===== */
async function startScanner(){
  try{
    if(html5Qr) {
      try{ await html5Qr.stop(); }catch(e){}
      html5Qr.clear(); html5Qr = null;
    }

    html5Qr = new Html5Qrcode('reader');

    // se cameras ainda n√£o carregadas, busca
    cameras = cameras && cameras.length ? cameras : await Html5Qrcode.getCameras();
    if(!cameras || cameras.length === 0){ showMsg('Nenhuma c√¢mera dispon√≠vel', false); return; }

    if(currentCam >= cameras.length) currentCam = 0;

    // limpar container para evitar conflitos
    document.getElementById('reader').innerHTML = '';

    await html5Qr.start(
      cameras[currentCam].id,
      { fps: 10, qrbox: Math.min(360, Math.floor(window.innerWidth*0.8)) },
      (decodedText, decodedResult) => { processQR(decodedText); },
      (errorMessage) => { /* opcional: console.debug(errorMessage) */ }
    );

    // tenta ligar a lanterna se dispon√≠vel
    setTimeout(()=> detectAndSetTorch(), 500);

    showMsg('Scanner iniciado', true);
  }catch(e){
    console.error('startScanner error', e);
    showMsg('Erro ao iniciar scanner', false);
  }
}

async function stopScanner(){
  try{
    if(!html5Qr) return;
    await html5Qr.stop();
    html5Qr.clear(); html5Qr = null;
    showMsg('Scanner parado', false);
  }catch(e){ console.warn('Erro ao parar scanner', e); }
}

// trocar c√¢mera
async function switchCamera(){
  if(!cameras || cameras.length < 2) { showMsg('Somente 1 c√¢mera dispon√≠vel', false); return; }
  currentCam = (currentCam + 1) % cameras.length;
  await startScanner();
}

/* ===== Lanterna (torch) ===== */
async function detectAndSetTorch(force=null){
  try{
    if(!html5Qr) return;
    // obter track (m√©todo compat√≠vel sugerido)
    let track = null;
    try{ track = html5Qr.getScanRegionCameraTrack(); }catch(e){ track = null; }
    // fallback: tentar acessar via stream
    if(!track){
      const streams = document.querySelector('#reader video')?.srcObject;
      if(streams && streams.getVideoTracks) track = streams.getVideoTracks()[0];
    }
    if(!track) { document.getElementById('toggleLight').innerText = 'üî¶ Lanterna (N√£o suportada)'; return; }

    const caps = track.getCapabilities ? track.getCapabilities() : {};
    if(!caps.torch){ document.getElementById('toggleLight').innerText = 'üî¶ Lanterna (N√£o dispon√≠vel)'; return; }

    flashOn = force !== null ? force : !flashOn;
    try{ await track.applyConstraints({ advanced:[{ torch: flashOn }] }); } catch(e){ console.warn('applyConstraints failed', e); }

    document.getElementById('toggleLight').innerText = flashOn ? 'üî¶ Lanterna (Ligada)' : 'üî¶ Lanterna (Desligada)';
  }catch(e){ console.warn('detectAndSetTorch err', e); document.getElementById('toggleLight').innerText = 'üî¶ Lanterna (Erro)'; }
}

/* ===== Export CSV ===== */
function exportCSV(){
  const rows = [['codigo','timestamp']];
  for(const [c,ts] of Object.entries(usedMap)) rows.push([c,new Date(ts).toISOString()]);
  const csv = rows.map(r => r.map(v=> '"'+String(v).replace(/"/g,'""')+'"').join(',')).join('
');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'ingressos.csv'; a.click();
}

/* ===== Export PDF ===== */
async function exportPDF(){
  try{
    // gerar uma √°rea branca com conte√∫do simplificado
    const tmp = document.createElement('div');
    tmp.style.padding = '18px'; tmp.style.background = '#fff'; tmp.style.color = '#000'; tmp.style.width = '900px'; tmp.style.fontFamily = 'Arial, sans-serif';

    const hdr = document.createElement('div'); hdr.innerHTML = `<h2 style="margin:0;">Relat√≥rio ESIP - Sistemas</h2><div style=\"margin-bottom:8px;\">Gerado em: ${new Date().toLocaleString()}</div>`;
    tmp.appendChild(hdr);

    const table = document.createElement('table'); table.style.width='100%'; table.style.borderCollapse='collapse';
    const tbody = document.createElement('tbody');
    for(const [c,ts] of Object.entries(usedMap)){
      const tr = document.createElement('tr');
      const td1 = document.createElement('td'); td1.style.padding='6px'; td1.textContent = c;
      const td2 = document.createElement('td'); td2.style.padding='6px'; td2.textContent = new Date(ts).toLocaleString();
      tr.appendChild(td1); tr.appendChild(td2); tbody.appendChild(tr);
    }
    table.appendChild(tbody); tmp.appendChild(table);
    document.body.appendChild(tmp);

    const canvas = await html2canvas(tmp, { scale:2 });
    const img = canvas.toDataURL('image/png');
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({ unit:'px', format:[canvas.width, canvas.height] });
    pdf.addImage(img, 'PNG', 0, 0, canvas.width, canvas.height);
    pdf.save('ingressos.pdf');
    tmp.remove();
  }catch(e){ console.error('exportPDF', e); alert('Erro ao gerar PDF'); }
}

/* ===== Reset seguro ===== */
function resetAll(){
  const senha = prompt('Senha para resetar:');
  if(senha !== RESET_PASSWORD) return alert('Senha incorreta!');
  if(!confirm('Apagar todos os registros?')) return;
  usedMap = {}; totalValid = 0; totalUsed = 0; totalInvalid = 0; saveUsedMap(); saveCounts(); updateHistory(); updateCountersUI(); showMsg('‚úî Resetado', true);
}

/* ===== Inicializa√ß√£o ===== */
(async function init(){
  loadUsedMap(); updateHistory(); updateMemoryCount(); updateCountersUI(); saveCounts();

  try{ cameras = await Html5Qrcode.getCameras(); }catch(e){ cameras = []; }
  await startScanner();
})();

/* ===== Hooks UI ===== */
document.getElementById('switchCam').onclick = switchCamera;
document.getElementById('toggleLight').onclick = () => detectAndSetTorch();
document.getElementById('reset').onclick = resetAll;
document.getElementById('export').onclick = exportCSV;
document.getElementById('exportPDF').onclick = exportPDF;

/* Guarda antes de fechar por seguran√ßa */
window.addEventListener('beforeunload', ()=>{ saveUsedMap(); saveCounts(); });

</script>
</body>
</html>

