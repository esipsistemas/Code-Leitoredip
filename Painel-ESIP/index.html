<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ðŸ“¡ ESIP-Sistemas - Painel</title>

<style>
  :root {
    --bg-color: #121212;
    --text-color: #eee;
    --box-bg: #1e1e1e;
    --primary: #03a9f4;
    --primary-dark: #0288d1;
    --empty-color: #aaa;
  }
  body { margin:0; font-family:Arial; background:var(--bg-color); color:var(--text-color); padding:20px; }
  h1,h2{text-align:center;color:var(--primary);}
  .box{ background:var(--box-bg); padding:20px; border-radius:10px; margin:20px auto; max-width:900px; box-shadow:0 2px 10px rgba(0,0,0,0.5);}
  input{padding:5px; margin-right:10px; border-radius:5px; border:1px solid #555; margin-bottom:5px; background:#222; color:#eee;}
  button{padding:5px 10px; border:none; border-radius:5px; background:var(--primary); color:#fff; cursor:pointer; margin-right:10px;}
  button:hover{background:var(--primary-dark);}
  table{width:100%; border-collapse:collapse; margin-top:10px;}
  th,td{border-bottom:1px solid #555; padding:10px; text-align:center;}
  th{background:var(--primary); color:#fff;}
  .empty{text-align:center; color:var(--empty-color); padding:20px;}
  #qrGerado canvas{margin-top:10px;}
  @media(max-width:600px){
    input, button{width:100%; margin-bottom:10px;}
    .filters, .qr-buttons{display:flex; flex-direction:column; gap:10px;}
  }
</style>

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<!-- QRCode.js (gera QR offline) -->
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>

</head>
<body>

<!-- LOGIN -->
<div class="box" id="loginBox">
  <h1>ðŸ“¡ ESIP-Sistemas â€” Login Admin</h1>
  <div>
    <input type="text" id="loginUser" placeholder="SOUSA"><br>
    <input type="password" id="loginPass" placeholder="ESIP2025"><br>
    <button onclick="login()">Entrar</button>
  </div>
</div>

<!-- PAINEL -->
<div id="painelBox" style="display:none;">
  <div id="boasVindas" style="text-align:center; font-size:16px; margin-bottom:10px; color:#03a9f4; display:none;"></div>

  <div class="box">
    <h1>ðŸ“¡ Painel do Administrador</h1>

    <div class="filters" style="margin-bottom:15px;">
      <input type="text" id="filtroCPF" placeholder="Filtrar por CPF" maxlength="11">
      <input type="text" id="filtroEvento" placeholder="Filtrar por Evento">
      <input type="text" id="filtroNomeEvento" placeholder="Filtrar por Nome do Evento">
      <button onclick="carregar()">Filtrar</button>
    </div>

    <button onclick="exportarCSV()">Exportar CSV (Admin)</button>

    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>CPF</th>
          <th>Evento</th>
          <th>Nome do Evento</th>
          <th>Data/Hora</th>
          <th>QR Code</th>
        </tr>
      </thead>
      <tbody id="lista"></tbody>
    </table>

    <div id="vazio" class="empty">Nenhum ingresso gerado ainda.</div>
  </div>

  <div class="box">
    <h2>Gerador de QR e PDF do Cliente</h2>
    <div class="qr-buttons">
      <input type="text" id="geradorCPF" placeholder="CPF" maxlength="11">
      <input type="text" id="geradorNomeEvento" placeholder="Nome do Evento">
      <input type="text" id="geradorEvento" placeholder="Evento">
      <button onclick="gerarIngresso()">Gerar Ingresso / QR</button>
      <button onclick="exportarPDFCliente()">Exportar PDF</button>
      <button onclick="logout()">Logout</button>
    </div>
    <div id="qrGerado"></div>
  </div>

</div>

<script>
/* ====================================================
   LOGIN SEGURO â€” HASH SHAâ€‘256
   Senha correta: ESIP2025
   ==================================================== */

const HASH_SENHA = "5e8807c8fe34f35f8fae8ba4af17a662a28aeefcee8eb0b4833a1b1c04e0b3c8";
const USUARIO_CORRETO = "SOUSA";

async function gerarHash(texto){
    const encoder = new TextEncoder();
    const data = encoder.encode(texto);
    const hashBuffer = await crypto.subtle.digest("SHA-256", data);
    return Array.from(new Uint8Array(hashBuffer)).map(b=>b.toString(16).padStart(2,"0")).join("");
}

async function login(){
    const user = document.getElementById('loginUser').value.trim();
    const pass = document.getElementById('loginPass').value.trim();

    if(!user || !pass){ alert("Preencha usuÃ¡rio e senha!"); return; }

    const hashDigitada = await gerarHash(pass);

    if(user === USUARIO_CORRETO && hashDigitada === HASH_SENHA){
        localStorage.setItem("logado","true");
        mostrarPainel();
    } else {
        alert("UsuÃ¡rio ou senha incorretos!");
    }
}

function mostrarPainel(){
  document.getElementById('loginBox').style.display='none';
  document.getElementById('painelBox').style.display='block';
  document.getElementById('boasVindas').textContent = `Bem-vindo, ${USUARIO_CORRETO}!`;
  document.getElementById('boasVindas').style.display='block';
  carregar();
}

function logout(){
  localStorage.removeItem('logado');
  document.getElementById('painelBox').style.display='none';
  document.getElementById('loginBox').style.display='block';
}

if(localStorage.getItem('logado') === 'true') mostrarPainel();

/* ====================================================
   SISTEMA DE INGRESSOS â€” LOCALSTORAGE
   ==================================================== */

function carregar(){
  let ingressos = JSON.parse(localStorage.getItem('ingressos') || '[]');

  const filtroCPF = document.getElementById('filtroCPF').value.trim();
  const filtroEvento = document.getElementById('filtroEvento').value.trim().toLowerCase();
  const filtroNome = document.getElementById('filtroNomeEvento').value.trim().toLowerCase();

  let listaFiltrada = ingressos;
  if(filtroCPF) listaFiltrada = listaFiltrada.filter(i=>i.cpf.includes(filtroCPF));
  if(filtroEvento) listaFiltrada = listaFiltrada.filter(i=>i.evento.toLowerCase().includes(filtroEvento));
  if(filtroNome) listaFiltrada = listaFiltrada.filter(i=>i.nomeEvento.toLowerCase().includes(filtroNome));

  const corpo = document.getElementById('lista');
  corpo.innerHTML='';

  if(listaFiltrada.length === 0){
    document.getElementById('vazio').style.display='block';
  } else {
    document.getElementById('vazio').style.display='none';

    listaFiltrada.forEach(i=>{
      const tr = document.createElement('tr');
      const dataHora = new Date(i.hora).toLocaleString('pt-BR');

      const tdQR = document.createElement('td');
      const canvas = document.createElement('canvas');
      QRCode.toCanvas(canvas, i.id, {width:50});
      tdQR.appendChild(canvas);

      tr.innerHTML = `
        <td>${i.id}</td>
        <td>${i.cpf}</td>
        <td>${i.evento}</td>
        <td>${i.nomeEvento}</td>
        <td>${dataHora}</td>
      `;
      tr.appendChild(tdQR);
      corpo.appendChild(tr);
    });
  }
}

function gerarIngresso(){
  let ingressos = JSON.parse(localStorage.getItem('ingressos') || '[]');

  const cpf = document.getElementById('geradorCPF').value.trim();
  const nomeEvento = document.getElementById('geradorNomeEvento').value.trim();
  const evento = document.getElementById('geradorEvento').value.trim();

  if(!/^\d{11}$/.test(cpf)){ alert('CPF deve ter 11 dÃ­gitos'); return; }
  if(!nomeEvento || !evento){ alert('Preencha todos os campos'); return; }

  const id = "ID" + Date.now();
  const hora = Date.now();

  const ingresso = { id, cpf, evento, nomeEvento, hora };
  ingressos.push(ingresso);
  localStorage.setItem('ingressos', JSON.stringify(ingressos));

  const qrContainer = document.getElementById('qrGerado');
  qrContainer.innerHTML = '';
  const canvas = document.createElement('canvas');
  QRCode.toCanvas(canvas, id, {width:200});
  qrContainer.appendChild(canvas);

  carregar();
}

function exportarCSV(){
  let ingressos = JSON.parse(localStorage.getItem('ingressos') || '[]');

  if(ingressos.length === 0){ alert('Nenhum ingresso para exportar'); return; }

  const headers = ['ID','CPF','Evento','Nome do Evento','Data/Hora'];
  const rows = ingressos.map(i => [
    i.id, i.cpf, i.evento, i.nomeEvento,
    new Date(i.hora).toLocaleString('pt-BR')
  ]);

  let csv = headers.join(',') + '\n';
  rows.forEach(r => csv += r.map(f => `"${f}"`).join(',') + '\n');

  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = 'ingressos.csv';
  link.click();
}

async function exportarPDFCliente(){
  let ingressos = JSON.parse(localStorage.getItem('ingressos') || '[]');
  const cpf = document.getElementById('geradorCPF').value.trim();

  if(!/^\d{11}$/.test(cpf)){ alert('CPF invÃ¡lido'); return; }

  const ingressosCliente = ingressos.filter(i => i.cpf === cpf);

  if(ingressosCliente.length === 0){
    alert("Nenhum ingresso encontrado");
    return;
  }

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  for(let index = 0; index < ingressosCliente.length; index++){
    const i = ingressosCliente[index];

    doc.setFontSize(16);
    doc.text("ðŸ“¡ ESIP-Sistemas â€” Ingresso", 105, 20, {align:"center"});

    doc.setFontSize(12);
    const dataHora = new Date(i.hora).toLocaleString('pt-BR');

    doc.text(`ID: ${i.id}`, 105, 40, {align:"center"});
    doc.text(`CPF: ${i.cpf}`, 105, 50, {align:"center"});
    doc.text(`Evento: ${i.evento}`, 105, 60, {align:"center"});
    doc.text(`Nome do Evento: ${i.nomeEvento}`, 105, 70, {align:"center"});
    doc.text(`Data/Hora: ${dataHora}`, 105, 80, {align:"center"});

    const canvas = document.createElement('canvas');
    await QRCode.toCanvas(canvas, i.id, {width:120});
    const imgData = canvas.toDataURL('image/png');

    doc.addImage(imgData, 'PNG', 45, 90, 120, 120);

    if(index < ingressosCliente.length - 1) doc.addPage();
  }

  doc.save(`ingressos_${cpf}.pdf`);
}
</script>

</body>
</html>

