<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Leitor Vermelho</title>

<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body {
    background: #2b0000;
    color: white;
    font-family: Arial, sans-serif;
    text-align: center;
    margin: 0;
}
#reader {
    width: 350px;
    margin: 20px auto;
    border: 4px solid #ff0000;
    border-radius: 10px;
}
.btn {
    background: #ff0000;
    color: white;
    padding: 12px 18px;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    margin-top: 15px;
    width: 90%;
}
#msg {
    margin-top: 20px;
    font-size: 22px;
    font-weight: bold;
}
.green { color: #00ff88; }
.red { color: #ff4444; }
</style>
</head>
<body>

<h2>ğŸ“• Leitor Vermelho</h2>

<div id="reader"></div>

<button id="toggleLight" class="btn">ğŸ”¦ Ligar Lanterna</button>

<div id="msg"></div>

<script>
let html5Qr;
let flashOn = false;
let scanning = true;
let used = new Set(JSON.parse(localStorage.getItem("usedCodes") || "[]"));

// ======== Sons ========
const beepValid   = new Audio("https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg");
const beepInvalid = new Audio("https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg");
const beepUsed    = new Audio("https://actions.google.com/sounds/v1/cartoon/pop.ogg");

// ======== Interface ========
function showMsg(text, good = true) {
    const box = document.getElementById("msg");
    box.innerHTML = text;
    box.className = good ? "green" : "red";
}

// ======== ValidaÃ§Ã£o bÃ¡sica ========
function validateCode(code) {
    return code.startsWith("INGR-");
}

// ======== LÃ³gica de leitura Ãºnica ========
function processQR(decodedText) {

    if (!scanning) return;  // trava mÃºltiplas leituras
    scanning = false;

    const code = decodedText.trim();

    if (!validateCode(code)) {
        beepInvalid.play().catch(()=>{});
        navigator.vibrate?.([120, 30, 120]);
        showMsg("âŒ QR INVÃLIDO", false);
    }
    else if (!used.has(code)) {
        used.add(code);
        localStorage.setItem("usedCodes", JSON.stringify([...used]));
        beepValid.play().catch(()=>{});
        navigator.vibrate?.([30,20,30]);
        showMsg("âœ… Ingresso vÃ¡lido", true);
    }
    else {
        beepUsed.play().catch(()=>{});
        navigator.vibrate?.(80);
        showMsg("âš ï¸ JÃ¡ utilizado", false);
    }

    // destrava leitura quando QR sair da cÃ¢mera
    setTimeout(() => { scanning = true; }, 600);
}

// ======== Iniciar cÃ¢mera ========
function startScanner() {
    html5Qr = new Html5Qrcode("reader");

    Html5Qrcode.getCameras().then(devices => {
        const backCam = devices.find(d => d.label.toLowerCase().includes("back")) || devices[0];

        html5Qr.start(
            backCam.id,
            {
                fps: 10,
                qrbox: 250
            },
            processQR,
            () => {}
        );
    });
}

startScanner();

// ======== Lanterna ========
document.getElementById("toggleLight").onclick = async () => {
    try {
        const track = html5Qr.getState() === 2
            ? html5Qr._previewVideo.srcObject.getVideoTracks()[0]
            : null;

        if (!track) {
            showMsg("ğŸ“· CÃ¢mera nÃ£o pronta", false);
            return;
        }

        const capabilities = track.getCapabilities();
        if (!capabilities.torch) {
            showMsg("âš ï¸ Lanterna nÃ£o suportada", false);
            return;
        }

        flashOn = !flashOn;

        await track.applyConstraints({
            advanced: [{ torch: flashOn }]
        });

        document.getElementById("toggleLight").innerText = flashOn ? "ğŸ”¦ Desligar Lanterna" : "ğŸ”¦ Ligar Lanterna";

    } catch (e) {
        showMsg("Erro ao usar lanterna", false);
    }
};
</script>

</body>
</html>

