
<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Leitor ESIP â€” Offline</title>
<script src="https://unpkg.com/html5-qrcode"></script>
<style>
body{margin:0;font-family:Arial;background:#290000;color:#ffeaea;transition:background .4s;}
body.dark{background:#000;color:#fff;}
header{background:#8b0000;color:#fff;padding:14px 20px;display:flex;align-items:center;gap:12px;}
header h1{margin:0;font-size:22px;}
.box{background:#ffffff15;padding:18px;margin:20px auto;border-radius:14px;max-width:450px;color:#fff;}
input{width:100%;padding:12px;border-radius:10px;border:none;margin-top:8px;}
button{padding:12px;border:none;border-radius:12px;cursor:pointer;margin-top:8px;}
.valid{background:#0e8f4f;color:#fff;}
.invalid{background:#a00000;color:#fff;}
.counterBox{margin-top:10px;font-weight:bold;}
#logBox{margin-top:10px;max-height:200px;overflow:auto;}
.floatBtn{position:fixed;bottom:20px;right:20px;background:#ff0000;padding:18px;border-radius:50%;font-size:24px;}
#flashBtn{bottom:80px;background:#ffaa00;}
#exportBtn{background:#0080ff;color:#fff;font-weight:bold;margin-top:10px;}
</style>
</head>
<body>

<header>
  <h1>ðŸ“¡ ESIP Leitor â€” Offline</h1>
</header>

<div class="box" id="loginBox">
  <h2>Login</h2>
  <input id="senha" type="password" placeholder="Senha">
  <button onclick="login()">Entrar</button>
</div>

<div class="box" id="scanBox" style="display:none;">
  <h2>Scanner de QR</h2>
  <div id="reader" style="width:100%"></div>

  <div class="counterBox">
    Entradas vÃ¡lidas: <span id="contadorValid">0</span><br>
    Entradas invÃ¡lidas: <span id="contadorInvalid">0</span>
  </div>

  <div id="msgArea"></div>
  <div id="logBox"></div>
  <button id="exportBtn" onclick="exportCSV()">ðŸ’¾ Exportar CSV</button>
</div>

<button class="floatBtn" onclick="toggleDarkMode()">ðŸŒ“</button>
<button class="floatBtn" id="flashBtn" onclick="toggleFlash()">ðŸ”¦</button>

<script>
const SECRET_KEY = "ESIP-SECRETO-2025";
let used = new Set(JSON.parse(localStorage.getItem("usedCodes")||"[]"));
let log = JSON.parse(localStorage.getItem("logESIP")||"[]");
let countValid = log.filter(l=>l.status==="vÃ¡lido").length;
let countInvalid = log.filter(l=>l.status==="invÃ¡lido").length;
let qrScanner = null;
const cooldowns = new Map();
const cooldownTime = 3000;
let currentStream = null;
let flashOn = false;

// ---------- Sons offline ----------
const beepValid = new Audio();
const beepInvalid = new Audio();
beepValid.src = "data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAIA+AAACABAAZGF0YQAAAAA="; // curto beep vÃ¡lido
beepInvalid.src = "data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAIA+AAACABAAZGF0YQAAAAA="; // curto beep invÃ¡lido

// ---------- Login ----------
function login(){
  const s = document.getElementById("senha").value.trim();
  if(s==="ESIP2025"){
    document.getElementById("loginBox").style.display="none";
    document.getElementById("scanBox").style.display="block";
    updateCounters();
    startScanner();
  } else alert("Senha incorreta!");
}

// ---------- Scanner ----------
function startScanner(){
  qrScanner = new Html5Qrcode("reader");
  Html5Qrcode.getCameras().then(cameras=>{
    if(!cameras.length) return alert("Nenhuma cÃ¢mera encontrada!");
    const rear = cameras.find(c=>c.facingMode==="environment") || cameras[0];
    qrScanner.start(
      rear.id,
      {fps:10, qrbox:250},
      processQR,
      err=>console.log(err)
    ).then(() => {
      currentStream = qrScanner.getState().stream;
    });
  }).catch(err=>alert("Erro ao acessar cÃ¢mera: "+err));
}

// ---------- Lanterna ----------
function toggleFlash(){
  if(!currentStream) return alert("CÃ¢mera ainda nÃ£o iniciada.");
  const track = currentStream.getVideoTracks()[0];
  const capabilities = track.getCapabilities();
  if(!capabilities.torch) return alert("Lanterna nÃ£o suportada.");
  flashOn = !flashOn;
  track.applyConstraints({advanced:[{torch: flashOn}]}).catch(e=>alert(e));
}

// ---------- Valida QR ----------
function validateCode(code){
  const parts = code.split("-");
  if(parts.length<3 || parts[0]!=="ESIP") return false;
  const uuid = parts[1], hash = parts[2];
  return hash === btoa(uuid + SECRET_KEY);
}

// ---------- Processa QR ----------
function processQR(decodedText){
  const now = Date.now();
  if(cooldowns.get(decodedText) && now - cooldowns.get(decodedText)<cooldownTime) return;
  cooldowns.set(decodedText, now);

  if(!validateCode(decodedText)){
    countInvalid++;
    showMessage("QR INVÃLIDO âŒ", false);
    playBeep(false);
    logEntry(decodedText,"invÃ¡lido");
    return updateCounters();
  }

  if(!used.has(decodedText)){
    used.add(decodedText);
    localStorage.setItem("usedCodes", JSON.stringify([...used]));
    countValid++;
    showMessage("Ingresso vÃ¡lido âœ…", true);
    playBeep(true);
    logEntry(decodedText,"vÃ¡lido");
  } else {
    countInvalid++;
    showMessage("INGRESSO JÃ UTILIZADO âŒ", false);
    playBeep(false);
  }
  updateCounters();
}

// ---------- Mensagem ----------
function showMessage(msg, ok){
  const area = document.getElementById("msgArea");
  const div = document.createElement("div");
  div.className = ok?"valid":"invalid";
  div.innerText = msg;
  area.appendChild(div);
  const displayTime = ok ? 5000 : 6000;
  setTimeout(()=>div.remove(), displayTime);
}

// ---------- Beep ----------
function playBeep(valid){
  (valid ? beepValid : beepInvalid).play();
}

// ---------- Log ----------
function logEntry(code,status){
  log.push({codigo:code,status:status,hora:new Date().toLocaleString()});
  localStorage.setItem("logESIP",JSON.stringify(log));
  updateLog();
}
function updateLog(){
  const box = document.getElementById("logBox");
  box.innerHTML = log.slice().reverse()
    .map(l=>`<div>${l.status} â€” ${l.codigo} â€” ${l.hora}</div>`).join("");
}

// ---------- Contadores ----------
function updateCounters(){
  document.getElementById("contadorValid").innerText = countValid;
  document.getElementById("contadorInvalid").innerText = countInvalid;
}

// ---------- Export CSV ----------
function exportCSV(){
  let csv="codigo,status,hora\n";
  log.forEach(l=>csv+=`${l.codigo},${l.status},${l.hora}\n`);
  const blob = new Blob([csv],{type:"text/csv"});
  const a=document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download="log_entradas.csv";
  a.click();
}

// ---------- Modo escuro ----------
function toggleDarkMode(){document.body.classList.toggle("dark");}
</script>

</body>
</html>
