<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Leitor ESIP â€” Pro+ Vermelho</title>
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<style>
body{margin:0;font-family:Arial;background:#290000;color:#ffeaea;transition:background 0.4s ease, color 0.4s ease;}
body.dark{background:#000;color:#fff;}
header{background:#8b0000;color:#fff;padding:14px 20px;display:flex;align-items:center;gap:12px;box-shadow:0 2px 8px #0004;}
header h1{margin:0;font-size:22px;}
.box{background:#ffffff15;padding:18px;margin:20px auto;border-radius:14px;max-width:430px;box-shadow:0 4px 14px #0003;backdrop-filter:blur(6px);color:#fff;}
input{width:100%;padding:12px;border-radius:10px;border:none;font-size:16px;margin-top:8px;}
button{padding:12px 18px;border:none;border-radius:12px;font-size:17px;cursor:pointer;transition:transform .15s ease, box-shadow .15s ease;}
button:active{transform:scale(0.94);box-shadow:0 0 12px #0005 inset;}
.ok{background:#ff0000;color:#fff;}
.err{background:#990000;color:#fff;}
.floatBtn{position:fixed;bottom:20px;right:20px;background:#ff0000;padding:18px;border-radius:50%;box-shadow:0 4px 15px #0006;font-size:24px;z-index:999;}
.msg{padding:14px;margin-top:14px;border-radius:8px;display:flex;justify-content:space-between;align-items:center;font-weight:bold;}
.valid{background:#0e8f4f;color:#fff;}
.invalid{background:#a00000;color:#fff;}
#logBox{margin-top:20px;font-size:14px;max-height:160px;overflow:auto;background:#ffffff10;padding:12px;border-radius:8px;box-shadow:0 1px 4px #0003;}
.counterBox{background:#ffffff15;padding:12px;border-radius:10px;margin-top:15px;font-weight:bold;text-align:center;color:#fff;box-shadow:0 1px 4px #0003;}
</style>
</head>
<body>

<header>
  <h1>ðŸ“¡ ESIP-Sistemas â€” Leitor Pro+ Vermelho</h1>
</header>

<div class="box" id="loginBox">
  <h2>Login</h2>
  <p>Digite a senha:</p>
  <input id="senha" type="password">
  <button class="ok" style="margin-top:14px;width:100%" onclick="login()">Entrar</button>
</div>

<div class="box" id="scanBox" style="display:none">
  <h2>Scanner</h2>
  <div id="reader" style="width:100%"></div>
  <button id="btnFlash" class="ok" style="margin-top:12px;width:100%" onclick="toggleFlash()">ðŸ”¦ Ligar Lanterna</button>

  <div class="counterBox">
    Entradas vÃ¡lidas: <span id="contadorValid">0</span><br>
    Entradas invÃ¡lidas: <span id="contadorInvalid">0</span>
  </div>

  <div id="msgArea"></div>
  <h3>Log de entradas</h3>
  <div id="logBox"></div>

  <button class="ok" style="margin-top:10px;width:100%" onclick="exportCSV()">Exportar CSV</button>
  <button class="err" style="margin-top:10px;width:100%" onclick="limparLog()">Limpar Log</button>
</div>

<button class="floatBtn" onclick="toggleDarkMode()">ðŸŒ“</button>

<audio id="somOk" src="https://cdn.pixabay.com/download/audio/2023/06/29/audio_25c0700121.mp3?filename=success-158310.mp3"></audio>
<audio id="somErro" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_4e6261a0ef.mp3?filename=error-126627.mp3"></audio>

<script>
// ---------- ConfiguraÃ§Ãµes ----------
const SECRET_KEY = "ESIP-SECRETO-2025"; 
let used = new Set(JSON.parse(localStorage.getItem("usedCodes")||"[]"));
let log = JSON.parse(localStorage.getItem("logESIP")||"[]");
let countValid = log.filter(l=>l.status==="vÃ¡lido").length;
let countInvalid = log.filter(l=>l.status==="invÃ¡lido").length;

let qrScanner=null;
let cameraTrack=null;
let flashOn=false;
let selectedCameraId=null;
const codeCooldowns = new Map(); 
const cooldownTime = 3000; // 3 segundos

navigator.vibrate = navigator.vibrate || function(){};

// ---------- Login ----------
function login(){
  const senha = document.getElementById("senha").value.trim();
  if(senha === "ESIP2025"){
    document.getElementById("loginBox").style.display="none";
    document.getElementById("scanBox").style.display="block";
    updateCounters();
    setTimeout(startScanner,300);
  } else { alert("Senha incorreta!"); }
}

// ---------- Scanner ----------
function startScanner() {
  qrScanner = new Html5Qrcode("reader");
  Html5Qrcode.getCameras().then(cameras => {
    if (!cameras || cameras.length === 0) { alert("Nenhuma cÃ¢mera encontrada!"); return; }
    selectedCameraId = cameras[0].id; // pega apenas a traseira
    startCamera(selectedCameraId);
  });
}

function startCamera(cameraId){
  qrScanner.start(
    cameraId,
    { fps: 10, qrbox: 250 },
    (decodedText)=>{ if(decodedText) processQR(decodedText); },
    (error)=>{}
  ).then(()=>{
    const stream = document.querySelector('video').srcObject;
    cameraTrack = stream.getVideoTracks()[0];
    flashOn = false;
    document.getElementById("btnFlash").innerText = "ðŸ”¦ Ligar Lanterna";
  });
}

function stopScanner(){ if(qrScanner){ qrScanner.stop().catch(()=>{}); } }

// ---------- Lanterna ----------
function toggleFlash(){
  if(!cameraTrack){ alert("CÃ¢mera ainda nÃ£o carregou."); return; }
  flashOn = !flashOn;
  cameraTrack.applyConstraints({advanced:[{torch:flashOn}]}).then(()=>{
    document.getElementById("btnFlash").innerText = flashOn?"ðŸ”¦ Desligar Lanterna":"ðŸ”¦ Ligar Lanterna";
  }).catch(()=>{
    alert("Lanterna nÃ£o suportada nesta cÃ¢mera."); flashOn=false;
    document.getElementById("btnFlash").innerText="ðŸ”¦ Ligar Lanterna";
  });
}

// ---------- ValidaÃ§Ã£o do QR ----------
function validateCode(code){
  const parts = code.split("-");
  if(parts.length<3 || parts[0]!=="ESIP") return false;
  const uuid = parts[1];
  const hash = parts[2];
  const check = btoa(uuid + SECRET_KEY);
  return hash === check;
}

// ---------- Processamento do QR ----------
function processQR(code){
  const somOk=document.getElementById("somOk");
  const somErro=document.getElementById("somErro");
  const now=Date.now();

  if(!validateCode(code)){
    countInvalid++; somErro.play(); navigator.vibrate(200);
    logEntry(code,"invÃ¡lido"); updateCounters(); return showMessage("QR INVÃLIDO",false);
  }

  if(used.has(code)){
    const lastRead = codeCooldowns.get(code) || 0;
    if(now - lastRead < cooldownTime){
      somErro.play(); navigator.vibrate(200);
      return showMessage("INGRESSO JÃ UTILIZADO",false);
    }
  }

  if(!used.has(code)){
    used.add(code); localStorage.setItem("usedCodes",JSON.stringify([...used]));
    countValid++; logEntry(code,"vÃ¡lido");
    somOk.play(); navigator.vibrate([80,50,80]);
    showMessage("Ingresso vÃ¡lido",true);
  } else {
    showMessage("INGRESSO JÃ UTILIZADO",false);
    somErro.play(); navigator.vibrate(200);
  }

  codeCooldowns.set(code, now);
  updateCounters();
}

// ---------- Mensagens e log ----------
function showMessage(text,ok){
  const area=document.getElementById("msgArea");
  const div=document.createElement("div");
  div.className="msg "+(ok?"valid":"invalid");
  div.innerHTML=`<span>${text}</span><button style="background:none;border:none;font-size:20px;color:#fff;cursor:pointer">Ã—</button>`;
  div.querySelector("button").onclick = ()=>div.remove();
  area.appendChild(div);
  setTimeout(()=>div.remove(),4000);
}

function logEntry(code,status){
  const entry={codigo:code,status:status,hora:new Date().toLocaleString()};
  log.push(entry); localStorage.setItem("logESIP",JSON.stringify(log));
  updateLogBox();
}

function updateLogBox(){
  const box=document.getElementById("logBox");
  let html="";
  log.slice().reverse().forEach(l=>{
    html+=`<div><b>${l.status}</b> â€” ${l.codigo}<br><small>${l.hora}</small></div><hr>`;
  });
  box.innerHTML=html;
}

function updateCounters(){
  document.getElementById("contadorValid").innerText=countValid;
  document.getElementById("contadorInvalid").innerText=countInvalid;
}

function limparLog(){
  if(confirm("Tem certeza que deseja limpar o log?")){
    log=[]; used.clear(); codeCooldowns.clear();
    localStorage.removeItem("logESIP"); localStorage.removeItem("usedCodes");
    updateLogBox(); countValid=0; countInvalid=0; updateCounters();
  }
}

function exportCSV(){
  let csv="codigo,status,hora\n";
  log.forEach(l=>csv+=`${l.codigo},${l.status},${l.hora}\n`);
  const blob=new Blob([csv],{type:"text/csv"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a"); a.href=url; a.download="entradas_esip_vermelho.csv"; a.click();
}

function toggleDarkMode(){document.body.classList.toggle("dark");}
</script>

</body>
</html>
