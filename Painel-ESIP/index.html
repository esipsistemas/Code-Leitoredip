<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Leitor ESIP â€” Offline</title>
<script src="https://unpkg.com/html5-qrcode"></script>
<style>
body{margin:0;font-family:Arial;background:#290000;color:#ffeaea;transition:background .4s;}
body.dark{background:#000;color:#fff;}
header{background:#8b0000;color:#fff;padding:14px 20px;display:flex;align-items:center;gap:12px;}
header h1{margin:0;font-size:22px;}
.box{background:#ffffff15;padding:18px;margin:20px auto;border-radius:14px;max-width:450px;color:#fff;}
input{width:100%;padding:12px;border-radius:10px;border:none;margin-top:8px;}
button{padding:12px;border:none;border-radius:12px;cursor:pointer;margin-top:8px;}
.valid{background:#0e8f4f;color:#fff;}
.invalid{background:#a00000;color:#fff;}
.warning{background:#ffaa00;color:#000;}
.counterBox{margin-top:10px;font-weight:bold;}
#logBox{margin-top:10px;max-height:200px;overflow:auto;}
.floatBtn{position:fixed;bottom:20px;right:20px;background:#ff0000;padding:18px;border-radius:50%;font-size:24px;z-index:999;}
#flashBtn{bottom:80px;background:#ffaa00;}
#switchCamBtn{bottom:140px;background:#00ff80;}
#exportBtn{background:#0080ff;color:#fff;font-weight:bold;margin-top:10px;}
</style>
</head>
<body>

<header>
  <h1>ðŸ“¡ ESIP Leitor â€” Offline</h1>
</header>

<div class="box" id="loginBox">
  <h2>Login</h2>
  <input id="senha" type="password" placeholder="Senha">
  <button onclick="login()">Entrar</button>
</div>

<div class="box" id="scanBox" style="display:none;">
  <h2>Scanner de QR</h2>
  <div id="reader" style="width:100%;"></div>

  <div class="counterBox">
    Entradas vÃ¡lidas: <span id="contadorValid">0</span><br>
    Entradas invÃ¡lidas: <span id="contadorInvalid">0</span>
  </div>

  <div id="msgArea"></div>
  <div id="logBox"></div>
  <button id="exportBtn" onclick="exportCSV()">ðŸ’¾ Exportar CSV</button>
  <button onclick="clearLog()">ðŸ—‘ Limpar Log</button>
</div>

<button class="floatBtn" onclick="toggleDarkMode()">ðŸŒ“</button>
<button class="floatBtn" id="flashBtn" onclick="toggleFlash()">ðŸ”¦</button>
<button class="floatBtn" id="switchCamBtn" onclick="switchCamera()">ðŸ”„</button>

<script>
const SECRET_KEY = "ESIP-SECRETO-2025";
let used = new Set(JSON.parse(localStorage.getItem("usedCodes")||"[]"));
let log = JSON.parse(localStorage.getItem("logESIP")||"[]");
let countValid = log.filter(l=>l.status==="vÃ¡lido").length;
let countInvalid = log.filter(l=>l.status==="invÃ¡lido").length;

let qrScanner = null;
let currentCameraId = null;
let flashOn = false;
const cooldowns = new Map();
const cooldownTime = 3000;

// CÃ¢meras
let camerasList = [];
let currentCameraIndex = 0;

// sons
const beepValid = new Audio("data:audio/wav;base64,UklGRrYAAABXQVZFZm10IBAAAAABAAEAIlYAAESsAAACABAAZGF0YYAAAAD///8=");
const beepInvalid = new Audio("data:audio/wav;base64,UklGRpIAAABXQVZFZm10IBAAAAABAAEAIlYAAESsAAACABAAZGF0YQAAAAA=");
const beepUsed = new Audio("data:audio/wav;base64,UklGRlIAAABXQVZFZm10IBAAAAABAAEAIlYAAESsAAACABAAZGF0YQAAAAA=");

// Login
function login(){
  const s = document.getElementById("senha").value.trim();
  if(s==="ESIP2025"){
    document.getElementById("loginBox").style.display="none";
    document.getElementById("scanBox").style.display="block";
    updateCounters();
    startScanner();
  } else alert("Senha incorreta!");
}

// Scanner
async function startScanner(cameraId = null){
  if(qrScanner){
    try { await qrScanner.stop(); } catch(e){}
  }

  try {
    const cams = await Html5Qrcode.getCameras();
    if(!cams.length) return alert("Nenhuma cÃ¢mera encontrada!");

    camerasList = cams;

    let cam = cameraId 
      ? cams.find(c=>c.id===cameraId)
      : cams.find(c=>c.facingMode==="environment") || cams[0];

    currentCameraId = cam.id;
    currentCameraIndex = cams.findIndex(c => c.id === cam.id);

    qrScanner = new Html5Qrcode("reader");

    qrScanner.start(
      { deviceId:{ exact: cam.id }},
      { fps: 10, qrbox: 250 },
      processQR,
      err => {}
    );

  } catch(e){
    alert("Erro ao iniciar scanner: "+e.message);
  }
}

// Trocar cÃ¢mera
function switchCamera(){
  if(!camerasList.length) return alert("CÃ¢meras nÃ£o carregadas.");
  currentCameraIndex = (currentCameraIndex + 1) % camerasList.length;
  startScanner(camerasList[currentCameraIndex].id);
}

// Lanterna
async function toggleFlash(){
  try{
    const track = qrScanner.getState()?.stream?.getVideoTracks?.()[0];
    if(!track) return alert("CÃ¢mera nÃ£o pronta.");

    const capabilities = track.getCapabilities();
    if(!capabilities.torch) return alert("Lanterna nÃ£o suportada.");

    flashOn = !flashOn;
    await track.applyConstraints({ advanced:[{ torch: flashOn }] });

  } catch(e){
    alert("Erro ao alternar a lanterna: " + e.message);
  }
}

// ValidaÃ§Ã£o
function validateCode(code){
  const parts = code.split("-");
  return parts[0]==="ESIP" && parts[2] === btoa(parts[1] + SECRET_KEY);
}

// Process QR
function processQR(decodedText){
  const now = Date.now();
  if(cooldowns.get(decodedText) && now - cooldowns.get(decodedText) < cooldownTime) return;
  cooldowns.set(decodedText, now);

  if(!validateCode(decodedText)){
    countInvalid++;
    showMessage("QR INVÃLIDO âŒ", false);
    playBeep("invalid");
    logEntry(decodedText, "invÃ¡lido");
    return updateCounters();
  }

  if(!used.has(decodedText)){
    used.add(decodedText);
    localStorage.setItem("usedCodes", JSON.stringify([...used]));
    countValid++;
    showMessage("Ingresso vÃ¡lido âœ…", true);
    playBeep("valid");
    logEntry(decodedText, "vÃ¡lido");
  } else {
    countInvalid++;
    showMessage("INGRESSO JÃ UTILIZADO âŒ", "used");
    playBeep("used");
    logEntry(decodedText, "invÃ¡lido");
  }

  updateCounters();
}

// Mensagem
function showMessage(msg,type){
  const area = document.getElementById("msgArea");
  const div = document.createElement("div");

  if(type===true) div.className="valid";
  else if(type===false) div.className="invalid";
  else div.className="warning";

  div.innerText = msg;
  area.appendChild(div);
  setTimeout(()=>div.remove(), type===true?5000:6000);
}

// Beep
function playBeep(type){
  if(type==="valid") beepValid.play();
  else if(type==="invalid") beepInvalid.play();
  else beepUsed.play();
}

// Log
function logEntry(code,status){
  log.push({ codigo:code, status:status, hora:new Date().toLocaleString() });
  localStorage.setItem("logESIP", JSON.stringify(log));
  updateLog();
}

function updateLog(){
  const box = document.getElementById("logBox");
  box.innerHTML = log.slice().reverse().map(
    l=>`<div>${l.status} â€” ${l.codigo} â€” ${l.hora}</div>`
  ).join("");
}

// Contadores
function updateCounters(){
  document.getElementById("contadorValid").innerText = countValid;
  document.getElementById("contadorInvalid").innerText = countInvalid;
}

// Exportar CSV
function exportCSV(){
  let csv="codigo,status,hora\n";
  log.forEach(l=>csv+=`${l.codigo},${l.status},${l.hora}\n`);
  const blob = new Blob([csv],{type:"text/csv"});
  const a=document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download="log_entradas.csv";
  a.click();
}

// Limpar log
function clearLog(){
  if(!confirm("Deseja realmente limpar todo o log?")) return;
  log=[]; used.clear();
  localStorage.removeItem("logESIP");
  localStorage.removeItem("usedCodes");
  countValid=0; countInvalid=0;
  updateCounters(); updateLog();
}

// Dark mode
function toggleDarkMode(){
  document.body.classList.toggle("dark");
}
</script>

</body>
</html>

