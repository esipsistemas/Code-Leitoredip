<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Leitor ESIP ‚Äî Offline (Corrigido)</title>
<script src="https://unpkg.com/html5-qrcode"></script>
<style>
  :root{--bg:#0b1020;--card:#0f1724;--accent:#00b7ff;--success:#0ec27a;--danger:#ff4d4f;--muted:#94a3b8}
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,Segoe UI,Arial;background:linear-gradient(180deg,var(--bg),#071026);color:#e6eef8;min-height:100vh}
  .container{max-width:920px;margin:24px auto;padding:18px}
  .header{display:flex;justify-content:space-between;align-items:center;gap:12px}
  .brand{font-weight:700;color:var(--accent)}
  .card{background:var(--card);border-radius:12px;padding:16px;margin-top:14px;border:1px solid rgba(255,255,255,0.03)}
  .row{display:flex;gap:12px;align-items:center}
  .btn{background:var(--accent);color:#021125;padding:8px 12px;border-radius:8px;border:none;cursor:pointer}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
  .left{flex:1}
  #reader{width:100%;max-width:480px;margin:10px auto;border-radius:8px;overflow:hidden;background:#000}
  .info{padding:10px;border-radius:8px;margin-top:10px}
  .ok{background:rgba(14,194,122,0.12);color:var(--success);}
  .err{background:rgba(255,77,79,0.12);color:var(--danger)}
  .small{font-size:13px;color:var(--muted)}
  .counters{display:flex;gap:12px;margin-top:10px}
  .counter{flex:1;background:rgba(255,255,255,0.02);padding:10px;border-radius:8px;text-align:center}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
  #logBox{max-height:240px;overflow:auto;background:rgba(255,255,255,0.02);padding:8px;border-radius:8px;margin-top:12px}
  footer{margin-top:18px;text-align:center;color:var(--muted);font-size:13px}
  .flash-on { background: #ffd60a !important; color:#021125 !important; }
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="brand">ESIP ‚Ä¢ Leitor</div>
    <div class="small">Leitura apenas de QRs gerados pelo sistema</div>
  </div>

  <!-- LOGIN -->
  <div class="card" id="loginCard">
    <h3>Login</h3>
    <div class="row">
      <input id="loginUser" class="left" placeholder="Usu√°rio (admin)">
      <input id="loginPass" placeholder="Senha" type="password">
      <button class="btn" id="btnLogin">Entrar</button>
    </div>
    <div class="small" style="margin-top:8px">Se nenhum usu√°rio existir, o primeiro ser√° criado como ADMIN ao fazer login.</div>
  </div>

  <!-- APP -->
  <div class="card" id="appCard" style="display:none;">
    <div class="row">
      <div style="flex:1">
        <h3>Scanner</h3>
        <div id="reader"></div>
        <div class="controls">
          <button class="btn" id="btnFlash">üî¶ Lanterna</button>
          <button class="btn" id="btnSwitch">üîÑ Trocar c√¢mera</button>
          <button class="btn" id="btnExport">üíæ Exportar CSV</button>
          <button class="btn ghost" id="btnClear">üóë Limpar</button>
          <button class="btn ghost" id="btnLogout">‚èèÔ∏è Logout</button>
        </div>
      </div>

      <div style="width:320px;margin-left:8px">
        <div id="status" class="info">Aguardando leitura...</div>

        <div class="counters">
          <div class="counter"><div class="small">V√°lidos</div><div id="cntValid">0</div></div>
          <div class="counter"><div class="small">Inv√°lidos</div><div id="cntInvalid">0</div></div>
          <div class="counter"><div class="small">Usados</div><div id="cntUsed">0</div></div>
        </div>

        <h4 style="margin-top:12px">√öltimos registros</h4>
        <div id="logBox"></div>
      </div>
    </div>
  </div>

  <footer>Offline ‚Ä¢ Dados salvos localmente no navegador</footer>
</div>

<script>
/* ---------- Config / Estado ---------- */
const COOLDOWN_MS = 1200;
const ID_REGEX = /^ID\d+$/;
const LOCAL_KEYS = { INGRESSOS: 'ingressos', USED: 'usedCodes', LOG: 'logESIP', USERS: 'usuarios' };

let qrScanner = null;
let cameras = [];
let currentCameraIndex = 0;
let currentVideoTrack = null;
let flashOn = false;
let lastScannedAt = 0;
let used = new Set();
let logs = [];

/* load/save */
function loadState(){
  try { used = new Set(JSON.parse(localStorage.getItem(LOCAL_KEYS.USED) || '[]')); } catch(e){ used = new Set(); }
  try { logs = JSON.parse(localStorage.getItem(LOCAL_KEYS.LOG) || '[]'); if(!Array.isArray(logs)) logs = []; } catch(e){ logs = []; }
}
function saveState(){
  try { localStorage.setItem(LOCAL_KEYS.USED, JSON.stringify([...used])); } catch(e){}
  try { localStorage.setItem(LOCAL_KEYS.LOG, JSON.stringify(logs)); } catch(e){}
}

/* UI helpers */
function showStatus(text, type){ const el = document.getElementById('status'); el.textContent = text; el.className = 'info ' + (type===1? 'ok' : type===-1? 'err' : ''); }
function updateCounters(){ document.getElementById('cntValid').textContent = logs.filter(l=>l.status==='VALIDO').length; document.getElementById('cntInvalid').textContent = logs.filter(l=>l.status==='INVALIDO').length; document.getElementById('cntUsed').textContent = logs.filter(l=>l.status==='USADO').length; }
function renderLog(){ const box = document.getElementById('logBox'); box.innerHTML = logs.slice().reverse().slice(0,200).map(l=>`<div style="padding:6px;border-bottom:1px solid rgba(255,255,255,0.02)"><strong>${l.status}</strong> ‚Äî ${l.id} ‚Äî ${new Date(l.t).toLocaleString()}</div>`).join(''); }

/* find ingresso */
function findIngresso(id){ try { const arr = JSON.parse(localStorage.getItem(LOCAL_KEYS.INGRESSOS) || '[]'); if(!Array.isArray(arr)) return null; return arr.find(x=>x.id===id) || null; } catch(e){ return null; } }

/* push log */
function pushLog(id, status){ logs.push({ id, status, t: Date.now() }); if(logs.length>5000) logs.shift(); saveState(); updateCounters(); renderLog(); }

/* validate format */
function validFormat(id){ return ID_REGEX.test(id); }

/* onDecoded */
function onDecoded(text){
  const now = Date.now();
  if(now - lastScannedAt < COOLDOWN_MS) return;
  lastScannedAt = now;
  const id = String(text).trim();

  if(!validFormat(id)){
    pushLog(id, 'INVALIDO');
    navigator.vibrate?.([120,30,120]);
    showStatus('QR inv√°lido', -1);
    return;
  }
  const ingresso = findIngresso(id);
  if(!ingresso){
    pushLog(id, 'INVALIDO');
    navigator.vibrate?.(200);
    showStatus('Ingresso n√£o encontrado', -1);
    return;
  }
  if(used.has(id)){
    pushLog(id, 'USADO');
    navigator.vibrate?.(80);
    showStatus('Ingresso j√° utilizado', -1);
    return;
  }
  used.add(id);
  pushLog(id, 'VALIDO');
  navigator.vibrate?.([40,20,40]);
  showStatus(`V√°lido ‚Äî ${ingresso.nomeEvento || ingresso.evento || ''}`, 1);
}

/* ---------- Scanner control ---------- */
async function startScanner(cameraId=null){
  if(qrScanner){
    try{ await qrScanner.stop(); }catch(e){}
    qrScanner = null;
    currentVideoTrack = null;
  }

  try{
    cameras = await Html5Qrcode.getCameras();
  } catch(e){ alert('Erro ao listar c√¢meras: '+(e.message||e)); return; }

  if(!cameras || !cameras.length){ alert('Nenhuma c√¢mera dispon√≠vel'); return; }

  let chosen;
  if(cameraId){ chosen = cameras.find(c=>c.id===cameraId) || cameras[0]; }
  else { chosen = cameras.find(c => (c.label && /back|rear|environment|traseira/i.test(c.label))) || cameras[0]; }
  currentCameraIndex = cameras.findIndex(c=>c.id===chosen.id);

  qrScanner = new Html5Qrcode("reader");

  try {
    await qrScanner.start(
      { deviceId: { exact: chosen.id } },
      { fps: 10, qrbox: { width: 300, height: 300 } },
      onDecoded,
      errorMessage => { /* ignore individual decode errors */ }
    );
  } catch(err){
    alert('Erro ao iniciar scanner: ' + (err && err.message ? err.message : err));
    return;
  }

  // wait-for-video: tenta obter o track at√© estar dispon√≠vel (sem timeout visual)
  waitForVideoTrack();
}

/* tenta obter o track repetidamente at√© achar (r√°pido) */
function waitForVideoTrack(attempt=0){
  const video = document.querySelector('#reader video');
  if(video && video.srcObject && video.srcObject.getVideoTracks().length){
    currentVideoTrack = video.srcObject.getVideoTracks()[0];
    // opcional: atualiza o bot√£o de flash se torch estiver dispon√≠vel
    try {
      const caps = currentVideoTrack.getCapabilities?.();
      const btn = document.getElementById('btnFlash');
      if(caps && caps.torch) btn.disabled = false; else btn.disabled = true;
    } catch(e){}
    return;
  }
  // tentar novamente, at√© N tentativas
  if(attempt < 30) { // 30 * 100ms = 3s max retries
    setTimeout(()=> waitForVideoTrack(attempt+1), 100);
  } else {
    // n√£o encontrou em 3s -> deixar bot√£o ativo mas avisar ao tentar ligar
    currentVideoTrack = null;
  }
}

async function switchCamera(){
  if(!cameras || !cameras.length){
    try{ cameras = await Html5Qrcode.getCameras(); }catch(e){}
    if(!cameras || !cameras.length) return alert('Nenhuma c√¢mera dispon√≠vel');
  }
  currentCameraIndex = (currentCameraIndex + 1) % cameras.length;
  const cam = cameras[currentCameraIndex];
  await startScanner(cam.id);
}

/* ---------- Lanterna com retry inteligente ---------- */
async function toggleFlash(){
  // checa imediatamente
  let track = currentVideoTrack;
  if(!track){
    // tenta algumas vezes r√°pidas para n√£o exigir waiting do operador
    for(let i=0;i<5;i++){
      await new Promise(r=>setTimeout(r, 120)); // 120ms
      track = document.querySelector('#reader video')?.srcObject?.getVideoTracks?.()[0];
      if(track) break;
    }
    // se ainda n√£o tem track, tenta mais uma sequ√™ncia lenta
    if(!track){
      for(let i=0;i<10;i++){
        await new Promise(r=>setTimeout(r, 150)); // mais 1.5s total max
        track = document.querySelector('#reader video')?.srcObject?.getVideoTracks?.()[0];
        if(track) break;
      }
    }
  }

  if(!track){
    // falha silenciosa ‚Äî n√£o mostrar alerta forte, s√≥ feedback leve
    console.warn('toggleFlash: track not ready');
    // opcional: breve mensagem no status
    showStatus('Lanterna: c√¢mera ainda inicializando...', 0);
    return;
  }

  const caps = track.getCapabilities?.();
  if(!caps || !caps.torch){
    alert('Lanterna n√£o suportada nesta c√¢mera.');
    return;
  }

  flashOn = !flashOn;
  try{
    await track.applyConstraints({ advanced: [{ torch: flashOn }] });
    document.getElementById('btnFlash').classList.toggle('flash-on', flashOn);
    document.getElementById('btnFlash').innerText = flashOn ? 'üî¶ Desligar' : 'üî¶ Lanterna';
  }catch(e){
    // fallback: tentar obter novo stream e aplicar (alguns dispositivos exigem)
    try{
      const settings = track.getSettings?.();
      const deviceId = settings && settings.deviceId ? settings.deviceId : null;
      if(deviceId){
        const stream = await navigator.mediaDevices.getUserMedia({ video: { deviceId: { exact: deviceId } }});
        const t2 = stream.getVideoTracks()[0];
        if(t2 && t2.getCapabilities && t2.getCapabilities().torch){
          await t2.applyConstraints({ advanced: [{ torch: flashOn }] });
          t2.stop();
          document.getElementById('btnFlash').classList.toggle('flash-on', flashOn);
          document.getElementById('btnFlash').innerText = flashOn ? 'üî¶ Desligar' : 'üî¶ Lanterna';
          return;
        }
      }
    }catch(_){}
    flashOn = false;
    alert('Falha ao acionar lanterna');
  }
}

/* ---------- Export / Clear ---------- */
function exportCSV(){
  if(!logs || !logs.length){ alert('Sem registros.'); return; }
  let csv = 'id,status,data\n';
  logs.forEach(l => csv += `${l.id},${l.status},"${new Date(l.t).toLocaleString()}"\n`);
  const blob = new Blob([csv], { type: 'text/csv' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'log_leitor.csv';
  a.click();
}

function clearAll(){
  if(!confirm('Limpar registros e usados?')) return;
  logs = [];
  used = new Set();
  saveState();
  updateCounters();
  renderLog();
  showStatus('Logs limpos', 0);
}

/* ---------- Login simple ---------- */
function getUsers(){ try { const u = JSON.parse(localStorage.getItem(LOCAL_KEYS.USERS) || '[]'); return Array.isArray(u) ? u : []; } catch(e){ return []; } }
function saveUsers(arr){ try{ localStorage.setItem(LOCAL_KEYS.USERS, JSON.stringify(arr)); } catch(e){} }

function doLogin(){
  const user = (document.getElementById('loginUser').value || '').trim();
  const pass = (document.getElementById('loginPass').value || '').trim();
  if(!user || !pass){ alert('Preencha usu√°rio e senha'); return; }
  let users = getUsers();
  if(!users.length){ users = [{ user, pass, nivel: 'ADMIN' }]; saveUsers(users); }
  const found = users.find(x=>x.user===user && x.pass===pass);
  if(!found){ alert('Usu√°rio ou senha incorretos'); return; }
  document.getElementById('loginCard').style.display = 'none';
  document.getElementById('appCard').style.display = 'block';
  loadState();
  updateCounters();
  renderLog();
  startScanner();
}

/* ---------- startup ---------- */
document.getElementById('btnLogin').addEventListener('click', doLogin);
document.getElementById('loginPass').addEventListener('keydown', e=>{ if(e.key==='Enter') doLogin(); });
document.getElementById('loginUser').addEventListener('keydown', e=>{ if(e.key==='Enter') doLogin(); });

document.getElementById('btnLogout').addEventListener('click', ()=> location.reload());
document.getElementById('btnSwitch').addEventListener('click', switchCamera);
document.getElementById('btnFlash').addEventListener('click', toggleFlash);
document.getElementById('btnExport').addEventListener('click', exportCSV);
document.getElementById('btnClear').addEventListener('click', clearAll);

loadState();
updateCounters();
renderLog();
showStatus('Informe suas credenciais para iniciar', 0);
</script>
</body>
</html>

